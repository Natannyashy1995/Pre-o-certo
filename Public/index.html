<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0D0D0D">
<title>PreÃ§oCerto â€” PiatÃ£ BA</title>
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;PreÃ§oCerto&quot;,&quot;short_name&quot;:&quot;PreÃ§oCerto&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230D0D0D&quot;,&quot;theme_color&quot;:&quot;%230D0D0D&quot;}">
<!-- Fonte carregada de forma nÃ£o-bloqueante para iOS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREÃ‡OCERTO v8 â€” Tema Azul/Verde (Ref Design)
   Fontes: Nunito (tÃ­tulos) + Open Sans (corpo)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --font-title:'Nunito',-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif;
  --font-body:'Open Sans',-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif;

  /* Paleta principal */
  --azul-esc:#0B4F8A;
  --azul:#1A73C8;
  --azul-claro:#2E9EE8;
  --verde:#1DB954;
  --verde-dk:#18A349;
  --amarelo:#F59E0B;
  --vermelho:#DC2626;
  --roxo:#7C3AED;

  /* SuperfÃ­cies (tema claro) */
  --bg:#EFF5FB;
  --card:#FFFFFF;
  --card2:#F0F6FF;
  --texto:#1A2D42;
  --muted:#6B8CAE;
  --borda:#C8DDF0;
  --borda2:#A8C4E0;

  /* Gradientes */
  --grad-azul:linear-gradient(145deg,#0B4F8A 0%,#1A73C8 50%,#2E9EE8 100%);
  --grad-azul-verde:linear-gradient(145deg,#0B4F8A 0%,#1A73C8 40%,#1DB954 100%);
  --grad-verde:linear-gradient(135deg,#1DB954,#18A349);

  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
}

/* Atualiza fontes */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;-webkit-text-size-adjust:100%;}
body{font-family:var(--font-body);background:var(--bg);color:var(--texto);min-height:100vh;min-height:-webkit-fill-available;overflow-x:hidden;-webkit-font-smoothing:antialiased;}
.screen{display:none;min-height:100vh;min-height:-webkit-fill-available;flex-direction:column;}
.screen.active{display:flex;}

/* â”€â”€ BOTÃ•ES â”€â”€ */
.btn-primary{background:var(--grad-verde);color:#fff;font-family:var(--font-title);font-weight:800;font-size:15px;border:none;border-radius:10px;padding:16px 32px;cursor:pointer;width:100%;transition:all .2s;-webkit-appearance:none;touch-action:manipulation;box-shadow:0 4px 16px rgba(29,185,84,.35);letter-spacing:.2px;}
.btn-primary:active{transform:scale(.97);opacity:.9;}
.btn-secondary{background:#fff;color:var(--azul-esc);border:2px solid var(--borda2);border-radius:10px;padding:14px 32px;cursor:pointer;width:100%;margin-top:10px;font-size:14px;font-weight:700;transition:all .2s;-webkit-appearance:none;touch-action:manipulation;font-family:var(--font-title);}
.btn-secondary:active{background:var(--card2);}
.btn-azul{background:var(--azul);color:#fff;font-family:var(--font-title);font-weight:800;font-size:15px;border:none;border-radius:10px;padding:16px 32px;cursor:pointer;width:100%;transition:all .2s;-webkit-appearance:none;touch-action:manipulation;box-shadow:0 4px 16px rgba(26,115,200,.35);}
.btn-azul:active{transform:scale(.97);opacity:.9;}
.btn-sm{padding:8px 14px;font-size:12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;transition:all .2s;-webkit-appearance:none;touch-action:manipulation;font-family:var(--font-title);}
.btn-verde{background:var(--verde);color:#fff;box-shadow:0 2px 8px rgba(29,185,84,.3);}
.btn-outline{background:transparent;border:1.5px solid var(--borda2);color:var(--texto);}
.btn-amarelo{background:var(--amarelo);color:#fff;}
.btn-danger{background:transparent;border:1.5px solid var(--vermelho);color:var(--vermelho);}

/* â”€â”€ TOP BAR (telas internas) â”€â”€ */
.top-bar{padding:calc(48px + var(--safe-top)) 16px 14px;display:flex;align-items:center;gap:12px;background:var(--grad-azul);color:#fff;}
.back-btn{width:38px;height:38px;background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.35);border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;-webkit-appearance:none;color:#fff;}
.top-bar-title{font-family:var(--font-title);font-size:17px;font-weight:800;flex:1;color:#fff;}

/* â”€â”€ NAV â”€â”€ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.96);-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px);border-top:1.5px solid var(--borda);padding:8px 0 calc(10px + var(--safe-bottom));display:none;justify-content:space-around;z-index:100;box-shadow:0 -2px 16px rgba(11,79,138,.1);}
.bottom-nav.show{display:flex;}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:4px 10px;border-radius:10px;-webkit-user-select:none;user-select:none;}
.nav-icon{font-size:20px;}
.nav-label{font-size:10px;color:var(--muted);font-weight:600;}
.nav-item.ativo .nav-label{color:var(--azul);}
.nav-item.ativo .nav-icon{transform:scale(1.12);}
.nav-badge{background:var(--vermelho);color:#fff;font-size:9px;font-weight:700;min-width:15px;height:15px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;padding:0 3px;position:absolute;top:-3px;right:-3px;}
.nav-icon-wrap{position:relative;display:inline-block;}
.pb-nav{padding-bottom:calc(88px + var(--safe-bottom));}

/* â”€â”€ INPUTS â”€â”€ */
.field-label{font-size:11px;color:var(--muted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;}
.input-field{background:#fff;border:1.5px solid var(--borda);border-radius:10px;padding:12px 14px;color:var(--texto);font-family:var(--font-body);font-size:16px;width:100%;outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;appearance:none;}
.input-field:focus{border-color:var(--azul);box-shadow:0 0 0 3px rgba(26,115,200,.15);}
.input-field option{background:#fff;color:var(--texto);}
.textarea-field{resize:vertical;min-height:80px;line-height:1.5;}

/* Input com Ã­cone estilo referÃªncia */
.field-icon-wrap{position:relative;}
.field-icon-wrap .fi{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--muted);pointer-events:none;}
.field-icon-wrap .input-field{padding-left:36px;}

/* â”€â”€ AUTOCOMPLETE â”€â”€ */
.ac-wrap{position:relative;}
.ac-list{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--borda);border-radius:10px;z-index:9000;max-height:230px;overflow-y:auto;box-shadow:0 8px 28px rgba(11,79,138,.15);display:none;}
.ac-list.show{display:block;animation:fadeIn .15s ease;}
.ac-item{padding:11px 13px;display:flex;align-items:center;gap:10px;cursor:pointer;border-bottom:1px solid #EEF4FB;transition:background .12s;font-size:14px;color:var(--texto);}
.ac-item:last-child{border-bottom:none;}
.ac-item:hover,.ac-item.focused{background:var(--card2);}
.ac-emoji{font-size:20px;flex-shrink:0;width:28px;text-align:center;}
.ac-right{flex:1;min-width:0;}
.ac-nome{font-weight:700;font-size:13px;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ac-cat{font-size:11px;color:var(--muted);margin-top:1px;}
.ac-nome mark{background:#FEF08A;border-radius:3px;padding:0 1px;font-style:normal;color:var(--texto);}

/* â”€â”€ FEEDBACK â”€â”€ */
.feedback-bar{display:none;border-radius:10px;padding:12px 16px;font-size:14px;font-weight:700;text-align:center;margin:0 16px;}
.feedback-bar.show{display:block;animation:fadeIn .3s ease;}
.feedback-bar.ok{background:#DCFCE7;border:1.5px solid rgba(29,185,84,.3);color:var(--verde-dk);}
.feedback-bar.erro{background:#FEE2E2;border:1.5px solid rgba(220,38,38,.25);color:var(--vermelho);}
.feedback-bar.info{background:#DBEAFE;border:1.5px solid rgba(26,115,200,.25);color:var(--azul);}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes floatIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
@keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}

/* â”€â”€ FRESHNESS â”€â”€ */
.freshness{display:inline-flex;align-items:center;gap:5px;font-size:11px;padding:3px 8px;border-radius:100px;font-weight:700;}
.freshness.fresh{background:#DCFCE7;color:#16A34A;}
.freshness.medium{background:#FEF9C3;color:#B45309;}
.freshness.old{background:#FEE2E2;color:var(--vermelho);}
.freshness::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;}

/* â”€â”€ FONTE BADGE â”€â”€ */
.fonte-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:2px 8px;border-radius:100px;font-weight:700;}
.fonte-admin{background:#DBEAFE;color:var(--azul);}
.fonte-mercado{background:#EDE9FE;color:var(--roxo);}
.fonte-cliente{background:#FEF9C3;color:#92400E;}
.fonte-aprovado{background:#DCFCE7;color:#16A34A;}
.fonte-app{background:linear-gradient(90deg,#0B4F8A,#1DB954);color:#fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â• */
#login{background:var(--grad-azul-verde);justify-content:center;align-items:center;padding:calc(24px + var(--safe-top)) 20px calc(24px + var(--safe-bottom));overflow-y:auto;}
.login-box{width:100%;max-width:380px;display:flex;flex-direction:column;gap:14px;}

/* Logo topo (fundo azul) */
.logo-branca{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:2px;}
.logo-branca .lb-icon{width:50px;height:50px;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.45);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;}
.logo-branca .lb-nome{font-family:var(--font-title);font-weight:900;font-size:28px;color:#fff;letter-spacing:-.5px;}
.logo-branca .lb-sub{font-size:12px;color:rgba(255,255,255,.75);margin-top:1px;font-weight:600;}

/* Card branco flutuante â€” igual ao mockup */
.login-card{background:#fff;border-radius:18px;padding:26px 22px;box-shadow:0 16px 48px rgba(0,0,0,.2);display:flex;flex-direction:column;gap:0;}
.lc-title{font-family:var(--font-title);font-size:21px;font-weight:900;color:var(--azul-esc);text-align:center;margin-bottom:3px;}
.lc-sub{font-size:13px;color:var(--muted);text-align:center;margin-bottom:18px;font-weight:500;}
.lc-fields{display:flex;flex-direction:column;gap:11px;}

/* Campos com Ã­cone â€” igual ao mockup */
.lf{position:relative;}
.lf .lf-ic{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:15px;color:var(--muted);pointer-events:none;}
.lf input{background:#F7FAFF;border:1.5px solid var(--borda);border-radius:9px;padding:13px 13px 13px 38px;color:var(--texto);font-size:16px;width:100%;outline:none;-webkit-appearance:none;transition:border-color .2s,box-shadow .2s;font-family:var(--font-body);}
.lf input::placeholder{color:var(--muted);}
.lf input:focus{border-color:var(--azul);box-shadow:0 0 0 3px rgba(26,115,200,.12);}

.login-erro{color:var(--vermelho);font-size:13px;text-align:center;display:none;font-weight:700;margin-top:4px;}
.login-erro.show{display:block;}
.login-link{font-size:13px;color:var(--azul);text-align:center;cursor:pointer;margin-top:6px;font-weight:700;}
.login-divider{display:flex;align-items:center;gap:10px;margin:4px 0;font-size:12px;color:var(--muted);font-weight:600;}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--borda);}
.login-admin-link{font-size:12px;color:var(--muted);text-align:center;cursor:pointer;letter-spacing:1px;margin-top:2px;}
.login-admin-link:hover{color:var(--azul);}

/* Manter compatibilidade com classes existentes */
.logo-mark{background:var(--verde);border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:var(--font-title);font-weight:900;color:#fff;}
.logo-text{font-family:var(--font-title);font-weight:800;color:#fff;}
.logo-text span{color:#7FEBA1;}
.login-tabs{display:flex;gap:8px;margin-bottom:4px;}
.login-tab{flex:1;padding:11px;background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);border-radius:10px;text-align:center;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;color:rgba(255,255,255,.8);}
.login-tab.ativo{background:#fff;color:var(--azul-esc);border-color:#fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â•â• */
#home{background:var(--grad-azul-verde);justify-content:space-between;}
.home-header{padding:calc(50px + var(--safe-top)) 20px 0;display:flex;align-items:center;gap:10px;}
.admin-tag{background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.4);border-radius:100px;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;color:#fff;}
.user-avatar-btn{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.5);cursor:pointer;overflow:hidden;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.home-hero{flex:1;display:flex;flex-direction:column;justify-content:center;padding:20px 20px 16px;}
.hero-tag{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:100px;padding:6px 13px;font-size:12px;color:#fff;font-weight:700;margin-bottom:18px;width:fit-content;}
.hero-tag::before{content:'';width:6px;height:6px;background:#7FEBA1;border-radius:50%;animation:pulse 2s infinite;}
.hero-title{font-family:var(--font-title);font-size:34px;font-weight:900;color:#fff;line-height:1.1;margin-bottom:10px;}
.destaque{color:#FFE566;}
.hero-subtitle{font-size:14px;color:rgba(255,255,255,.82);line-height:1.6;margin-bottom:22px;max-width:310px;}
.hero-stats{display:flex;gap:10px;margin-bottom:22px;}
.stat{background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.22);border-radius:13px;padding:11px 13px;flex:1;text-align:center;}
.stat-num{font-family:var(--font-title);font-size:22px;font-weight:900;color:#fff;display:block;}
.stat-label{font-size:10px;color:rgba(255,255,255,.7);font-weight:700;display:block;margin-top:1px;}
.promo-home{padding:0 0 14px;}
.promo-home-title{font-family:var(--font-title);font-size:16px;font-weight:900;color:#fff;padding:0 16px;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.promo-scroll{display:flex;flex-direction:column;gap:10px;padding:0 16px;scrollbar-width:none;}
.promo-scroll::-webkit-scrollbar{display:none;}
/* Card de promoÃ§Ã£o â€” BRANCO com bordas para destacar do fundo verde */
.promo-home-card{background:#fff;border-radius:16px;padding:14px 15px;cursor:pointer;box-shadow:0 4px 18px rgba(0,0,0,.18);display:flex;align-items:center;gap:14px;border-left:5px solid #E85D04;transition:transform .15s;}
.promo-home-card:active{transform:scale(.98);}
.promo-home-emoji{font-size:34px;flex-shrink:0;}
.promo-home-info{flex:1;min-width:0;}
.promo-home-nome{font-size:13px;font-weight:800;color:var(--texto);font-family:var(--font-title);line-height:1.3;margin-bottom:5px;}
.promo-home-precos{display:flex;align-items:baseline;gap:8px;margin-bottom:4px;}
.promo-home-de{font-size:13px;color:#999;text-decoration:line-through;font-weight:500;}
.promo-home-por{font-family:var(--font-title);font-size:22px;font-weight:900;color:#E85D04;}
.promo-home-pct{background:#FEE2E2;color:#DC2626;font-size:10px;font-weight:800;padding:2px 7px;border-radius:100px;font-family:var(--font-title);}
.promo-home-meta{font-size:11px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;}
.promo-home-meta span{display:flex;align-items:center;gap:3px;}
.floating-preview{padding:4px 16px 22px;display:flex;flex-direction:column;gap:9px;}
.preview-card{background:#fff;border-radius:13px;padding:13px 14px;display:flex;align-items:center;gap:12px;box-shadow:0 3px 14px rgba(0,0,0,.14);cursor:pointer;}
.preview-info{flex:1;min-width:0;}
.preview-name{font-size:13px;font-weight:700;color:var(--texto);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:var(--font-title);}
.preview-mercado{font-size:11px;color:var(--muted);margin-top:2px;}
.badge-menor{background:#DCFCE7;color:#16A34A;font-size:10px;font-weight:800;padding:2px 8px;border-radius:100px;font-family:var(--font-title);}

/* â•â•â•â•â•â•â•â•â•â•â•â• BUSCA â•â•â•â•â•â•â•â•â•â•â•â• */
#busca{background:var(--bg);}
.busca-header{background:var(--grad-azul);padding:calc(50px + var(--safe-top)) 16px 16px;}
.busca-header-title{font-family:var(--font-title);font-size:19px;font-weight:900;color:#fff;margin-bottom:12px;}
.search-row{display:flex;gap:10px;}
.search-box{flex:1;display:flex;align-items:center;gap:8px;background:#fff;border-radius:11px;padding:0 13px;box-shadow:0 2px 8px rgba(0,0,0,.12);}
.search-box input{border:none;outline:none;flex:1;font-size:16px;color:var(--texto);background:transparent;padding:13px 0;font-family:var(--font-body);}
.search-box input::placeholder{color:var(--muted);}
.filter-btn{width:48px;height:48px;background:#fff;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12);flex-shrink:0;}
.bairro-dd{padding:0 16px 10px;display:none;}
.bairro-dd.show{display:block;}
.chip-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.chip{background:#fff;border:1.5px solid var(--borda);border-radius:100px;padding:7px 14px;font-size:12px;cursor:pointer;font-weight:700;color:var(--muted);transition:all .2s;}
.chip.ativo{background:var(--azul);border-color:var(--azul);color:#fff;}
.categorias{display:flex;gap:8px;padding:12px 16px 10px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.categorias::-webkit-scrollbar{display:none;}
.cat-btn{flex-shrink:0;background:#fff;border:1.5px solid var(--borda);border-radius:100px;padding:8px 16px;font-size:12px;font-weight:700;cursor:pointer;color:var(--muted);transition:all .2s;white-space:nowrap;}
.cat-btn.ativo{background:var(--azul);border-color:var(--azul);color:#fff;}
.section-label{padding:2px 16px 8px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;}
.produtos-lista{display:flex;flex-direction:column;gap:9px;padding:0 16px;}

/* Card produto â€” branco com sombra suave (igual aos cards da ref) */
.produto-card{background:#fff;border:1.5px solid var(--borda);border-radius:14px;padding:13px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .18s;box-shadow:0 2px 8px rgba(11,79,138,.06);position:relative;overflow:hidden;}
.produto-card:active{transform:scale(.985);background:var(--card2);}
.prod-emoji{font-size:28px;flex-shrink:0;}
.prod-info{flex:1;min-width:0;}
.prod-nome{font-size:14px;font-weight:700;color:var(--texto);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.prod-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.prod-freshness{margin-top:4px;}
.prod-preco-min{text-align:right;flex-shrink:0;}
.preco-de{font-size:11px;color:var(--muted);text-decoration:line-through;display:block;}
.preco-min{font-family:var(--font-title);font-size:18px;font-weight:900;color:var(--azul-esc);}
.add-lista-btn{width:32px;height:32px;border-radius:9px;border:none;background:var(--azul);color:#fff;font-size:18px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;box-shadow:0 2px 6px rgba(26,115,200,.35);}
.add-lista-btn.adicionado{background:var(--verde);}
.promo-badge-prod{position:absolute;top:9px;right:9px;background:var(--amarelo);color:#fff;font-size:9px;font-weight:800;padding:3px 7px;border-radius:6px;font-family:var(--font-title);}
.old-badge-prod{position:absolute;top:9px;right:9px;background:#FEE2E2;color:var(--vermelho);font-size:9px;font-weight:800;padding:3px 7px;border-radius:6px;}

/* â•â•â•â•â•â•â•â•â•â•â•â• DETALHE â•â•â•â•â•â•â•â•â•â•â•â• */
#detalhe{background:var(--bg);}
.detalhe-hero{background:var(--grad-azul);padding:calc(52px + var(--safe-top)) 20px 22px;position:relative;}
.detalhe-back{position:absolute;top:calc(12px + var(--safe-top));left:14px;background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.35);border-radius:10px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;color:#fff;-webkit-appearance:none;}
.detalhe-emoji-g{font-size:56px;display:block;margin-bottom:6px;}
.detalhe-nome{font-family:var(--font-title);font-size:23px;font-weight:900;color:#fff;}
.detalhe-cat{font-size:13px;color:rgba(255,255,255,.75);margin-top:3px;}
.detalhe-body{padding:14px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:11px;}

/* Card de preÃ§o por mercado */
.mercado-preco-card{background:#fff;border:1.5px solid var(--borda);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(11,79,138,.06);}
.mp-cabecalho{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.mp-icone{font-size:22px;}
.mp-nome{font-family:var(--font-title);font-size:15px;font-weight:800;color:var(--texto);}
.mp-bairro{font-size:11px;color:var(--muted);}
.mp-preco-valor{font-family:var(--font-title);font-size:26px;font-weight:900;color:var(--azul-esc);}
.mp-preco-de{font-size:12px;color:var(--muted);text-decoration:line-through;}
.mp-badge-melhor{background:#DCFCE7;color:#16A34A;font-size:11px;font-weight:700;padding:3px 9px;border-radius:100px;margin-left:8px;}
.hist-titulo{font-family:var(--font-title);font-size:14px;font-weight:800;color:var(--texto);margin-bottom:10px;}
.hist-bars{display:flex;align-items:flex-end;gap:6px;height:70px;}
.hist-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.hist-bar{width:100%;background:var(--azul);border-radius:5px 5px 0 0;min-height:6px;}
.hist-label{font-size:9px;color:var(--muted);font-weight:600;}

/* Mercado-item: card branco com bordas e separadores */
.mercado-item{background:#fff;border:1.5px solid var(--borda);border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(11,79,138,.06);position:relative;overflow:hidden;}
.mercado-item.menor-preco{border-color:var(--verde);border-width:2px;}
.mercado-item.tem-promo{border-color:#FFD23F;border-width:2px;}
.melhor-badge{background:#DCFCE7;color:#16A34A;font-size:10px;font-weight:800;padding:3px 10px;border-radius:100px;display:inline-block;margin-bottom:8px;font-family:var(--font-title);}
.promo-tag-item{background:#FFF3CD;color:#B45309;font-size:10px;font-weight:800;padding:3px 10px;border-radius:100px;display:inline-block;margin-bottom:8px;font-family:var(--font-title);}
.mercado-topo{display:flex;align-items:flex-start;gap:10px;padding-bottom:10px;border-bottom:1px solid var(--borda);}
.mercado-icon{font-size:24px;flex-shrink:0;margin-top:2px;}
.m-nome{font-family:var(--font-title);font-size:15px;font-weight:800;color:var(--texto);}
.m-end{font-size:11px;color:var(--muted);margin-top:2px;}
.m-bairro{font-size:11px;color:var(--muted);}
.m-parceiro{font-size:10px;font-weight:700;color:var(--azul);margin-top:3px;}
.preco-row{display:flex;align-items:center;justify-content:space-between;padding-top:10px;}
.preco-de-risco{font-size:12px;color:#999;text-decoration:line-through;margin-bottom:2px;}
.preco-g{font-family:var(--font-title);font-size:22px;font-weight:900;color:var(--azul-esc);}
.preco-g.promo-ativa{color:#B45309;}
.barra-wrap{margin-top:10px;padding-top:10px;border-top:1px solid var(--borda);}
.barra-preco{height:8px;background:var(--grad-azul);border-radius:100px;min-width:12%;transition:width .4s;}

/* â•â•â•â•â•â•â•â•â•â•â•â• CONTRIBUIR â•â•â•â•â•â•â•â•â•â•â•â• */
#contribuir{background:var(--bg);}
.contrib-header{background:var(--grad-azul);padding:calc(50px + var(--safe-top)) 20px 22px;}
.contrib-titulo{font-family:var(--font-title);font-size:20px;font-weight:900;color:#fff;}
.contrib-sub{font-size:13px;color:rgba(255,255,255,.75);margin-top:4px;}
.contrib-tabs{display:flex;gap:8px;padding:14px 16px 0;}
.contrib-tab{flex:1;background:#fff;border:1.5px solid var(--borda);border-radius:10px;padding:10px 8px;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;text-align:center;color:var(--muted);font-family:var(--font-title);}
.contrib-tab.ativo{background:var(--amarelo);color:#fff;border-color:var(--amarelo);}
.contrib-body{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:13px;}

/* Upload */
.upload-area{border:2px dashed var(--borda);border-radius:14px;padding:30px;display:flex;flex-direction:column;align-items:center;gap:12px;cursor:pointer;transition:all .2s;text-align:center;background:#fff;}
.upload-area:hover,.upload-area.drag{border-color:var(--azul);background:var(--card2);}
.upload-area .upload-icon{font-size:38px;}
.upload-area p{font-size:13px;color:var(--muted);line-height:1.5;}
.upload-area strong{color:var(--verde);}
#fotoInput{display:none;}
.foto-preview{border-radius:13px;overflow:hidden;position:relative;display:none;}
.foto-preview img{width:100%;max-height:220px;object-fit:cover;}
.foto-preview-remover{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.65);border:none;border-radius:8px;padding:6px 10px;color:#fff;font-size:12px;cursor:pointer;}

/* AI box */
.ai-box{background:linear-gradient(135deg,#DBEAFE,#DCFCE7);border:1.5px solid var(--borda);border-radius:13px;padding:15px;display:none;}
.ai-box.show{display:flex;flex-direction:column;gap:10px;}
.ai-loading{display:flex;align-items:center;gap:10px;}
.spinner{width:20px;height:20px;border:2px solid rgba(26,115,200,.25);border-top-color:var(--azul);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;}
.ai-result{background:#fff;border-radius:9px;padding:12px;}
.ai-detected{font-size:13px;color:var(--texto);margin-bottom:8px;}
.ai-detected strong{color:var(--verde-dk);}

/* Contrib pendentes */
.contrib-card{background:#fff;border:1.5px solid var(--borda);border-radius:13px;overflow:hidden;box-shadow:0 2px 8px rgba(11,79,138,.06);}
.contrib-img{width:100%;max-height:180px;object-fit:cover;}
.contrib-body-card{padding:13px;}
.contrib-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.contrib-autor{font-size:12px;color:var(--muted);}
.contrib-actions{display:flex;gap:8px;margin-top:10px;}

/* â•â•â•â•â•â•â•â•â•â•â•â• LOGIN MERCADO â•â•â•â•â•â•â•â•â•â•â•â• */
#loginMercado{background:var(--grad-azul-verde);justify-content:center;align-items:center;padding:32px 20px;overflow-y:auto;}

/* â•â•â•â•â•â•â•â•â•â•â•â• PORTAL MERCADO â•â•â•â•â•â•â•â•â•â•â•â• */
#portalMercado{background:var(--bg);}
.portal-header{background:var(--grad-azul);padding:calc(50px + var(--safe-top)) 20px 22px;}
.portal-merc-nome{font-family:var(--font-title);font-size:20px;font-weight:900;margin-top:8px;color:#fff;}
.portal-plano{font-size:12px;color:rgba(255,255,255,.75);margin-top:3px;font-weight:600;}
.portal-tabs{display:flex;gap:6px;padding:12px 16px 0;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.portal-tabs::-webkit-scrollbar{display:none;}
.portal-tab{flex-shrink:0;background:#fff;border:1.5px solid var(--borda);border-radius:9px;padding:9px 14px;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;-webkit-appearance:none;touch-action:manipulation;color:var(--muted);font-family:var(--font-title);}
.portal-tab.ativo{background:var(--azul);color:#fff;border-color:var(--azul);}
.portal-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:14px 16px;display:flex;flex-direction:column;gap:11px;}

/* â•â•â•â•â•â•â•â•â•â•â•â• LISTA â•â•â•â•â•â•â•â•â•â•â•â• */
#lista{background:var(--bg);}
.lista-vazia{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:40px;}
.lista-vazia .emoji{font-size:52px;}
.lista-item{background:#fff;border:1.5px solid var(--borda);border-radius:13px;padding:13px 14px;display:flex;align-items:center;gap:11px;box-shadow:0 1px 6px rgba(11,79,138,.06);}
.lista-item.comprado{opacity:.5;}
.lista-item.comprado .li-nome{text-decoration:line-through;}
.li-check{width:26px;height:26px;border-radius:8px;border:2px solid var(--borda2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:all .2s;}
.li-check.checked{background:var(--verde);border-color:var(--verde);color:#fff;}
.li-info{flex:1;}
.li-nome{font-size:14px;font-weight:700;color:var(--texto);}
.li-mercado{font-size:11px;color:var(--verde-dk);margin-top:2px;font-weight:600;}
.li-preco{font-family:var(--font-title);font-weight:900;font-size:14px;color:var(--azul-esc);}
.li-remove{background:transparent;border:none;font-size:17px;cursor:pointer;color:var(--muted);padding:4px;}
.lista-footer{padding:13px 16px;background:#fff;border-top:1.5px solid var(--borda);margin-bottom:80px;box-shadow:0 -4px 16px rgba(11,79,138,.08);}
.lista-total{display:flex;justify-content:space-between;align-items:center;}
.total-label{font-size:13px;color:var(--muted);font-weight:600;}
.total-valor{font-family:var(--font-title);font-size:22px;font-weight:900;color:var(--azul-esc);}
.lista-acoes{display:flex;gap:8px;margin-top:10px;}
.btn-limpar{flex:1;background:transparent;border:1.5px solid var(--borda2);border-radius:10px;padding:11px;color:var(--muted);font-size:13px;font-weight:700;cursor:pointer;}
.btn-compartilhar{flex:1;background:var(--verde);border:none;border-radius:10px;padding:11px;color:#fff;font-family:var(--font-title);font-weight:800;font-size:13px;cursor:pointer;}

/* â•â•â•â•â•â•â•â•â•â•â•â• ADMIN â•â•â•â•â•â•â•â•â•â•â•â• */
#admin{background:var(--bg);}
.admin-top{background:var(--grad-azul);padding:calc(48px + var(--safe-top)) 16px 16px;display:flex;align-items:center;gap:12px;}
.admin-top-title{font-family:var(--font-title);font-size:19px;font-weight:900;color:#fff;flex:1;}
.admin-tabs{display:flex;padding:12px 16px 0;gap:6px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.admin-tabs::-webkit-scrollbar{display:none;}
.tab{flex-shrink:0;background:#fff;border:1.5px solid var(--borda);border-radius:9px;padding:8px 13px;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;-webkit-appearance:none;touch-action:manipulation;color:var(--muted);font-family:var(--font-title);}
.tab.ativo{background:var(--azul);color:#fff;border-color:var(--azul);}
.admin-form{padding:0 16px 24px;display:flex;flex-direction:column;gap:11px;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}

/* Cards dentro do admin (tabelas, listas) */
.admin-card{background:#fff;border:1.5px solid var(--borda);border-radius:13px;overflow:hidden;box-shadow:0 2px 8px rgba(11,79,138,.06);}
.admin-card-header{background:var(--azul);color:#fff;padding:10px 14px;font-family:var(--font-title);font-weight:800;font-size:14px;display:flex;align-items:center;gap:8px;}
.admin-table{width:100%;border-collapse:collapse;}
.admin-table th{background:#F0F6FF;color:var(--muted);font-size:11px;font-weight:700;text-transform:uppercase;padding:9px 12px;text-align:left;border-bottom:1.5px solid var(--borda);}
.admin-table td{padding:11px 12px;font-size:13px;border-bottom:1px solid #EEF4FB;color:var(--texto);}
.admin-table tr:last-child td{border-bottom:none;}
.admin-table tr:hover td{background:#F7FAFF;}

/* â•â•â•â•â•â•â•â•â•â•â•â• PLANOS â•â•â•â•â•â•â•â•â•â•â•â• */
#planos{background:var(--bg);}
#solicitar{background:var(--bg);}
.plano-card{background:#fff;border:1.5px solid var(--borda);border-radius:16px;padding:18px;box-shadow:0 2px 8px rgba(11,79,138,.06);}
.plano-card.destaque{border-color:var(--verde);border-width:2px;}
.plano-nome{font-family:var(--font-title);font-size:17px;font-weight:900;color:var(--texto);}
.plano-preco{font-family:var(--font-title);font-size:30px;font-weight:900;color:var(--azul-esc);margin:10px 0 2px;}
.plano-periodo{font-size:12px;color:var(--muted);font-weight:600;}
.plano-features{display:flex;flex-direction:column;gap:6px;margin:12px 0;}
.plano-feature{font-size:13px;display:flex;gap:7px;align-items:flex-start;color:var(--texto);}
.plano-btn{background:var(--grad-verde);color:#fff;font-family:var(--font-title);font-weight:800;font-size:14px;border:none;border-radius:10px;padding:13px;cursor:pointer;width:100%;transition:all .2s;box-shadow:0 3px 10px rgba(29,185,84,.3);}
.plano-btn.outline{background:transparent;border:2px solid var(--azul);color:var(--azul);box-shadow:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;top:calc(14px + var(--safe-top));left:14px;right:14px;z-index:9999;background:#fff;border:1.5px solid var(--borda);border-radius:13px;padding:13px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 30px rgba(11,79,138,.2);transform:translateY(-20px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
/* â•â•â• CHAT â•â•â• */
.chat-bubble{max-width:78%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.5;animation:floatIn .2s ease;}
.chat-bubble.user{background:var(--azul);color:#fff;border-bottom-right-radius:4px;align-self:flex-end;}
.chat-bubble.admin{background:#fff;color:var(--texto);border:1.5px solid var(--borda);border-bottom-left-radius:4px;align-self:flex-start;box-shadow:0 2px 8px rgba(0,0,0,.07);}
.chat-bubble.bot{background:linear-gradient(135deg,#F0F6FF,#E8F4FF);color:var(--azul-esc);border:1.5px solid rgba(26,115,200,.2);border-bottom-left-radius:4px;align-self:flex-start;}
.chat-meta{font-size:10px;color:var(--muted);margin-top:3px;}
.chat-meta.right{text-align:right;}
.chat-row{display:flex;flex-direction:column;}
.chat-row.right{align-items:flex-end;}
/* â•â•â• LOCATION BUTTON â•â•â• */
.btn-loc{display:inline-flex;align-items:center;gap:6px;background:#F0F6FF;border:1.5px solid rgba(26,115,200,.3);border-radius:100px;padding:6px 13px;font-size:12px;font-weight:700;color:var(--azul);cursor:pointer;margin-top:6px;transition:all .18s;}
.btn-loc:active{transform:scale(.97);}
.toast-icon{font-size:22px;flex-shrink:0;}
.toast-msg{flex:1;font-size:13px;font-weight:700;color:var(--texto);}

/* â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(11,79,138,.45);z-index:200;display:none;align-items:flex-end;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);}
.modal-overlay.show{display:flex;}
.modal-box{background:#fff;border-radius:22px 22px 0 0;padding:22px 18px calc(36px + var(--safe-bottom));width:100%;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;animation:slideUp .3s ease;box-shadow:0 -6px 28px rgba(11,79,138,.18);}
.modal-title{font-family:var(--font-title);font-size:18px;font-weight:900;margin-bottom:4px;color:var(--texto);}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:18px;}
.modal-close{float:right;background:var(--card2);border:none;border-radius:8px;padding:6px 12px;cursor:pointer;color:var(--muted);font-size:12px;-webkit-appearance:none;font-weight:700;}

/* â•â•â•â•â•â•â•â•â•â•â•â• PWA BANNER â•â•â•â•â•â•â•â•â•â•â•â• */
.pwa-banner{position:fixed;bottom:calc(70px + var(--safe-bottom));left:12px;right:12px;background:#fff;border:1.5px solid var(--borda);border-radius:14px;padding:14px 16px;display:none;align-items:center;gap:12px;z-index:99;box-shadow:0 4px 20px rgba(11,79,138,.2);}
.pwa-banner.show{display:flex;}

</style>
<!-- Leaflet Maps (gratuito, sem API key) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
#modalMapaPicker { display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.6); align-items:flex-end; }
#modalMapaPicker.show { display:flex; }
.mapa-picker-box { background:var(--card); border-radius:20px 20px 0 0; width:100%; max-height:92vh; display:flex; flex-direction:column; overflow:hidden; }
#leafletMap { flex:1; min-height:320px; width:100%; }
.mapa-picker-info { padding:14px 16px; display:flex; flex-direction:column; gap:10px; }
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon">âœ…</span>
  <span class="toast-msg" id="toastMsg"></span>
</div>

<!-- MODAL REPORT -->
<div class="modal-overlay" id="modalReport">
  <div class="modal-box">
    <button class="modal-close" onclick="fecharModal('modalReport')">âœ• fechar</button>
    <div class="modal-title">âš ï¸ Reportar preÃ§o incorreto</div>
    <div class="modal-sub">Ajude a comunidade mantendo as informaÃ§Ãµes corretas.</div>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div><div class="field-label">Produto / Mercado</div><div id="reportProdInfo" style="background:var(--card2);border-radius:10px;padding:12px;font-size:14px;"></div></div>
      <div><div class="field-label">O que estÃ¡ errado?</div>
        <select class="input-field" id="reportMotivo">
          <option value="preco_diferente">PreÃ§o estÃ¡ diferente na loja</option>
          <option value="produto_indisponivel">Produto nÃ£o estÃ¡ disponÃ­vel</option>
          <option value="mercado_fechado">Mercado estÃ¡ fechado</option>
          <option value="outro">Outro motivo</option>
        </select>
      </div>
      <div><div class="field-label">Detalhes (opcional)</div><textarea class="input-field textarea-field" id="reportDetalhes" placeholder="Ex: O preÃ§o real Ã© R$ 5,50..."></textarea></div>
      <button class="btn-primary" onclick="enviarReport()">ğŸ“¨ Enviar Report</button>
    </div>
  </div>
</div>

<!-- MODAL PERFIL -->
<div class="modal-overlay" id="modalPerfil" onclick="if(event.target===this)this.style.display='none'">
  <div class="modal-box">
    <button class="modal-close" onclick="document.getElementById('modalPerfil').style.display='none'">âœ• fechar</button>
    <div id="modalPerfilContent"></div>
  </div>
</div>

<!-- MODAL LOGIN MERCADO -->
<div class="modal-overlay" id="modalLoginMercado">
  <div class="modal-box">
    <button class="modal-close" onclick="fecharModal('modalLoginMercado')">âœ• fechar</button>
    <div class="modal-title">ğŸª Portal do Mercado</div>
    <div class="modal-sub">Acesse com suas credenciais de mercado parceiro.</div>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div><div class="field-label">UsuÃ¡rio do mercado</div><input type="text" class="input-field" id="mercLoginUser" placeholder="Ex: mercado_joao"></div>
      <div><div class="field-label">Senha</div><input type="password" class="input-field" id="mercLoginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')fazerLoginMercado()"></div>
      <div id="mercLoginErro" style="color:var(--vermelho);font-size:13px;display:none;">âš ï¸ Credenciais incorretas</div>
      <button class="btn-primary" onclick="fazerLoginMercado()">ğŸ” Entrar</button>
      <div style="font-size:12px;color:var(--muted);text-align:center;">NÃ£o tem acesso? <span style="color:var(--verde);cursor:pointer;" onclick="fecharModal('modalLoginMercado');irPara('planos')">Cadastre seu mercado</span></div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="screen active">
  <div class="login-box">

    <!-- Logo topo branca -->
    <div class="logo-branca">
      <div class="lb-icon">ğŸ”</div>
      <div>
        <div class="lb-nome">PreÃ§oCerto</div>
        <div class="lb-sub">PiatÃ£, Bahia</div>
      </div>
    </div>

    <!-- LOGIN CLIENTE -->
    <div id="loginClienteCard" class="login-card">
      <div class="lc-title">Bem-vindo! ğŸ‘‹</div>
      <div class="lc-sub">Entre na sua conta ou crie uma grÃ¡tis</div>

      <!-- LOGIN FORM -->
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">
        <div class="lf"><span class="lf-ic">ğŸ‘¤</span><input type="text" id="loginClienteUser" placeholder="Seu login" onkeydown="if(event.key==='Enter')fazerLoginCliente()"></div>
        <div class="lf"><span class="lf-ic">ğŸ”‘</span><input type="password" id="loginClienteSenha" placeholder="Sua senha" onkeydown="if(event.key==='Enter')fazerLoginCliente()"></div>
        <div class="login-erro" id="loginClienteErro">âš ï¸ Login ou senha incorretos</div>
        <button class="btn-azul" onclick="fazerLoginCliente()" style="font-size:15px;padding:14px;">ğŸ”‘ Entrar</button>
      </div>

      <div class="login-divider" style="margin:4px 0 10px;">nÃ£o tem conta?</div>

      <button onclick="irPara('cadastro')" style="background:var(--card2);border:1.5px solid var(--borda2);border-radius:10px;padding:13px;font-family:var(--font-title);font-weight:700;font-size:14px;color:var(--azul-esc);cursor:pointer;width:100%;display:flex;align-items:center;justify-content:center;gap:8px;">
        ğŸ›’ Criar Conta GrÃ¡tis
      </button>

      <button onclick="entrarSemCadastro()" style="display:none;">
      </button>

      <div class="login-divider" style="margin-top:8px;">acesso profissional</div>

      <div style="display:flex;flex-direction:column;gap:8px;margin-top:2px;">
        <button onclick="setLoginTab('mercado')" style="background:#F0F6FF;border:1.5px solid var(--borda2);border-radius:10px;padding:13px;font-family:var(--font-title);font-weight:700;font-size:14px;color:var(--azul-esc);cursor:pointer;width:100%;display:flex;align-items:center;justify-content:center;gap:8px;">
          ğŸª Entrar como Mercado
        </button>
        <button onclick="toggleAdminLogin()" style="background:transparent;border:none;color:var(--muted);font-size:11px;cursor:pointer;padding:6px;letter-spacing:1px;font-family:var(--font-body);">
          Â·Â·Â· admin
        </button>
      </div>

      <!-- Admin form (hidden) -->
      <div id="loginAdminForm" style="display:none;margin-top:10px;background:var(--card2);border:1.5px solid var(--borda);border-radius:12px;padding:14px;">
        <div style="font-size:12px;color:var(--muted);font-weight:700;text-align:center;margin-bottom:10px;letter-spacing:.5px;">ğŸ”’ ADMINISTRADOR</div>
        <div style="display:flex;flex-direction:column;gap:9px;">
          <div class="lf"><span class="lf-ic">ğŸ‘¤</span><input type="text" id="loginUser" placeholder="UsuÃ¡rio admin" onkeydown="if(event.key==='Enter')fazerLogin()"></div>
          <div class="lf"><span class="lf-ic">ğŸ”‘</span><input type="password" id="loginPass" placeholder="Senha" onkeydown="if(event.key==='Enter')fazerLogin()"></div>
          <div class="login-erro" id="loginErro">âš ï¸ UsuÃ¡rio ou senha incorretos</div>
          <button class="btn-azul" onclick="fazerLogin()" style="font-size:14px;padding:13px;">Entrar</button>
        </div>
      </div>

      <!-- Mercado form (hidden) -->
      <div id="loginMercadoForm" style="display:none;margin-top:10px;background:var(--card2);border:1.5px solid var(--borda);border-radius:12px;padding:14px;">
        <div style="font-size:12px;color:var(--muted);font-weight:700;text-align:center;margin-bottom:10px;letter-spacing:.5px;">ğŸª PORTAL DO MERCADO</div>
        <div style="display:flex;flex-direction:column;gap:9px;">
          <div class="lf"><span class="lf-ic">ğŸª</span><input type="text" id="loginMercUser" placeholder="UsuÃ¡rio do mercado" onkeydown="if(event.key==='Enter')fazerLoginMercadoDir()"></div>
          <div class="lf"><span class="lf-ic">ğŸ”‘</span><input type="password" id="loginMercPass" placeholder="Senha" onkeydown="if(event.key==='Enter')fazerLoginMercadoDir()"></div>
          <div class="login-erro" id="loginMercErro">âš ï¸ Credenciais incorretas</div>
          <button class="btn-azul" onclick="fazerLoginMercadoDir()" style="font-size:14px;padding:13px;">Entrar</button>
          <button onclick="setLoginTab('cliente')" style="background:transparent;border:1.5px solid var(--borda2);border-radius:9px;padding:10px;font-weight:700;font-size:13px;color:var(--muted);cursor:pointer;font-family:var(--font-title);">â† Voltar</button>
        </div>
      </div>
    </div>

    <!-- CADASTRO CARD (hidden by default, shown via irPara('cadastro')) -->
    <div id="cadastroCard" class="login-card" style="display:none;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <button onclick="irPara('login')" style="background:var(--card2);border:1.5px solid var(--borda);border-radius:9px;padding:8px 12px;font-size:13px;font-weight:700;cursor:pointer;color:var(--azul-esc);">â† Voltar</button>
        <div>
          <div class="lc-title" style="text-align:left;font-size:18px;">Criar Conta ğŸ›’</div>
          <div style="font-size:12px;color:var(--muted);">Gratuito para sempre</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:14px;">
        <div id="fotoPerfilPreview" onclick="document.getElementById('fotoPerfilInput').click()"
          style="width:70px;height:70px;border-radius:50%;background:var(--card2);border:2.5px solid var(--borda2);display:flex;align-items:center;justify-content:center;font-size:30px;cursor:pointer;overflow:hidden;position:relative;">
          <span id="fotoPerfilEmoji">ğŸ‘¤</span>
          <img id="fotoPerfilImg" src="" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;inset:0;">
          <div style="position:absolute;bottom:0;right:0;width:20px;height:20px;background:var(--azul);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;border:2px solid #fff;">ğŸ“·</div>
        </div>
        <input type="file" id="fotoPerfilInput" accept="image/*" style="display:none;" onchange="processarFotoPerfil(event)">
        <div style="font-size:11px;color:var(--muted);margin-top:5px;">Foto de perfil (opcional)</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">
        <div><div class="field-label">Nome completo *</div>
          <input type="text" class="input-field" id="cadastroNome" placeholder="Ex: Maria Silva" maxlength="60"></div>
        <div><div class="field-label">ğŸ“± WhatsApp * (DDD + nÃºmero)</div>
          <input type="tel" class="input-field" id="cadastroTel" placeholder="(75) 9xxxx-xxxx" maxlength="20"></div>
        <div><div class="field-label">Login *</div>
          <input type="text" class="input-field" id="cadastroLogin" placeholder="Ex: maria_silva" maxlength="30" oninput="this.value=this.value.replace(/[^a-z0-9_]/gi,'').toLowerCase()"></div>
        <div><div class="field-label">Senha * (mÃ­n. 6 caracteres)</div>
          <input type="password" class="input-field" id="cadastroSenha" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6"></div>
        <div><div class="field-label">E-mail (opcional)</div>
          <input type="email" class="input-field" id="cadastroEmail" placeholder="seuemail@gmail.com (opcional)"></div>
        <div><div class="field-label">Bairro</div>
          <select class="input-field" id="cadastroBairro">
            <option value="Centro">Centro</option>
            <option value="Zona Rural">Zona Rural</option>
            <option value="Outro">Outro</option>
          </select></div>
      </div>

      <!-- NotificaÃ§Ãµes WhatsApp -->
      <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;padding:10px;background:#E7F9EE;border:1.5px solid #1DB95440;border-radius:10px;margin-bottom:4px;">
        <input type="checkbox" id="aceitaNotifWhats" style="width:18px;height:18px;accent-color:#25D366;margin-top:1px;flex-shrink:0;">
        <div>
          <div style="font-size:13px;font-weight:700;color:#1DB954;">ğŸ“² Receber promoÃ§Ãµes pelo WhatsApp</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">Receba alertas de promoÃ§Ãµes e ofertas dos mercados de PiatÃ£ diretamente no seu WhatsApp. VocÃª pode cancelar a qualquer momento.</div>
        </div>
      </label>

      <div style="background:#F0F6FF;border:1.5px solid rgba(26,115,200,.2);border-radius:12px;padding:13px;margin-bottom:6px;max-height:160px;overflow-y:auto;">
        <div style="font-family:var(--font-title);font-size:11px;font-weight:800;color:var(--azul-esc);margin-bottom:8px;">ğŸ“‹ TERMOS DE RESPONSABILIDADE</div>
        <div style="font-size:11px;color:var(--texto);line-height:1.7;">
          <p style="margin:0 0 6px;"><strong>1. Veracidade</strong> â€” PreÃ§os informados devem ser verificados pessoalmente.</p>
          <p style="margin:0 0 6px;"><strong>2. ProibiÃ§Ãµes</strong> â€” PreÃ§os falsos ou manipulados sÃ£o proibidos.</p>
          <p style="margin:0 0 6px;"><strong>3. Penalidades</strong> â€” 3 erros consecutivos resultam em bloqueio temporÃ¡rio.</p>
          <p style="margin:0 0 6px;"><strong>4. Responsabilidade</strong> â€” VocÃª Ã© responsÃ¡vel pelas informaÃ§Ãµes inseridas.</p>
          <p style="margin:0;padding:7px;background:rgba(26,115,200,.08);border-radius:7px;border-left:3px solid var(--azul-esc);"><strong>âš ï¸ Aviso:</strong> PreÃ§os tÃªm carÃ¡ter informativo. Confirme no estabelecimento.</p>
        </div>
      </div>

      <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;padding:4px 0;margin-bottom:14px;">
        <input type="checkbox" id="aceitaTermos" style="width:18px;height:18px;accent-color:var(--verde);margin-top:1px;flex-shrink:0;">
        <span style="font-size:12px;color:var(--texto);line-height:1.5;">Li e concordo com os <strong>Termos de Responsabilidade</strong></span>
      </label>

<!-- banner email verificaÃ§Ã£o removido -->

      <button class="btn-primary" onclick="cadastrarCliente()" style="font-size:15px;padding:15px;">
        ğŸ›’ Criar Conta GrÃ¡tis
      </button>
    </div>

  </div>
</div>
<div id="home" class="screen">
  <div class="home-header">
    <button onclick="irPara('login')" style="width:36px;height:36px;background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.35);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;flex-shrink:0;-webkit-appearance:none;color:#fff;">â†</button>
    <div style="font-family:var(--font-title);font-weight:900;font-size:17px;color:#fff;flex:1;">PreÃ§oCerto</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <div id="adminTag" onclick="irPara('admin')" style="display:none;background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.4);color:#fff;font-size:11px;font-weight:700;padding:5px 12px;border-radius:100px;cursor:pointer;font-family:var(--font-title);">âš™ï¸ Admin</div>
      <div id="clienteTag" onclick="abrirPerfilCliente()" style="display:none;background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.35);color:#fff;font-size:11px;font-weight:700;padding:5px 10px;border-radius:100px;cursor:pointer;font-family:var(--font-title);max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
      <div id="homeAvatar" onclick="clienteLogado?abrirPerfilCliente():irPara('login')" style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.45);display:flex;align-items:center;justify-content:center;font-size:17px;cursor:pointer;overflow:hidden;flex-shrink:0;">
        <span id="homeAvatarEmoji">ğŸ‘¤</span>
        <img id="homeAvatarImg" src="" style="display:none;width:100%;height:100%;object-fit:cover;">
      </div>
    </div>
  </div>
  <!-- Banner de conta bloqueada -->
  <div id="bloqueadoBanner" style="display:none;background:#DC2626;padding:10px 16px;display:none;align-items:center;gap:10px;">
    <span style="font-size:18px;">ğŸ”’</span>
    <div style="flex:1;">
      <div style="font-family:var(--font-title);font-size:13px;font-weight:800;color:#fff;">Conta em anÃ¡lise</div>
      <div style="font-size:11px;color:rgba(255,255,255,.85);">VocÃª pode ver preÃ§os, mas nÃ£o contribuir. Aguarde liberaÃ§Ã£o do admin.</div>
    </div>
  </div>
  <div class="home-hero">
    <div class="hero-tag" id="heroLocTag">ğŸ“ PiatÃ£, BA</div>
    <h1 class="hero-title">Pague menos<br>no <span class="destaque">mercado</span><br>toda vez.</h1>
    <p class="hero-subtitle">Compare preÃ§os em PiatÃ£. InformaÃ§Ãµes atualizadas pela comunidade.</p>
    <div class="hero-stats">
      <div class="stat"><span class="stat-num" id="totalProdutos">0</span><span class="stat-label">Produtos</span></div>
      <div class="stat"><span class="stat-num" id="totalMercados">0</span><span class="stat-label">Mercados</span></div>
      <div class="stat"><span class="stat-num" id="totalPromos">0</span><span class="stat-label">PromoÃ§Ãµes</span></div>
    </div>
    <button class="btn-primary" onclick="irParaBusca()">ğŸ” Buscar Produtos</button>
    <button class="btn-secondary" onclick="irPara('contribuir')" style="margin-top:8px;">ğŸ“¸ Contribuir com PreÃ§os</button>
    <button class="btn-secondary" onclick="irPara('planos')" style="margin-top:6px;padding:12px 24px;font-size:13px;">ğŸ¤ Cadastre seu Mercado</button>
  </div>
  <div class="promo-home" id="promoHomeSection" style="display:none">
    <div class="promo-home-title">ğŸ”¥ PromoÃ§Ãµes de hoje</div>
    <div class="promo-scroll" id="promoHomeScroll"></div>
  </div>
  <div class="floating-preview" id="floatingCards"></div>
</div>

<!-- BUSCA -->
<div id="busca" class="screen">
  <div class="busca-header">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <button onclick="irPara('home')" style="width:36px;height:36px;background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.3);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;color:#fff;flex-shrink:0;-webkit-appearance:none;">â†</button>
      <span style="font-family:var(--font-title);font-size:18px;font-weight:900;color:#fff;">Buscar Produtos</span>
    </div>
    <div class="search-row">
      <div class="search-box">
        <span style="font-size:17px;opacity:.6;">ğŸ”</span>
        <input type="text" id="campoBusca" placeholder="Ex: Arroz Camil, Leite Piracanjuba..." oninput="filtrarProdutos()" autocomplete="off">
      </div>
      <button class="filter-btn" id="filterBtn" onclick="toggleBairroFilter()">ğŸ˜ï¸</button>
    </div>
  </div>
  <div class="bairro-dd" id="bairroDD" style="margin:0 16px;">
    <div class="field-label" style="margin-top:10px;">Filtrar por bairro</div>
    <div class="chip-row" id="bairroChips"></div>
  </div>
  <div class="categorias" id="categorias"></div>
  <div class="section-label" id="secaoLabel">Todos os produtos</div>
  <div class="produtos-lista pb-nav" id="produtosLista"></div>
  <div class="bottom-nav show" id="navBusca">
    <div class="nav-item" onclick="irPara('home')"><span class="nav-icon">ğŸ </span><span class="nav-label">InÃ­cio</span></div>
    <div class="nav-item ativo"><span class="nav-icon">ğŸ”</span><span class="nav-label">Buscar</span></div>
    <div class="nav-item" onclick="irPara('contribuir')"><span class="nav-icon">ğŸ“¸</span><span class="nav-label">Contribuir</span></div>
    <div class="nav-item" onclick="irPara('lista')"><span class="nav-icon-wrap"><span class="nav-icon">ğŸ›’</span><span class="nav-badge" id="badgeLista" style="display:none">0</span></span><span class="nav-label">Lista</span></div>
    <div class="nav-item" onclick="irPara('suporte')"><span class="nav-icon">ğŸ’¬</span><span class="nav-label">Suporte</span></div>
  </div>
</div>

<!-- DETALHE -->
<div id="detalhe" class="screen">
  <div class="detalhe-hero">
    <button class="detalhe-back" onclick="irPara('busca')">â†</button>
    <span class="detalhe-emoji-g" id="detalheEmoji"></span>
    <div class="detalhe-nome" id="detalheNome"></div>
    <div class="detalhe-cat" id="detalheCat"></div>
    <div class="detalhe-acoes">
      <div class="economia-badge" id="economiaInfo"></div>
      <button class="lista-btn" id="detalhe-lista-btn" onclick="toggleListaDetalhe()">+ Lista</button>
    </div>
  </div>
  <div class="mercados-lista pb-nav" id="mercadosLista"></div>
  <div class="bottom-nav show">
    <div class="nav-item" onclick="irPara('home')"><span class="nav-icon">ğŸ </span><span class="nav-label">InÃ­cio</span></div>
    <div class="nav-item ativo"><span class="nav-icon">ğŸ”</span><span class="nav-label">Buscar</span></div>
    <div class="nav-item" onclick="irPara('contribuir')"><span class="nav-icon">ğŸ“¸</span><span class="nav-label">Contribuir</span></div>
    <div class="nav-item" onclick="irPara('lista')"><span class="nav-icon-wrap"><span class="nav-icon">ğŸ›’</span><span class="nav-badge" id="badgeLista2" style="display:none">0</span></span><span class="nav-label">Lista</span></div>
    <div class="nav-item" onclick="irPara('suporte')"><span class="nav-icon">ğŸ’¬</span><span class="nav-label">Suporte</span></div>
  </div>
</div>

<!-- CONTRIBUIR (CLIENTE) -->
<div id="contribuir" class="screen">
  <div class="contrib-header">
    <div style="display:flex;align-items:center;gap:10px;">
      <button class="detalhe-back" onclick="irPara('home')" style="background:#FFFFFF12;">â†</button>
    </div>
    <div class="contrib-title">ğŸ“¸ Contribuir com PreÃ§os</div>
    <div class="contrib-sub">Envie uma foto da etiqueta ou digite o preÃ§o que viu. Sua contribuiÃ§Ã£o ajuda toda a comunidade!</div>
  </div>
  <div class="contrib-tabs">
    <div class="contrib-tab ativo" onclick="setContribTab('foto')">ğŸ“· Foto</div>
    <div class="contrib-tab" onclick="setContribTab('texto')">âœï¸ Texto</div>
    <div class="contrib-tab" onclick="setContribTab('qr')">ğŸ“± QR Nota</div>
  </div>
  <div class="contrib-body pb-nav" id="contribBody">
    <!-- renderizado via JS -->
  </div>
  <div class="bottom-nav show">
    <div class="nav-item" onclick="irPara('home')"><span class="nav-icon">ğŸ </span><span class="nav-label">InÃ­cio</span></div>
    <div class="nav-item" onclick="irPara('busca')"><span class="nav-icon">ğŸ”</span><span class="nav-label">Buscar</span></div>
    <div class="nav-item ativo"><span class="nav-icon">ğŸ“¸</span><span class="nav-label">Contribuir</span></div>
    <div class="nav-item" onclick="irPara('lista')"><span class="nav-icon-wrap"><span class="nav-icon">ğŸ›’</span><span class="nav-badge" id="badgeLista3" style="display:none">0</span></span><span class="nav-label">Lista</span></div>
    <div class="nav-item" onclick="irPara('suporte')"><span class="nav-icon">ğŸ’¬</span><span class="nav-label">Suporte</span></div>
  </div>
</div>

<!-- PORTAL MERCADO -->
<div id="portalMercado" class="screen">
  <div class="portal-header">
    <button class="detalhe-back" onclick="irPara('home')" style="background:#FFFFFF12;">â†</button>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="portalMercIcone" style="font-size:32px;">ğŸª</span>
      <div>
        <div class="portal-merc-nome" id="portalMercNome">Mercado</div>
        <div class="portal-plano" id="portalMercPlano">â­ Parceiro</div>
      </div>
    </div>
  </div>
  <div class="portal-tabs">
    <div class="portal-tab ativo" onclick="setPortalTab('atualizar')">ğŸ’° Atualizar PreÃ§os</div>
    <div class="portal-tab" onclick="setPortalTab('promocoes')">ğŸ”¥ PromoÃ§Ãµes</div>
    <div class="portal-tab" onclick="setPortalTab('meus_precos')">ğŸ“‹ Meus PreÃ§os</div>
  </div>
  <div class="portal-body pb-nav" id="portalBody"></div>
</div>

<!-- LISTA -->
<div id="lista" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="irPara('busca')">â†</button>
    <span class="top-bar-title">ğŸ›’ Minha Lista</span>
  </div>
  <div id="listaVazia" class="lista-vazia" style="display:none"><span class="emoji">ğŸ›’</span><p style="color:var(--muted);font-size:14px;">Sua lista estÃ¡ vazia.<br>Adicione produtos na busca!</p><button class="btn-azul" style="width:auto;padding:12px 24px;" onclick="irParaBusca()">Buscar Produtos</button></div>
  <div style="flex:1;overflow-y:auto;padding:0 16px;display:flex;flex-direction:column;gap:8px;" class="pb-nav" id="listaContent"></div>
  <div class="lista-footer" id="listaFooter" style="display:none">
    <div class="lista-total"><span class="total-label">Total estimado</span><span class="total-valor" id="totalLista">R$ 0,00</span></div>
    <div class="lista-acoes"><button class="btn-limpar" onclick="limparLista()">ğŸ—‘ï¸ Limpar</button><button class="btn-compartilhar" onclick="compartilharLista()">ğŸ“‹ Copiar lista</button></div>
  </div>
  <div class="bottom-nav show">
    <div class="nav-item" onclick="irPara('home')"><span class="nav-icon">ğŸ </span><span class="nav-label">InÃ­cio</span></div>
    <div class="nav-item" onclick="irPara('busca')"><span class="nav-icon">ğŸ”</span><span class="nav-label">Buscar</span></div>
    <div class="nav-item" onclick="irPara('contribuir')"><span class="nav-icon">ğŸ“¸</span><span class="nav-label">Contribuir</span></div>
    <div class="nav-item ativo"><span class="nav-icon-wrap"><span class="nav-icon">ğŸ›’</span><span class="nav-badge" id="badgeLista4" style="display:none">0</span></span><span class="nav-label">Lista</span></div>
    <div class="nav-item" onclick="irPara('suporte')"><span class="nav-icon">ğŸ’¬</span><span class="nav-label">Suporte</span></div>
  </div>
</div>

<!-- ADMIN -->
<div id="admin" class="screen">
  <div class="admin-top">
    <button onclick="irPara('home')" style="width:36px;height:36px;background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.3);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;color:#fff;flex-shrink:0;-webkit-appearance:none;">â†</button>
    <span class="admin-top-title">ğŸ›¡ï¸ Painel Admin</span>
    <button onclick="abrirPerfilAdmin()" style="background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);border-radius:9px;padding:7px 13px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font-title);">ğŸ‘¤ Conta</button>
    <button onclick="fazerLogout()" style="background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);border-radius:9px;padding:7px 13px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font-title);">Sair</button>
  </div>
  <div class="admin-tabs" id="adminTabs">
    <div class="tab ativo" onclick="mudarTab('visao_geral')">ğŸ‘ï¸ VisÃ£o Geral</div>
    <div class="tab" onclick="mudarTab('contribuicoes')">ğŸ“¥ ContribuiÃ§Ãµes</div>
    <div class="tab" onclick="mudarTab('clientes')">ğŸ‘¤ Clientes</div>
    <div class="tab" onclick="mudarTab('suporte_admin')">ğŸ’¬ Suporte</div>
    <div class="tab" onclick="mudarTab('logs_admin')">ğŸ“‹ Logs</div>
    <div class="tab" onclick="mudarTab('localizacao')">ğŸ“ Local</div>
    <div class="tab" onclick="mudarTab('precos')">ğŸ’° PreÃ§os</div>
    <div class="tab" onclick="mudarTab('produto')">ğŸ¥« Produto</div>
    <div class="tab" onclick="mudarTab('mercado')">ğŸª Mercado</div>
    <div class="tab" onclick="mudarTab('promocoes')">ğŸ”¥ PromoÃ§Ãµes</div>
    <div class="tab" onclick="mudarTab('planos_config')">ğŸ’ Planos</div>
    <div class="tab" onclick="mudarTab('solicitacoes')">ğŸ“‹ Solic.</div>
    <div class="tab" onclick="mudarTab('usuarios')">ğŸ‘¥ UsuÃ¡rios</div>
    <div class="tab" onclick="mudarTab('busca_auto')">ğŸ” Busca Auto</div>
    <div class="tab" onclick="mudarTab('ocorrencias')">ğŸš¨ OcorrÃªncias</div>
  </div>
  <div class="admin-form pb-nav" id="adminForm"></div>
  <div class="feedback-bar ok" id="adminFeedback"></div>
</div>

<!-- PLANOS -->
<div id="planos" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="irPara('home')">â†</button>
    <span class="top-bar-title">Cadastre seu Mercado</span>
  </div>
  <div style="flex:1;overflow-y:auto;padding:14px 16px 100px;display:flex;flex-direction:column;gap:14px;" id="planosContent"></div>
</div>

<!-- SOLICITAR -->
<div id="solicitar" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="irPara('planos')">â†</button>
    <span class="top-bar-title" id="solicitarTitulo">Solicitar Cadastro</span>
  </div>
  <div style="flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:12px;" class="pb-nav">
    <div style="background:#DBEAFE;border:1.5px solid rgba(26,115,200,.2);border-radius:13px;padding:13px;font-size:13px;color:var(--azul);line-height:1.5;">ğŸ“‹ Preencha os dados e entraremos em contato para confirmar seu cadastro.</div>
    <div><div class="field-label">Nome do Mercado *</div><input type="text" class="input-field" id="solNome" placeholder="Ex: Mercadinho do ZÃ©"></div>
    <div><div class="field-label">ResponsÃ¡vel *</div><input type="text" class="input-field" id="solResp" placeholder="Seu nome completo"></div>
    <div><div class="field-label">ğŸ“± WhatsApp * (credenciais enviadas aqui)</div><input type="tel" class="input-field" id="solWhats" placeholder="(75) 99999-9999"></div>
    <div><div class="field-label">EndereÃ§o</div><input type="text" class="input-field" id="solEnd" placeholder="Rua, nÃºmero, bairro"></div>
    <div><div class="field-label">Bairro / RegiÃ£o</div><input type="text" class="input-field" id="solBairro" placeholder="Ex: Centro, Vila Nova..."></div>
    <div style="background:#DCFCE7;border:1.5px solid rgba(29,185,84,.25);border-radius:11px;padding:13px;">
      <div style="font-size:12px;color:var(--muted);font-weight:600;">Plano selecionado</div>
      <div style="font-family:var(--font-title);font-weight:800;font-size:16px;color:var(--verde-dk);" id="planoSelecionadoNome">â€”</div>
    </div>
    <button class="btn-primary" onclick="enviarSolicitacao()">ğŸ“¨ Enviar SolicitaÃ§Ã£o</button>
  </div>
</div>

<!-- MODAL QR LEITOR NOTA FISCAL -->
<div class="modal-overlay" id="modalQR">
  <div class="modal-box">
    <button class="modal-close" onclick="fecharModal('modalQR');pararQR()">âœ• fechar</button>
    <div class="modal-title">ğŸ“· Ler Nota Fiscal (QR)</div>
    <div class="modal-sub">Aponte a cÃ¢mera para o QR Code da nota fiscal eletrÃ´nica.</div>
    <div id="qrVideoArea" style="background:var(--card2);border-radius:14px;overflow:hidden;position:relative;margin-bottom:12px;">
      <video id="qrVideo" style="width:100%;border-radius:14px;display:block;" playsinline autoplay muted></video>
      <canvas id="qrCanvas" style="display:none;"></canvas>
      <div style="position:absolute;inset:0;border:2px solid var(--verde);border-radius:14px;pointer-events:none;"></div>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:160px;height:160px;border:3px solid var(--verde);border-radius:12px;box-shadow:0 0 0 9999px #00000060;"></div>
    </div>
    <div id="qrStatus" style="text-align:center;font-size:13px;color:var(--muted);margin-bottom:12px;">Iniciando cÃ¢mera...</div>
    <button class="btn-primary" onclick="entradaManualQR()">ğŸ“‹ Entrada manual de preÃ§os</button>
    <div id="qrResultado" style="display:none;margin-top:12px;flex-direction:column;gap:10px;">
      <div style="background:#00C89612;border:1px solid #00C89630;border-radius:12px;padding:12px;">
        <div style="font-size:12px;color:var(--verde);font-weight:700;margin-bottom:6px;">âœ… Nota lida com sucesso!</div>
        <div id="qrInfoNota" style="font-size:12px;color:var(--muted);"></div>
      </div>
      <div id="qrListaProdutos" style="display:flex;flex-direction:column;gap:6px;"></div>
      <button class="btn-primary" onclick="enviarContribQR()">ğŸ“¤ Enviar para aprovaÃ§Ã£o</button>
    </div>
  </div>
</div>

<!-- MODAL BUSCA AUTO PREÃ‡OS -->
<div class="modal-overlay" id="modalBuscaAuto">
  <div class="modal-box">
    <button class="modal-close" onclick="fecharModal('modalBuscaAuto')">âœ• fechar</button>
    <div class="modal-title">ğŸ” Busca AutomÃ¡tica de PreÃ§os</div>
    <div class="modal-sub">Busca informaÃ§Ãµes pÃºblicas de mercados e preÃ§os na regiÃ£o.</div>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div><div class="field-label">Cidade / RegiÃ£o</div>
        <input type="text" class="input-field" id="buscaAutoLocal" placeholder="Ex: PiatÃ£, BA" value="PiatÃ£, BA">
      </div>
      <div><div class="field-label">O que buscar</div>
        <select class="input-field" id="buscaAutoTipo">
          <option value="mercados">Mercados e supermercados</option>
          <option value="precos">PreÃ§os de produtos</option>
          <option value="ambos">Mercados + PreÃ§os</option>
        </select>
      </div>
      <div id="buscaAutoStatus" style="display:none;"></div>
      <button class="btn-primary" onclick="executarBuscaAuto()">ğŸš€ Iniciar Busca</button>
      <div id="buscaAutoResultados" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>
</div>

<!-- MODAL MAPA PICKER (Leaflet) -->
<div id="modalMapaPicker">
  <div class="mapa-picker-box">
    <div style="padding:14px 16px 0;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-family:var(--font-title);font-size:16px;font-weight:700;">ğŸ“ Marcar localizaÃ§Ã£o</div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px);">Toque no mapa para marcar a localizaÃ§Ã£o exata do mercado</div>
      </div>
      <button onclick="fecharMapaPicker()" style="background:var(--card2);border:none;border-radius:50%;width:34px;height:34px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">âœ•</button>
    </div>
    <div id="leafletMap"></div>
    <div class="mapa-picker-info">
      <div id="mapaPickerCoords" style="font-size:13px;color:var(--muted);text-align:center;padding:8px;background:var(--card2);border-radius:10px;">
        ğŸ‘† Toque no mapa para selecionar a localizaÃ§Ã£o
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="fecharMapaPicker()" style="flex:1;padding:11px;border-radius:12px;border:1.5px solid var(--borda);background:transparent;color:var(--texto);font-weight:700;font-size:13px;cursor:pointer;">Cancelar</button>
        <button id="btnConfirmarLoc" onclick="confirmarLocalizacao()" disabled style="flex:2;padding:11px;border-radius:12px;border:none;background:var(--azul);color:#fff;font-weight:700;font-size:13px;cursor:pointer;opacity:.5;">âœ… Confirmar localizaÃ§Ã£o</button>
      </div>
    </div>
  </div>
</div>

<!-- BANNER PWA INSTALAR -->
<!-- SUPORTE CHAT -->
<div id="suporte" class="screen">
  <div style="background:var(--grad-azul);padding:calc(52px + var(--safe-top)) 16px 16px;position:relative;">
    <div style="display:flex;align-items:center;gap:12px;">
      <button onclick="irPara('home')" style="width:36px;height:36px;background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.35);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:#fff;flex-shrink:0;-webkit-appearance:none;">â†</button>
      <div style="flex:1;">
        <div style="font-family:var(--font-title);font-weight:900;font-size:17px;color:#fff;">ğŸ’¬ Suporte PreÃ§oCerto</div>
        <div style="font-size:11px;color:rgba(255,255,255,.75);margin-top:2px;" id="chatStatusBar">Fale com nossa equipe de suporte</div>
      </div>
      <div style="width:36px;height:36px;background:rgba(29,185,84,.3);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;">ğŸ§</div>
    </div>
  </div>
  <!-- Messages area -->
  <div id="chatMsgs" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;padding-bottom:80px;min-height:400px;"></div>
  <!-- Input area fixed at bottom -->
  <div style="position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1.5px solid var(--borda);padding:10px 14px calc(12px + var(--safe-bottom));display:flex;gap:8px;align-items:flex-end;z-index:50;">
    <div style="flex:1;background:var(--card2);border-radius:22px;border:1.5px solid var(--borda);padding:10px 14px;display:flex;align-items:center;">
      <textarea id="chatInput" rows="1" placeholder="Digite sua mensagem..." style="flex:1;border:none;background:transparent;outline:none;font-size:14px;font-family:var(--font-body);resize:none;max-height:80px;line-height:1.4;" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();enviarMsgChat();}"></textarea>
    </div>
    <button onclick="enviarMsgChat()" style="width:44px;height:44px;background:var(--grad-verde);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;flex-shrink:0;box-shadow:0 3px 12px rgba(29,185,84,.4);">â†‘</button>
  </div>
</div>

<div id="pwaInstallBanner" style="display:none;position:fixed;bottom:calc(88px + var(--safe-bottom) + 10px);left:12px;right:12px;z-index:150;background:linear-gradient(135deg,var(--card),var(--card2));border:1px solid var(--verde);border-radius:16px;padding:14px 16px;display:none;align-items:center;gap:12px;box-shadow:0 8px 32px #000000A0;">
  <div style="width:40px;height:40px;background:var(--verde);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:var(--font-title);font-weight:800;color:#000;font-size:18px;flex-shrink:0;">P</div>
  <div style="flex:1;">
    <div style="font-weight:700;font-size:13px;">Instalar PreÃ§oCerto</div>
    <div style="font-size:11px;color:var(--muted);">Adicionar Ã  tela inicial como app</div>
  </div>
  <button onclick="instalarPWA()" style="background:var(--verde);color:#000;border:none;border-radius:10px;padding:8px 14px;font-weight:700;font-size:12px;cursor:pointer;flex-shrink:0;">Instalar</button>
  <button onclick="document.getElementById('pwaInstallBanner').style.display='none'" style="background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:0 4px;">âœ•</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== CONFIG =====
let adminLogado=false, adminUser=null, mercadoLogado=null, clienteLogado=null;
let produtoDetalheAtual=null, listaCompras=[];
let categoriaAtiva='Todos', bairroAtivo='Todos';
let tabAtiva='visao_geral', filtroAberto=false;
let contribTabAtiva='foto', portalTabAtiva='atualizar';
let planoSelecionado='', reportProdId=null, reportMercId=null;
let fotoDataUrl=null, loginTabAtiva='cliente';
let perfilFoto=null, perfilNome='';
let qrStream=null, qrContribProdutos=[];
let pwaInstallPrompt=null;

let config={cidade:'PiatÃ£',estado:'BA',whatsapp:'5575999999999',precos_planos:{basico:39.90,pro:69.90,premium:119.90}};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸŒ  CAMADA DE API â€” conecta ao backend em tempo real
//  Detecta automaticamente a URL do backend.
//  Se nÃ£o encontrar, usa os dados locais (modo offline).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:3000'
  : window.location.origin; // mesmo domÃ­nio no Render

let apiToken = localStorage.getItem('pc_token') || null;
let modoOffline = false; // true se backend nÃ£o responder

async function apiReq(method, path, body=null, auth=true){
  try {
    const headers = { 'Content-Type':'application/json' };
    if(auth && apiToken) headers['Authorization'] = 'Bearer ' + apiToken;
    const opts = { method, headers };
    if(body) opts.body = JSON.stringify(body);
    const res = await fetch(API_URL + path, opts);
    const data = await res.json();
    if(!res.ok) throw new Error(data.erro || 'Erro na API');
    modoOffline = false;
    return data;
  } catch(e) {
    if(e.message.includes('fetch') || e.message.includes('Failed') || e.message.includes('NetworkError')){
      modoOffline = true;
      console.warn('âš ï¸ Modo offline â€” usando dados locais');
    }
    throw e;
  }
}

// â”€â”€â”€ Helper IA via proxy seguro (Gemini no servidor) â”€â”€â”€
async function chamarIA(prompt, imageBase64=null, mediaType='image/jpeg'){
  try {
    const body = { prompt };
    if(imageBase64){ body.imageBase64 = imageBase64; body.mediaType = mediaType; }
    const res = await fetch(API_URL + '/api/ia/analisar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.erro || 'Erro na IA');
    return data.texto || '';
  } catch(e) {
    console.warn('IA indisponÃ­vel:', e.message);
    throw e;
  }
}

async function carregarDadosBackend(){
  try {
    showToast('Sincronizando dados...','ğŸ”„');

    // Carrega tudo em paralelo
    const [cfg, mercados, produtos, precos, promos] = await Promise.all([
      apiReq('GET','/api/config', null, false),
      apiReq('GET','/api/mercados', null, false),
      apiReq('GET','/api/produtos', null, false),
      apiReq('GET','/api/precos', null, false),
      apiReq('GET','/api/promocoes', null, false)
    ]);

    // Atualiza config
    if(cfg && cfg.cidade) config.cidade = cfg.cidade;
    if(cfg && cfg.estado) config.estado = cfg.estado;
    if(cfg && cfg.whatsapp) config.whatsapp = cfg.whatsapp;
    if(cfg && cfg.precos_planos) config.precos_planos = cfg.precos_planos;

    // Atualiza mercados
    if(mercados && mercados.length > 0){
      db.mercados = mercados.map(m=>({
        ...m,
        id: m._id,
        _id: m._id
      }));
      console.log('âœ… Mercados carregados:', db.mercados.length);
    }

    // Atualiza produtos â€” substitui lista local pelos do banco
    if(produtos && produtos.length > 0){
      db.produtos = produtos.map(p=>({
        ...p,
        id: p._id,
        _id: p._id
      }));
      console.log('âœ… Produtos carregados:', db.produtos.length);
    } else {
      console.warn('âš ï¸ Nenhum produto no banco ainda â€” usando locais');
    }

    // Atualiza preÃ§os
    if(precos && precos.length > 0){
      db.precos = precos.map(p=>({
        produtoId: p.produtoId?._id || p.produtoId,
        mercadoId: p.mercadoId?._id || p.mercadoId,
        preco: p.preco,
        dataAtu: p.dataAtu || hoje(),
        fonte: p.fonte || 'admin',
        autor: p.autor || 'Admin'
      }));
      console.log('âœ… PreÃ§os carregados:', db.precos.length);
    }

    // Atualiza promoÃ§Ãµes
    if(promos && promos.length > 0){
      db.promocoes = promos.map(p=>({
        id: p._id,
        produtoId: p.produtoId?._id || p.produtoId,
        mercadoId: p.mercadoId?._id || p.mercadoId,
        precoNormal: p.precoNormal,
        precoPromo: p.precoPromo,
        descricao: p.descricao || '',
        validade: p.validade,
        ativa: p.ativa !== false
      }));
    }

    modoOffline = false;
    showToast(`âœ… Online â€” ${db.produtos.length} produtos, ${db.mercados.length} mercados`,'ğŸŒ');
    console.log('âœ… Dados carregados do backend!');

    // Se admin estiver logado, carregar dados privados tambÃ©m
    if(adminLogado) await carregarDadosAdmin();

    return true;

  } catch(e){
    console.warn('âš ï¸ Backend indisponÃ­vel:', e.message);
    showToast('Modo offline â€” dados locais','ğŸ“±');
    modoOffline = true;
    return false;
  }
}

function salvarToken(token){ apiToken = token; localStorage.setItem('pc_token', token); }
function limparToken(){ apiToken = null; localStorage.removeItem('pc_token'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DADOS PRIVADOS DO ADMIN (solicitaÃ§Ãµes, clientes, etc.)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function carregarDadosAdmin(){
  if(!adminLogado || !apiToken) return;
  try {
    const [solicitacoes, clientes, contribuicoes, ocorrencias, logs] = await Promise.all([
      apiReq('GET', '/api/admin/solicitacoes').catch(()=>[]),
      apiReq('GET', '/api/admin/clientes').catch(()=>[]),
      apiReq('GET', '/api/contribuicoes').catch(()=>[]),
      apiReq('GET', '/api/ocorrencias').catch(()=>[]),
      apiReq('GET', '/api/admin/logs').catch(()=>[]),
    ]);
    if(Array.isArray(solicitacoes)){
      db.solicitacoes = solicitacoes.map(s=>({...s, id: s._id, _id: s._id}));
      console.log('âœ… Solicitacoes:', db.solicitacoes.length);
    }
    if(Array.isArray(clientes)) db.clientes = clientes.map(c=>({...c, id: c._id}));
    if(Array.isArray(contribuicoes)) db.contribuicoes = contribuicoes.map(c=>({...c, id: c._id}));
    if(Array.isArray(ocorrencias)) db.ocorrencias = ocorrencias.map(o=>({...o, id: o._id}));
    if(Array.isArray(logs)) db.logs = logs;
  } catch(e){
    console.warn('Erro dados admin:', e.message);
  }
}


function mostrarIndicadorSync(texto='Sincronizando...'){
  showToast(texto, 'ğŸ”„');
}

function hoje(){ return new Date().toLocaleDateString('pt-BR'); }
function hojeISO(){ return new Date().toISOString().split('T')[0]; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTOCOMPLETE DE PRODUTOS â€” usado em todos os campos
   de seleÃ§Ã£o de produto do app (contribuiÃ§Ã£o cliente,
   contribuiÃ§Ã£o texto, painel admin preÃ§os, admin produto)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function criarAutocomplete(inputEl, listEl, onSelect){
  // onSelect(produto) Ã© chamado quando o usuÃ¡rio escolhe um item
  let focusedIdx = -1;

  function highlight(txt, q){
    if(!q) return txt;
    const re = new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
    return txt.replace(re,'<mark>$1</mark>');
  }

  // Normaliza string removendo acentos para busca
  function norm(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

  function renderList(query){
    const q = norm(query.trim());
    listEl.innerHTML = '';
    focusedIdx = -1;
    if(!q){ listEl.classList.remove('show'); return; }

    // Filtra e pontua: exato > comeÃ§a com > contÃ©m (sem acento)
    const matches = db.produtos
      .map(p => {
        const nome = norm(p.nome);
        const nomeOrig = p.nome.toLowerCase();
        let score = 0;
        if(nome === q || nomeOrig === q) score = 4;
        else if(nome.startsWith(q) || nomeOrig.startsWith(q)) score = 3;
        else if(nome.includes(q) || nomeOrig.includes(q)) score = 2;
        // Busca por palavras individuais
        else if(q.split(' ').every(w => nome.includes(w))) score = 1;
        return {p, score};
      })
      .filter(x => x.score > 0)
      .sort((a,b) => b.score - a.score || a.p.nome.localeCompare(b.p.nome))
      .slice(0, 15);

    if(!matches.length){ listEl.classList.remove('show'); return; }

    matches.forEach(({p}, i) => {
      const div = document.createElement('div');
      div.className = 'ac-item';
      div.innerHTML = `<span class="ac-emoji">${p.emoji}</span>
        <div class="ac-right">
          <div class="ac-nome">${highlight(p.nome, query.trim())}</div>
          <div class="ac-cat">${p.categoria}</div>
        </div>`;
      div.addEventListener('mousedown', e => { e.preventDefault(); selectItem(p); });
      div.addEventListener('touchstart', e => { e.preventDefault(); selectItem(p); },{passive:false});
      listEl.appendChild(div);
    });
    listEl.classList.add('show');
  }

  function selectItem(p){
    inputEl.value = p.nome;
    listEl.classList.remove('show');
    onSelect(p);
  }

  inputEl.addEventListener('input', () => renderList(inputEl.value));
  inputEl.addEventListener('focus', () => { if(inputEl.value) renderList(inputEl.value); });
  inputEl.addEventListener('blur', () => setTimeout(()=>listEl.classList.remove('show'), 200));
  inputEl.addEventListener('keydown', e => {
    const items = listEl.querySelectorAll('.ac-item');
    if(!items.length) return;
    if(e.key==='ArrowDown'){ e.preventDefault(); focusedIdx=Math.min(focusedIdx+1,items.length-1); items.forEach((el,i)=>el.classList.toggle('focused',i===focusedIdx)); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); focusedIdx=Math.max(focusedIdx-1,0); items.forEach((el,i)=>el.classList.toggle('focused',i===focusedIdx)); }
    else if(e.key==='Enter' && focusedIdx>=0){ e.preventDefault(); items[focusedIdx].dispatchEvent(new Event('mousedown')); }
    else if(e.key==='Escape'){ listEl.classList.remove('show'); }
  });
}

// Fecha qualquer autocomplete aberto ao clicar fora
document.addEventListener('click', e=>{
  document.querySelectorAll('.ac-list.show').forEach(l=>{
    if(!l.previousElementSibling?.contains(e.target)) l.classList.remove('show');
  });
});

let db={
  admins:[
    {id:1,usuario:'admin',_h:'d4m4v4321',nome:'Administrador',nivel:'super'},
  ],
  mercados:[
    {id:1,nome:'Mercado SÃ£o JoÃ£o',icone:'ğŸª',endereco:'Rua Principal, 45',bairro:'Centro',parceiro:false,plano:null,usuario:'mercado_joao',_h:'j123',website:'https://instagram.com/mercadosaojoao_piata',lat:-13.0774,lng:-41.7082},
    {id:2,nome:'Supermercado PiatÃ£',icone:'ğŸ›’',endereco:'Av. GetÃºlio Vargas, 120',bairro:'Centro',parceiro:false,plano:null,usuario:'super_piata',_h:'p123',website:'',lat:-13.0781,lng:-41.7095},
    {id:3,nome:'Mini Mercado da PraÃ§a',icone:'ğŸ¬',endereco:'PraÃ§a da Matriz, 8',bairro:'Centro',parceiro:false,plano:null,usuario:null,_h:null,website:null,lat:-13.0769,lng:-41.7078},
    {id:4,nome:'EmpÃ³rio Rural',icone:'ğŸŒ¿',endereco:'Estrada do SertÃ£o, km 3',bairro:'Zona Rural',parceiro:false,plano:null,usuario:null,_h:null,website:null,lat:-13.0820,lng:-41.7130},
  ],
  produtos:[
    // ğŸ FRUTAS (vendidas por kg/unidade â€” sem marca)
    {id:1,nome:'Banana Prata kg',emoji:'ğŸŒ',categoria:'Frutas'},
    {id:2,nome:'Banana Nanica kg',emoji:'ğŸŒ',categoria:'Frutas'},
    {id:3,nome:'MaÃ§Ã£ Fuji kg',emoji:'ğŸ',categoria:'Frutas'},
    {id:4,nome:'MaÃ§Ã£ Gala kg',emoji:'ğŸ',categoria:'Frutas'},
    {id:5,nome:'Pera Williams kg',emoji:'ğŸ',categoria:'Frutas'},
    {id:6,nome:'Laranja Lima kg',emoji:'ğŸŠ',categoria:'Frutas'},
    {id:7,nome:'Laranja Pera kg',emoji:'ğŸŠ',categoria:'Frutas'},
    {id:8,nome:'LimÃ£o Tahiti kg',emoji:'ğŸ‹',categoria:'Frutas'},
    {id:9,nome:'Abacaxi PÃ©rola un',emoji:'ğŸ',categoria:'Frutas'},
    {id:10,nome:'MamÃ£o Formosa kg',emoji:'ğŸ§¡',categoria:'Frutas'},
    {id:11,nome:'MamÃ£o Papaia kg',emoji:'ğŸ§¡',categoria:'Frutas'},
    {id:12,nome:'Manga Tommy kg',emoji:'ğŸ¥­',categoria:'Frutas'},
    {id:13,nome:'Manga Espada kg',emoji:'ğŸ¥­',categoria:'Frutas'},
    {id:14,nome:'Uva ItÃ¡lia kg',emoji:'ğŸ‡',categoria:'Frutas'},
    {id:15,nome:'Uva Rubi kg',emoji:'ğŸ‡',categoria:'Frutas'},
    {id:16,nome:'Melancia kg',emoji:'ğŸ‰',categoria:'Frutas'},
    {id:17,nome:'MelÃ£o Amarelo kg',emoji:'ğŸˆ',categoria:'Frutas'},
    {id:18,nome:'Morango cx 300g',emoji:'ğŸ“',categoria:'Frutas'},
    {id:19,nome:'Kiwi kg',emoji:'ğŸ¥',categoria:'Frutas'},
    {id:20,nome:'Goiaba kg',emoji:'ğŸ’š',categoria:'Frutas'},
    {id:21,nome:'Acerola kg',emoji:'ğŸ’',categoria:'Frutas'},
    {id:22,nome:'MaracujÃ¡ kg',emoji:'ğŸŸ£',categoria:'Frutas'},
    {id:23,nome:'Abacate kg',emoji:'ğŸ¥‘',categoria:'Frutas'},
    {id:24,nome:'Coco Verde un',emoji:'ğŸ¥¥',categoria:'Frutas'},
    {id:25,nome:'Tangerina Ponkan kg',emoji:'ğŸŠ',categoria:'Frutas'},
    // ğŸ¥¬ VERDURAS
    {id:26,nome:'Alface Americana un',emoji:'ğŸ¥¬',categoria:'Verduras'},
    {id:27,nome:'Alface Crespa un',emoji:'ğŸ¥¬',categoria:'Verduras'},
    {id:28,nome:'RÃºcula maÃ§o',emoji:'ğŸŒ¿',categoria:'Verduras'},
    {id:29,nome:'Couve maÃ§o',emoji:'ğŸ¥¬',categoria:'Verduras'},
    {id:30,nome:'Espinafre maÃ§o',emoji:'ğŸ¥¬',categoria:'Verduras'},
    {id:31,nome:'Repolho Verde un',emoji:'ğŸ¥¬',categoria:'Verduras'},
    {id:32,nome:'Repolho Roxo un',emoji:'ğŸ¥¬',categoria:'Verduras'},
    {id:33,nome:'AgriÃ£o maÃ§o',emoji:'ğŸŒ¿',categoria:'Verduras'},
    {id:34,nome:'ChicÃ³ria maÃ§o',emoji:'ğŸŒ¿',categoria:'Verduras'},
    // ğŸ¥• LEGUMES
    {id:35,nome:'Tomate Salada kg',emoji:'ğŸ…',categoria:'Legumes'},
    {id:36,nome:'Tomate Cereja cx',emoji:'ğŸ…',categoria:'Legumes'},
    {id:37,nome:'Cebola Branca kg',emoji:'ğŸ§…',categoria:'Legumes'},
    {id:38,nome:'Cebola Roxa kg',emoji:'ğŸ§…',categoria:'Legumes'},
    {id:39,nome:'Alho Nacional kg',emoji:'ğŸ§„',categoria:'Legumes'},
    {id:40,nome:'Batata Inglesa kg',emoji:'ğŸ¥”',categoria:'Legumes'},
    {id:41,nome:'Batata Doce kg',emoji:'ğŸ ',categoria:'Legumes'},
    {id:42,nome:'Cenoura kg',emoji:'ğŸ¥•',categoria:'Legumes'},
    {id:43,nome:'Beterraba kg',emoji:'ğŸŸ£',categoria:'Legumes'},
    {id:44,nome:'Abobrinha kg',emoji:'ğŸ¥’',categoria:'Legumes'},
    {id:45,nome:'Chuchu kg',emoji:'ğŸŸ¢',categoria:'Legumes'},
    {id:46,nome:'Pepino kg',emoji:'ğŸ¥’',categoria:'Legumes'},
    {id:47,nome:'PimentÃ£o Verde kg',emoji:'ğŸ«‘',categoria:'Legumes'},
    {id:48,nome:'PimentÃ£o Vermelho kg',emoji:'ğŸ«‘',categoria:'Legumes'},
    {id:49,nome:'PimentÃ£o Amarelo kg',emoji:'ğŸ«‘',categoria:'Legumes'},
    {id:50,nome:'Quiabo kg',emoji:'ğŸŸ¢',categoria:'Legumes'},
    {id:51,nome:'Berinjela kg',emoji:'ğŸ†',categoria:'Legumes'},
    {id:52,nome:'Milho Verde un',emoji:'ğŸŒ½',categoria:'Legumes'},
    // ğŸš MERCEARIA â€” ARROZ
    {id:53,nome:'Arroz Camil Branco 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:54,nome:'Arroz Camil Branco 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:55,nome:'Arroz Tio JoÃ£o Branco 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:56,nome:'Arroz Tio JoÃ£o Branco 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:57,nome:'Arroz Prato Fino 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:58,nome:'Arroz Prato Fino 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:268,nome:'Arroz Namorado Branco 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:269,nome:'Arroz Blue Ville 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:270,nome:'Arroz Urbano Branco 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:271,nome:'Arroz Integral Camil 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:272,nome:'Arroz Integral Tio JoÃ£o 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:273,nome:'Arroz Integral Prato Fino 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:274,nome:'Arroz Integral Namorado 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:275,nome:'Arroz Integral Urbano 1kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:276,nome:'Arroz Parboilizado Camil 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    {id:277,nome:'Arroz Parboilizado Tio JoÃ£o 5kg',emoji:'ğŸš',categoria:'Mercearia'},
    // FEIJÃƒO
    {id:59,nome:'FeijÃ£o Carioca Camil 1kg',emoji:'ğŸ«˜',categoria:'Mercearia'},
    {id:60,nome:'FeijÃ£o Carioca Kicaldo 1kg',emoji:'ğŸ«˜',categoria:'Mercearia'},
    {id:61,nome:'FeijÃ£o Preto Camil 1kg',emoji:'ğŸ«˜',categoria:'Mercearia'},
    {id:62,nome:'FeijÃ£o Carioca Mistura 500g',emoji:'ğŸ«˜',categoria:'Mercearia'},
    {id:278,nome:'FeijÃ£o Carioca Fazendeiro 1kg',emoji:'ğŸ«˜',categoria:'Mercearia'},
    {id:279,nome:'FeijÃ£o Verde Carioca 1kg',emoji:'ğŸ«˜',categoria:'Mercearia'},
    {id:280,nome:'Lentilha 500g',emoji:'ğŸ«˜',categoria:'Mercearia'},
    {id:281,nome:'GrÃ£o de Bico 500g',emoji:'ğŸ«˜',categoria:'Mercearia'},
    // AÃ‡ÃšCAR
    {id:63,nome:'AÃ§Ãºcar UniÃ£o Refinado 1kg',emoji:'ğŸ¬',categoria:'Mercearia'},
    {id:64,nome:'AÃ§Ãºcar UniÃ£o Cristal 1kg',emoji:'ğŸ¬',categoria:'Mercearia'},
    {id:65,nome:'AÃ§Ãºcar Caravelas 1kg',emoji:'ğŸ¬',categoria:'Mercearia'},
    {id:66,nome:'AÃ§Ãºcar Demerara 1kg',emoji:'ğŸ¬',categoria:'Mercearia'},
    {id:282,nome:'AÃ§Ãºcar UniÃ£o 5kg',emoji:'ğŸ¬',categoria:'Mercearia'},
    {id:283,nome:'AÃ§Ãºcar Cristal Caravelas 5kg',emoji:'ğŸ¬',categoria:'Mercearia'},
    // SAL
    {id:67,nome:'Sal Refinado Cisne 1kg',emoji:'ğŸ§‚',categoria:'Mercearia'},
    {id:68,nome:'Sal Grosso 1kg',emoji:'ğŸ§‚',categoria:'Mercearia'},
    {id:284,nome:'Sal Marinho Integral 500g',emoji:'ğŸ§‚',categoria:'Mercearia'},
    // CAFÃ‰
    {id:69,nome:'CafÃ© PilÃ£o Torrado 500g',emoji:'â˜•',categoria:'Mercearia'},
    {id:70,nome:'CafÃ© Melitta Extra Forte 500g',emoji:'â˜•',categoria:'Mercearia'},
    {id:71,nome:'CafÃ© 3 CoraÃ§Ãµes 500g',emoji:'â˜•',categoria:'Mercearia'},
    {id:72,nome:'CafÃ© PelÃ© 500g',emoji:'â˜•',categoria:'Mercearia'},
    {id:285,nome:'CafÃ© PilÃ£o Torrado 250g',emoji:'â˜•',categoria:'Mercearia'},
    {id:286,nome:'CafÃ© Caboclo 500g',emoji:'â˜•',categoria:'Mercearia'},
    {id:287,nome:'CafÃ© NescafÃ© SolÃºvel 100g',emoji:'â˜•',categoria:'Mercearia'},
    {id:344,nome:'CafÃ© PiatÃ£ Torrado Local 250g',emoji:'â˜•',categoria:'Mercearia'},
    {id:345,nome:'CafÃ© Rigno 500g',emoji:'â˜•',categoria:'Mercearia'},
    // FARINHA
    {id:73,nome:'Farinha de Trigo Dona Benta 1kg',emoji:'ğŸŒ¾',categoria:'Mercearia'},
    {id:74,nome:'Farinha de Trigo Anaconda 1kg',emoji:'ğŸŒ¾',categoria:'Mercearia'},
    {id:75,nome:'Farinha de Mandioca Crua 1kg',emoji:'ğŸŸ¤',categoria:'Mercearia'},
    {id:76,nome:'Farinha de Mandioca Torrada 1kg',emoji:'ğŸŸ¤',categoria:'Mercearia'},
    {id:77,nome:'FubÃ¡ Mimoso Quaker 1kg',emoji:'ğŸŒ½',categoria:'Mercearia'},
    {id:78,nome:'FubÃ¡ Yoki 1kg',emoji:'ğŸŒ½',categoria:'Mercearia'},
    {id:288,nome:'Farinha de Trigo Sol 1kg',emoji:'ğŸŒ¾',categoria:'Mercearia'},
    {id:289,nome:'Farinha de Rosca 500g',emoji:'ğŸŸ¤',categoria:'Mercearia'},
    {id:290,nome:'Amido de Milho Maisena 400g',emoji:'ğŸŒ½',categoria:'Mercearia'},
    // MACARRÃƒO
    {id:79,nome:'MacarrÃ£o Espaguete Renata 500g',emoji:'ğŸ',categoria:'Mercearia'},
    {id:80,nome:'MacarrÃ£o Parafuso Nissin 500g',emoji:'ğŸ',categoria:'Mercearia'},
    {id:81,nome:'MacarrÃ£o Cotovelo Adria 500g',emoji:'ğŸ',categoria:'Mercearia'},
    {id:82,nome:'MacarrÃ£o InstantÃ¢neo Nissin 85g',emoji:'ğŸœ',categoria:'Mercearia'},
    {id:83,nome:'MacarrÃ£o InstantÃ¢neo Miojo 85g',emoji:'ğŸœ',categoria:'Mercearia'},
    {id:291,nome:'MacarrÃ£o Espaguete Adria 500g',emoji:'ğŸ',categoria:'Mercearia'},
    {id:292,nome:'MacarrÃ£o Fusilli Barilla 500g',emoji:'ğŸ',categoria:'Mercearia'},
    {id:293,nome:'MacarrÃ£o Penne Barilla 500g',emoji:'ğŸ',categoria:'Mercearia'},
    // Ã“LEO
    {id:84,nome:'Ã“leo de Soja Liza 900ml',emoji:'ğŸ«™',categoria:'Mercearia'},
    {id:85,nome:'Ã“leo de Soja Soya 900ml',emoji:'ğŸ«™',categoria:'Mercearia'},
    {id:86,nome:'Ã“leo de Soja Cocamar 900ml',emoji:'ğŸ«™',categoria:'Mercearia'},
    {id:87,nome:'Azeite Gallo Extra Virgem 500ml',emoji:'ğŸ«’',categoria:'Mercearia'},
    {id:88,nome:'Azeite Carbonell 500ml',emoji:'ğŸ«’',categoria:'Mercearia'},
    {id:294,nome:'Ã“leo de Girassol Liza 900ml',emoji:'ğŸ«™',categoria:'Mercearia'},
    {id:295,nome:'Azeite Andorinha 500ml',emoji:'ğŸ«’',categoria:'Mercearia'},
    // MOLHOS E CONSERVAS
    {id:89,nome:'Molho de Tomate Pomarola 520g',emoji:'ğŸ…',categoria:'Mercearia'},
    {id:90,nome:'Molho de Tomate Quero 520g',emoji:'ğŸ…',categoria:'Mercearia'},
    {id:91,nome:'Extrato de Tomate Elefante 190g',emoji:'ğŸ…',categoria:'Mercearia'},
    {id:92,nome:'Sardinha Coqueiro 125g',emoji:'ğŸŸ',categoria:'Mercearia'},
    {id:93,nome:'Atum Gomes da Costa 170g',emoji:'ğŸ ',categoria:'Mercearia'},
    {id:94,nome:'Milho Verde Quero 200g',emoji:'ğŸŒ½',categoria:'Mercearia'},
    {id:95,nome:'Ervilha Quero 200g',emoji:'ğŸŸ¢',categoria:'Mercearia'},
    {id:296,nome:'Molho de Tomate Heinz 340g',emoji:'ğŸ…',categoria:'Mercearia'},
    {id:297,nome:'Catchup Heinz 397g',emoji:'ğŸ…',categoria:'Mercearia'},
    {id:298,nome:'Maionese Hellmanns 500g',emoji:'ğŸŸ¡',categoria:'Mercearia'},
    {id:299,nome:'Vinagre Castelo 750ml',emoji:'ğŸ«™',categoria:'Mercearia'},
    {id:300,nome:'Shoyu Kikkoman 150ml',emoji:'ğŸ¶',categoria:'Mercearia'},
    // LATICÃNIOS CAIXA
    {id:96,nome:'Leite em PÃ³ Ninho Integral 400g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    {id:97,nome:'Leite em PÃ³ ItambÃ© 400g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    {id:98,nome:'Leite Condensado MoÃ§a 395g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    {id:99,nome:'Leite Condensado ItambÃ© 395g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    {id:100,nome:'Creme de Leite NestlÃ© 200g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    {id:101,nome:'Creme de Leite Piracanjuba 200g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    {id:301,nome:'Leite em PÃ³ Ninho Forti+ 400g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    {id:302,nome:'Leite Condensado Campo Belo 395g',emoji:'ğŸ¥›',categoria:'Mercearia'},
    // ACHOCOLATADO E CEREAIS
    {id:102,nome:'Achocolatado Nescau 400g',emoji:'ğŸ«',categoria:'Mercearia'},
    {id:103,nome:'Achocolatado Toddy 400g',emoji:'ğŸ«',categoria:'Mercearia'},
    {id:104,nome:'Achocolatado Nescau 2kg',emoji:'ğŸ«',categoria:'Mercearia'},
    {id:105,nome:'Biscoito Recheado Oreo 120g',emoji:'ğŸª',categoria:'Mercearia'},
    {id:106,nome:'Biscoito Recheado Negresco 120g',emoji:'ğŸª',categoria:'Mercearia'},
    {id:107,nome:'Biscoito Recheado Trakinas 132g',emoji:'ğŸª',categoria:'Mercearia'},
    {id:108,nome:'Biscoito Cream Cracker Triunfo 200g',emoji:'ğŸ«™',categoria:'Mercearia'},
    {id:109,nome:'Biscoito Cream Cracker Adria 200g',emoji:'ğŸ«™',categoria:'Mercearia'},
    {id:110,nome:'Bolacha Maizena Isabela 200g',emoji:'ğŸª',categoria:'Mercearia'},
    {id:111,nome:'Aveia Quaker Flocos 500g',emoji:'ğŸŒ¾',categoria:'Mercearia'},
    {id:112,nome:'Granola Jasmine 500g',emoji:'ğŸŒ¾',categoria:'Mercearia'},
    {id:113,nome:'Fermento Royal 200g',emoji:'ğŸ§',categoria:'Mercearia'},
    {id:114,nome:'Gelatina Royal 250g',emoji:'ğŸŸ£',categoria:'Mercearia'},
    {id:115,nome:'Canjica Amarela 500g',emoji:'âšª',categoria:'Mercearia'},
    {id:303,nome:'Biscoito Maisena NestlÃ© 200g',emoji:'ğŸª',categoria:'Mercearia'},
    {id:304,nome:'Cereal Sucrilhos Kelloggs 300g',emoji:'ğŸŒ¾',categoria:'Mercearia'},
    // ğŸ¥© AÃ‡OUGUE
    {id:116,nome:'Patinho Bovino kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:117,nome:'Alcatra kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:118,nome:'Picanha kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:119,nome:'Fraldinha kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:120,nome:'AcÃ©m kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:121,nome:'MÃºsculo kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:122,nome:'Carne MoÃ­da Patinho kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:123,nome:'Carne MoÃ­da AcÃ©m kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:124,nome:'Frango Inteiro Congelado kg',emoji:'ğŸ—',categoria:'AÃ§ougue'},
    {id:125,nome:'Peito de Frango kg',emoji:'ğŸ—',categoria:'AÃ§ougue'},
    {id:126,nome:'Coxa e Sobrecoxa kg',emoji:'ğŸ—',categoria:'AÃ§ougue'},
    {id:127,nome:'Asa de Frango kg',emoji:'ğŸ—',categoria:'AÃ§ougue'},
    {id:128,nome:'FilÃ© de Frango kg',emoji:'ğŸ—',categoria:'AÃ§ougue'},
    {id:129,nome:'LinguiÃ§a PerdigÃ£o Calabresa kg',emoji:'ğŸŒ­',categoria:'AÃ§ougue'},
    {id:130,nome:'LinguiÃ§a Seara Toscana kg',emoji:'ğŸŒ­',categoria:'AÃ§ougue'},
    {id:131,nome:'LinguiÃ§a de Frango kg',emoji:'ğŸŒ­',categoria:'AÃ§ougue'},
    {id:132,nome:'Costela Bovina kg',emoji:'ğŸ¦´',categoria:'AÃ§ougue'},
    {id:133,nome:'Costela SuÃ­na kg',emoji:'ğŸ¦´',categoria:'AÃ§ougue'},
    {id:134,nome:'Bacon Fatiado Sadia kg',emoji:'ğŸ¥“',categoria:'AÃ§ougue'},
    {id:135,nome:'FÃ­gado Bovino kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:136,nome:'Moela de Frango kg',emoji:'ğŸ—',categoria:'AÃ§ougue'},
    {id:137,nome:'TilÃ¡pia FilÃ© kg',emoji:'ğŸŸ',categoria:'AÃ§ougue'},
    {id:138,nome:'CamarÃ£o kg',emoji:'ğŸ¦',categoria:'AÃ§ougue'},
    {id:305,nome:'Salsicha PerdigÃ£o 500g',emoji:'ğŸŒ­',categoria:'AÃ§ougue'},
    {id:306,nome:'Salsicha Sadia 500g',emoji:'ğŸŒ­',categoria:'AÃ§ougue'},
    {id:307,nome:'Salsicha Seara Hot Dog 500g',emoji:'ğŸŒ­',categoria:'AÃ§ougue'},
    {id:308,nome:'Salsicha de Frango PerdigÃ£o 500g',emoji:'ğŸŒ­',categoria:'AÃ§ougue'},
    {id:309,nome:'Carne de Sol kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:310,nome:'Charque Bovino 500g',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:311,nome:'Frango a Passarinho kg',emoji:'ğŸ—',categoria:'AÃ§ougue'},
    {id:312,nome:'Lombo SuÃ­no kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    {id:313,nome:'Paleta Bovina kg',emoji:'ğŸ¥©',categoria:'AÃ§ougue'},
    // ğŸ§€ FRIOS E LATICÃNIOS
    {id:139,nome:'Leite Integral Piracanjuba 1L',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:140,nome:'Leite Integral ItambÃ© 1L',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:141,nome:'Leite Integral BetÃ¢nia 1L',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:142,nome:'Leite Desnatado Piracanjuba 1L',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:143,nome:'Queijo Mussarela Fatiado kg',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    {id:144,nome:'Queijo Prato Fatiado kg',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    {id:145,nome:'Queijo Minas Frescal kg',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    {id:146,nome:'Presunto Sadia Fatiado kg',emoji:'ğŸ–',categoria:'LaticÃ­nios'},
    {id:147,nome:'Mortadela PerdigÃ£o kg',emoji:'ğŸ–',categoria:'LaticÃ­nios'},
    {id:148,nome:'RequeijÃ£o Catupiry 200g',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    {id:149,nome:'RequeijÃ£o NestlÃ© 200g',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    {id:150,nome:'Iogurte Integral Danone 170g',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:151,nome:'Iogurte Grego Danone 90g',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:314,nome:'Leite Integral Parmalat 1L',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:315,nome:'Manteiga com Sal AviaÃ§Ã£o 200g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:316,nome:'Manteiga com Sal ItambÃ© 200g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:317,nome:'Manteiga sem Sal 200g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:318,nome:'Margarina Qualy 500g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:319,nome:'Margarina Becel 500g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:320,nome:'Cream Cheese Philadelphia 150g',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    {id:321,nome:'Presunto de Frango Sadia kg',emoji:'ğŸ–',categoria:'LaticÃ­nios'},
    {id:322,nome:'Apresuntado PerdigÃ£o kg',emoji:'ğŸ–',categoria:'LaticÃ­nios'},
    {id:323,nome:'Iogurte Yopro Proteico 160g',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:324,nome:'Queijo Coalho kg',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    {id:152,nome:'Iogurte Natural Integral 170g',emoji:'ğŸ¥›',categoria:'LaticÃ­nios'},
    {id:153,nome:'Margarina Qualy 500g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:154,nome:'Margarina Becel 500g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:155,nome:'Manteiga Vigor com Sal 200g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:156,nome:'Manteiga AviaÃ§Ã£o sem Sal 200g',emoji:'ğŸ§ˆ',categoria:'LaticÃ­nios'},
    {id:157,nome:'Cream Cheese Philadelphia 150g',emoji:'ğŸ§€',categoria:'LaticÃ­nios'},
    // ğŸ¥¤ BEBIDAS
    {id:158,nome:'Coca-Cola 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:159,nome:'Coca-Cola Lata 350ml',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:160,nome:'Coca-Cola Zero 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:161,nome:'GuaranÃ¡ Antarctica 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:162,nome:'GuaranÃ¡ Antarctica Lata 350ml',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:163,nome:'Fanta Laranja 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:164,nome:'Pepsi 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:165,nome:'Sprite 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:166,nome:'Ãgua Mineral Crystal 1,5L',emoji:'ğŸ’§',categoria:'Bebidas'},
    {id:167,nome:'Ãgua Mineral IndaiÃ¡ 1,5L',emoji:'ğŸ’§',categoria:'Bebidas'},
    {id:168,nome:'Ãgua com GÃ¡s Lindoya 1L',emoji:'ğŸ’§',categoria:'Bebidas'},
    {id:169,nome:'Suco Del Valle Uva 1L',emoji:'ğŸ§ƒ',categoria:'Bebidas'},
    {id:170,nome:'Suco Tropicana Laranja 1L',emoji:'ğŸ§ƒ',categoria:'Bebidas'},
    {id:171,nome:'Suco Maguary MaracujÃ¡ 1L',emoji:'ğŸ§ƒ',categoria:'Bebidas'},
    {id:172,nome:'EnergÃ©tico Red Bull 250ml',emoji:'âš¡',categoria:'Bebidas'},
    {id:173,nome:'EnergÃ©tico Monster 473ml',emoji:'âš¡',categoria:'Bebidas'},
    {id:174,nome:'Cerveja Skol Lata 350ml',emoji:'ğŸº',categoria:'Bebidas'},
    {id:175,nome:'Cerveja Brahma Lata 350ml',emoji:'ğŸº',categoria:'Bebidas'},
    {id:176,nome:'Cerveja Itaipava Lata 350ml',emoji:'ğŸº',categoria:'Bebidas'},
    {id:177,nome:'Cerveja Heineken Long Neck 330ml',emoji:'ğŸº',categoria:'Bebidas'},
    {id:325,nome:'GuaranÃ¡ Jesus 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:326,nome:'Fanta Uva 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:327,nome:'Kuat 2L',emoji:'ğŸ¥¤',categoria:'Bebidas'},
    {id:328,nome:'Suco Ades Laranja 1L',emoji:'ğŸ§ƒ',categoria:'Bebidas'},
    {id:329,nome:'Limonada Pronta 500ml',emoji:'ğŸ‹',categoria:'Bebidas'},
    {id:330,nome:'Ãgua de Coco 1L',emoji:'ğŸ¥¥',categoria:'Bebidas'},
    {id:331,nome:'Vinho Tinto Seco 750ml',emoji:'ğŸ·',categoria:'Bebidas'},
    {id:332,nome:'Cerveja Budweiser Lata 350ml',emoji:'ğŸº',categoria:'Bebidas'},
    {id:333,nome:'Leite Integral Tirol 1L',emoji:'ğŸ¥›',categoria:'Bebidas'},
    // ğŸ« DOCES E GULOSEIMAS
    {id:178,nome:'Chocolate Lacta ao Leite 80g',emoji:'ğŸ«',categoria:'Doces'},
    {id:179,nome:'Chocolate NestlÃ© Kit Kat 42g',emoji:'ğŸ«',categoria:'Doces'},
    {id:180,nome:'Chocolate Bis Lacta 100g',emoji:'ğŸ«',categoria:'Doces'},
    {id:181,nome:'Chocolate Garoto ao Leite 80g',emoji:'ğŸ«',categoria:'Doces'},
    {id:182,nome:'Bombom Sonho de Valsa 200g',emoji:'ğŸ¬',categoria:'Doces'},
    {id:183,nome:'PaÃ§oca Rolha Santa Helena 50g',emoji:'ğŸŸ¤',categoria:'Doces'},
    {id:184,nome:'PÃ© de Moleque Barra 100g',emoji:'ğŸŸ¤',categoria:'Doces'},
    {id:185,nome:'Doce de Leite ItambÃ© 400g',emoji:'ğŸ¯',categoria:'Doces'},
    {id:186,nome:'Goiabada Predilecta 300g',emoji:'ğŸŸ¥',categoria:'Doces'},
    {id:187,nome:'Cocada Branca 200g',emoji:'ğŸ¥¥',categoria:'Doces'},
    {id:188,nome:'Marshmallow Fini 250g',emoji:'â¬œ',categoria:'Doces'},
    {id:334,nome:'Bala Fini 100g',emoji:'ğŸ¬',categoria:'Doces'},
    {id:335,nome:'Pirulito Chupa Chups un',emoji:'ğŸ­',categoria:'Doces'},
    {id:336,nome:'Chiclete Trident 8un',emoji:'ğŸ¬',categoria:'Doces'},
    // ğŸ§¼ LIMPEZA
    {id:189,nome:'SabÃ£o em PÃ³ OMO 1kg',emoji:'ğŸ§º',categoria:'Limpeza'},
    {id:190,nome:'SabÃ£o em PÃ³ Ariel 1kg',emoji:'ğŸ§º',categoria:'Limpeza'},
    {id:191,nome:'SabÃ£o em PÃ³ YpÃª 1kg',emoji:'ğŸ§º',categoria:'Limpeza'},
    {id:192,nome:'SabÃ£o LÃ­quido OMO 1L',emoji:'ğŸ«§',categoria:'Limpeza'},
    {id:193,nome:'Amaciante Comfort 1L',emoji:'ğŸŒ¸',categoria:'Limpeza'},
    {id:194,nome:'Amaciante Downy 1L',emoji:'ğŸŒ¸',categoria:'Limpeza'},
    {id:195,nome:'Detergente YpÃª Neutro 500ml',emoji:'ğŸ«§',categoria:'Limpeza'},
    {id:196,nome:'Detergente Limpol 500ml',emoji:'ğŸ«§',categoria:'Limpeza'},
    {id:197,nome:'Ãgua SanitÃ¡ria Qboa 1L',emoji:'ğŸ§´',categoria:'Limpeza'},
    {id:198,nome:'Desinfetante Pinho Sol 1L',emoji:'ğŸ§´',categoria:'Limpeza'},
    {id:199,nome:'Esponja Bombril Limpeza 3 un',emoji:'ğŸŸ¨',categoria:'Limpeza'},
    {id:200,nome:'Palha de AÃ§o Bombril 8 un',emoji:'ğŸŸ¡',categoria:'Limpeza'},
    {id:201,nome:'Multiuso Mr. MÃºsculo 500ml',emoji:'ğŸ§¹',categoria:'Limpeza'},
    {id:202,nome:'Ãlcool LÃ­quido Ingleza 70% 1L',emoji:'ğŸ§´',categoria:'Limpeza'},
    {id:203,nome:'Ãlcool Gel 70% 500ml',emoji:'ğŸ§´',categoria:'Limpeza'},
    {id:337,nome:'SabÃ£o em PÃ³ Brilhante 1kg',emoji:'ğŸ§º',categoria:'Limpeza'},
    {id:338,nome:'Lava Roupas Omo LÃ­quido 2L',emoji:'ğŸ«§',categoria:'Limpeza'},
    {id:339,nome:'Amaciante Fofo 2L',emoji:'ğŸŒ¸',categoria:'Limpeza'},
    {id:340,nome:'Detergente Minuano 500ml',emoji:'ğŸ«§',categoria:'Limpeza'},
    {id:341,nome:'Desinfetante Flora 1L',emoji:'ğŸ§´',categoria:'Limpeza'},
    {id:342,nome:'Ãgua SanitÃ¡ria Ype 1L',emoji:'ğŸ§´',categoria:'Limpeza'},
    {id:343,nome:'Brilhante Desincrustante 500ml',emoji:'ğŸ§¹',categoria:'Limpeza'},
    // ğŸ§´ HIGIENE PESSOAL
    {id:204,nome:'Sabonete Dove Hidratante 90g',emoji:'ğŸ§¼',categoria:'Higiene'},
    {id:205,nome:'Sabonete Lux 90g',emoji:'ğŸ§¼',categoria:'Higiene'},
    {id:206,nome:'Sabonete Palmolive 90g',emoji:'ğŸ§¼',categoria:'Higiene'},
    {id:207,nome:'Shampoo Seda Ceramidas 325ml',emoji:'ğŸ§´',categoria:'Higiene'},
    {id:208,nome:'Shampoo Pantene 400ml',emoji:'ğŸ§´',categoria:'Higiene'},
    {id:209,nome:'Shampoo Head Shoulders 200ml',emoji:'ğŸ§´',categoria:'Higiene'},
    {id:210,nome:'Condicionador Seda 325ml',emoji:'ğŸ§´',categoria:'Higiene'},
    {id:211,nome:'Condicionador Pantene 400ml',emoji:'ğŸ§´',categoria:'Higiene'},
    {id:212,nome:'Pasta Colgate Tripla AÃ§Ã£o 90g',emoji:'ğŸ¦·',categoria:'Higiene'},
    {id:213,nome:'Pasta Oral-B 70g',emoji:'ğŸ¦·',categoria:'Higiene'},
    {id:214,nome:'Pasta Sorriso 90g',emoji:'ğŸ¦·',categoria:'Higiene'},
    {id:215,nome:'Escova Dental Colgate 1un',emoji:'ğŸª¥',categoria:'Higiene'},
    {id:216,nome:'Desodorante Rexona Roll-On 50ml',emoji:'ğŸŒ¸',categoria:'Higiene'},
    {id:217,nome:'Desodorante Dove Spray 150ml',emoji:'ğŸŒ¸',categoria:'Higiene'},
    {id:218,nome:'Desodorante NÃ­vea Roll-On 50ml',emoji:'ğŸŒ¸',categoria:'Higiene'},
    {id:219,nome:'Papel HigiÃªnico Neve 4 rolos',emoji:'ğŸ§»',categoria:'Higiene'},
    {id:220,nome:'Papel HigiÃªnico Personal 4 rolos',emoji:'ğŸ§»',categoria:'Higiene'},
    {id:221,nome:'Papel HigiÃªnico Snob 4 rolos',emoji:'ğŸ§»',categoria:'Higiene'},
    {id:346,nome:'Papel HigiÃªnico Paloma 4 rolos',emoji:'ğŸ§»',categoria:'Higiene'},
    {id:347,nome:'Papel HigiÃªnico Paloma 12 rolos',emoji:'ğŸ§»',categoria:'Higiene'},
    {id:222,nome:'Absorvente Always com Abas 8un',emoji:'ğŸ’œ',categoria:'Higiene'},
    {id:223,nome:'Absorvente Intimus 8un',emoji:'ğŸ’œ',categoria:'Higiene'},
    {id:224,nome:'Fralda Pampers P 28un',emoji:'ğŸ‘¶',categoria:'Higiene'},
    {id:225,nome:'Fralda Pampers M 26un',emoji:'ğŸ‘¶',categoria:'Higiene'},
    {id:226,nome:'Fralda Huggies M 24un',emoji:'ğŸ‘¶',categoria:'Higiene'},
    {id:227,nome:'Creme NÃ­vea Hidratante 200ml',emoji:'ğŸ§´',categoria:'Higiene'},
    {id:228,nome:'LÃ¢mina Gillette Prestobarba 2un',emoji:'ğŸª’',categoria:'Higiene'},
    // ğŸ¥– PADARIA
    {id:229,nome:'PÃ£o FrancÃªs kg',emoji:'ğŸ¥–',categoria:'Padaria'},
    {id:230,nome:'PÃ£o de Forma Wickbold 500g',emoji:'ğŸ',categoria:'Padaria'},
    {id:231,nome:'PÃ£o de Forma Nutrella 500g',emoji:'ğŸ',categoria:'Padaria'},
    {id:232,nome:'PÃ£o Integral Seven Boys 500g',emoji:'ğŸ',categoria:'Padaria'},
    {id:233,nome:'PÃ£o Hot Dog 8un',emoji:'ğŸŒ­',categoria:'Padaria'},
    {id:234,nome:'PÃ£o HambÃºrguer 8un',emoji:'ğŸ”',categoria:'Padaria'},
    {id:235,nome:'Bolo de Milho un',emoji:'ğŸ‚',categoria:'Padaria'},
    {id:236,nome:'Sonho recheado un',emoji:'ğŸ©',categoria:'Padaria'},
    {id:237,nome:'Salgado Assado un',emoji:'ğŸ¥',categoria:'Padaria'},
    {id:238,nome:'Salgado Frito un',emoji:'ğŸ¥Ÿ',categoria:'Padaria'},
    // ğŸ³ CONGELADOS
    {id:239,nome:'Pizza Sadia Mussarela 460g',emoji:'ğŸ•',categoria:'Congelados'},
    {id:240,nome:'Pizza Seara Calabresa 460g',emoji:'ğŸ•',categoria:'Congelados'},
    {id:241,nome:'HambÃºrguer Sadia 672g 12un',emoji:'ğŸ”',categoria:'Congelados'},
    {id:242,nome:'HambÃºrguer PerdigÃ£o 672g 12un',emoji:'ğŸ”',categoria:'Congelados'},
    {id:243,nome:'Nuggets de Frango Sadia 300g',emoji:'ğŸ—',categoria:'Congelados'},
    {id:244,nome:'Nuggets de Frango Seara 300g',emoji:'ğŸ—',categoria:'Congelados'},
    {id:245,nome:'Lasanha Bolonhesa Sadia 600g',emoji:'ğŸ«•',categoria:'Congelados'},
    {id:246,nome:'Lasanha Frango Sadia 600g',emoji:'ğŸ«•',categoria:'Congelados'},
    {id:247,nome:'Batata Frita McCain 400g',emoji:'ğŸŸ',categoria:'Congelados'},
    {id:248,nome:'AÃ§aÃ­ Polpa Nativo 1kg',emoji:'ğŸ’œ',categoria:'Congelados'},
    {id:249,nome:'AÃ§aÃ­ Polpa Sambazon 400g',emoji:'ğŸ’œ',categoria:'Congelados'},
    {id:250,nome:'Sorvete Kibon Pote Chocolate 1,5L',emoji:'ğŸ¦',categoria:'Congelados'},
    {id:251,nome:'Sorvete Kibon Pote Morango 1,5L',emoji:'ğŸ¦',categoria:'Congelados'},
    {id:252,nome:'Sorvete NestlÃ© Pote Napolitano 1,5L',emoji:'ğŸ¦',categoria:'Congelados'},
    {id:253,nome:'PicolÃ© Kibon Chocolate un',emoji:'ğŸ¦',categoria:'Congelados'},
    {id:254,nome:'PicolÃ© Kibon LimÃ£o un',emoji:'ğŸ¦',categoria:'Congelados'},
    {id:255,nome:'PicolÃ© Magnum un',emoji:'ğŸ«',categoria:'Congelados'},
    {id:256,nome:'Polpa Morango 1kg',emoji:'ğŸ§Š',categoria:'Congelados'},
    {id:257,nome:'Polpa MaracujÃ¡ 1kg',emoji:'ğŸ§Š',categoria:'Congelados'},
    // ğŸ½ï¸ UTILIDADES DOMÃ‰STICAS
    {id:258,nome:'Papel AlumÃ­nio Wyda 30cm 30m',emoji:'ğŸª™',categoria:'Utilidades'},
    {id:259,nome:'Papel Manteiga 25cm',emoji:'ğŸ”²',categoria:'Utilidades'},
    {id:260,nome:'Saco de Lixo 100L 10un',emoji:'ğŸ—‘ï¸',categoria:'Utilidades'},
    {id:261,nome:'Saco de Lixo 60L 10un',emoji:'ğŸ—‘ï¸',categoria:'Utilidades'},
    {id:262,nome:'Guardanapo de Papel 50un',emoji:'ğŸ¤',categoria:'Utilidades'},
    {id:263,nome:'Copo DescartÃ¡vel 200ml 50un',emoji:'ğŸ¥¤',categoria:'Utilidades'},
    {id:264,nome:'Prato DescartÃ¡vel 15cm 10un',emoji:'ğŸ½ï¸',categoria:'Utilidades'},
    {id:265,nome:'FÃ³sforo 40 palitos',emoji:'ğŸ”¥',categoria:'Utilidades'},
    {id:266,nome:'Pilha AA Duracell 2un',emoji:'ğŸ”‹',categoria:'Utilidades'},
    {id:267,nome:'Pilha AA Philips 4un',emoji:'ğŸ”‹',categoria:'Utilidades'},
    // ğŸ’„ COSMÃ‰TICOS E BELEZA
    {id:268,nome:'Batom Maybelline un',emoji:'ğŸ’„',categoria:'CosmÃ©ticos'},
    {id:269,nome:'Batom Avon un',emoji:'ğŸ’„',categoria:'CosmÃ©ticos'},
    {id:270,nome:'Batom Natura un',emoji:'ğŸ’„',categoria:'CosmÃ©ticos'},
    {id:271,nome:'Base Maybelline Fit Me 30ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:272,nome:'Base L\'OrÃ©al True Match 30ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:273,nome:'PÃ³ Compacto Maybelline un',emoji:'ğŸª',categoria:'CosmÃ©ticos'},
    {id:274,nome:'PÃ³ Compacto Avon un',emoji:'ğŸª',categoria:'CosmÃ©ticos'},
    {id:275,nome:'RÃ­mel Maybelline Lash Sensational un',emoji:'ğŸ‘ï¸',categoria:'CosmÃ©ticos'},
    {id:276,nome:'RÃ­mel Avon Super Extend un',emoji:'ğŸ‘ï¸',categoria:'CosmÃ©ticos'},
    {id:277,nome:'Delineador Dailus un',emoji:'âœï¸',categoria:'CosmÃ©ticos'},
    {id:278,nome:'Sombra Jasmyne un',emoji:'ğŸ¨',categoria:'CosmÃ©ticos'},
    {id:279,nome:'Paleta de Sombras Ruby Rose un',emoji:'ğŸ¨',categoria:'CosmÃ©ticos'},
    {id:280,nome:'Blush Avon un',emoji:'ğŸŒ¸',categoria:'CosmÃ©ticos'},
    {id:281,nome:'Iluminador Dailus un',emoji:'âœ¨',categoria:'CosmÃ©ticos'},
    {id:282,nome:'Primer Facial L\'OrÃ©al un',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:283,nome:'Corretivo Maybelline Instant Age un',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:284,nome:'Demaquilante Nivea 200ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:285,nome:'Demaquilante BifÃ¡sico OcÃ©ane 120ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:286,nome:'Esmalte RisquÃ© un',emoji:'ğŸ’…',categoria:'CosmÃ©ticos'},
    {id:287,nome:'Esmalte Colorama un',emoji:'ğŸ’…',categoria:'CosmÃ©ticos'},
    {id:288,nome:'Esmalte OPI un',emoji:'ğŸ’…',categoria:'CosmÃ©ticos'},
    {id:289,nome:'Acetona Kolene 100ml',emoji:'ğŸ’§',categoria:'CosmÃ©ticos'},
    {id:290,nome:'Creme Facial Nivea Antissinais 50ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:291,nome:'Protetor Solar Episol FPS50 120ml',emoji:'â˜€ï¸',categoria:'CosmÃ©ticos'},
    {id:292,nome:'Protetor Solar Sundown FPS50 200ml',emoji:'â˜€ï¸',categoria:'CosmÃ©ticos'},
    {id:293,nome:'Protetor Solar Neutrogena FPS70 200ml',emoji:'â˜€ï¸',categoria:'CosmÃ©ticos'},
    {id:294,nome:'Hidratante Corporal Nivea 400ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:295,nome:'Hidratante Corporal Dove 400ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:296,nome:'Perfume Feminino Natura una 75ml',emoji:'ğŸŒº',categoria:'CosmÃ©ticos'},
    {id:297,nome:'Perfume Masculino Natura Humor 75ml',emoji:'ğŸŒ¿',categoria:'CosmÃ©ticos'},
    {id:298,nome:'ColÃ´nia Avon un',emoji:'ğŸ§ª',categoria:'CosmÃ©ticos'},
    {id:299,nome:'Creme para Cabelo Salon Line 300g',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:300,nome:'MÃ¡scara Capilar Elseve 300ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:301,nome:'Ã“leo Capilar Wella 30ml',emoji:'ğŸ’§',categoria:'CosmÃ©ticos'},
    {id:302,nome:'Creme para Pentear Novex 300g',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:303,nome:'Gel Capilar Fixador Taft 250ml',emoji:'ğŸ§´',categoria:'CosmÃ©ticos'},
    {id:304,nome:'Tintura de Cabelo Garnier un',emoji:'ğŸ¨',categoria:'CosmÃ©ticos'},
    {id:305,nome:'Tintura de Cabelo L\'OrÃ©al Excellence un',emoji:'ğŸ¨',categoria:'CosmÃ©ticos'},
    {id:306,nome:'Tintura de Cabelo Igora un',emoji:'ğŸ¨',categoria:'CosmÃ©ticos'},
    {id:307,nome:'PinÃ§a de Sobrancelha un',emoji:'âœ‚ï¸',categoria:'CosmÃ©ticos'},
    {id:308,nome:'Espelho de Bolso un',emoji:'ğŸª',categoria:'CosmÃ©ticos'},
    {id:309,nome:'AlgodÃ£o Johnson 50g',emoji:'â˜ï¸',categoria:'CosmÃ©ticos'},
    {id:310,nome:'Cotonete Johnson 75un',emoji:'ğŸª¥',categoria:'CosmÃ©ticos'},
    // ğŸ§¼ LIMPEZA EXTRA
    {id:311,nome:'Limpa Vidros Windex 500ml',emoji:'ğŸªŸ',categoria:'Limpeza'},
    {id:312,nome:'Tira Manchas Vanish 450g',emoji:'ğŸ§º',categoria:'Limpeza'},
    {id:313,nome:'Cera Squeeze Johnson 200ml',emoji:'âœ¨',categoria:'Limpeza'},
    {id:314,nome:'Desentupidor Liquido Destampou 500ml',emoji:'ğŸš¿',categoria:'Limpeza'},
    {id:315,nome:'Inseticida Raid Aerosol 300ml',emoji:'ğŸ›',categoria:'Limpeza'},
    {id:316,nome:'Repelente Off 200ml',emoji:'ğŸ¦Ÿ',categoria:'Limpeza'},
    {id:317,nome:'SabÃ£o de Coco em Pedra 200g',emoji:'ğŸ§¼',categoria:'Limpeza'},
    {id:318,nome:'Pano de Prato Kala 3un',emoji:'ğŸ§¹',categoria:'Limpeza'},
    {id:319,nome:'Vassoura Dupla AÃ§Ã£o un',emoji:'ğŸ§¹',categoria:'Limpeza'},
    {id:320,nome:'Rodo 60cm un',emoji:'ğŸ§¹',categoria:'Limpeza'},
  ],
  precos:[
    // Arroz Camil 5kg (id:53)
    {produtoId:53,mercadoId:1,preco:27.90,dataAtu:'15/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:53,mercadoId:2,preco:25.50,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:53,mercadoId:3,preco:28.00,dataAtu:'10/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Arroz Tio JoÃ£o 5kg (id:55)
    {produtoId:55,mercadoId:1,preco:26.90,dataAtu:'15/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:55,mercadoId:2,preco:24.99,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    // FeijÃ£o Carioca Camil 1kg (id:59)
    {produtoId:59,mercadoId:1,preco:8.90,dataAtu:'15/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:59,mercadoId:2,preco:7.99,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:59,mercadoId:3,preco:9.50,dataAtu:'08/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // FeijÃ£o Kicaldo 1kg (id:60)
    {produtoId:60,mercadoId:2,preco:8.49,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    // Leite Integral Piracanjuba 1L (id:139)
    {produtoId:139,mercadoId:1,preco:5.49,dataAtu:'20/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:139,mercadoId:2,preco:4.99,dataAtu:'20/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:139,mercadoId:3,preco:5.20,dataAtu:'12/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Leite BetÃ¢nia 1L (id:141)
    {produtoId:141,mercadoId:1,preco:5.29,dataAtu:'20/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:141,mercadoId:4,preco:5.80,dataAtu:'01/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Ã“leo Liza 900ml (id:84)
    {produtoId:84,mercadoId:1,preco:7.50,dataAtu:'16/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:84,mercadoId:2,preco:6.99,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:84,mercadoId:3,preco:7.80,dataAtu:'07/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // AÃ§Ãºcar UniÃ£o Refinado 1kg (id:63)
    {produtoId:63,mercadoId:1,preco:4.20,dataAtu:'16/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:63,mercadoId:2,preco:3.89,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:63,mercadoId:3,preco:4.50,dataAtu:'09/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // CafÃ© PilÃ£o 500g (id:69)
    {produtoId:69,mercadoId:1,preco:18.90,dataAtu:'16/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:69,mercadoId:2,preco:16.50,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:69,mercadoId:3,preco:17.50,dataAtu:'10/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // CafÃ© 3 CoraÃ§Ãµes 500g (id:71)
    {produtoId:71,mercadoId:2,preco:15.90,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    // MacarrÃ£o Espaguete Renata 500g (id:79)
    {produtoId:79,mercadoId:1,preco:4.20,dataAtu:'16/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:79,mercadoId:2,preco:3.89,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:79,mercadoId:3,preco:4.00,dataAtu:'11/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Patinho Bovino kg (id:116)
    {produtoId:116,mercadoId:1,preco:39.90,dataAtu:'19/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:116,mercadoId:2,preco:36.50,dataAtu:'19/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:116,mercadoId:4,preco:34.00,dataAtu:'03/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Frango Inteiro Congelado kg (id:124)
    {produtoId:124,mercadoId:1,preco:18.90,dataAtu:'19/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:124,mercadoId:2,preco:16.99,dataAtu:'19/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:124,mercadoId:3,preco:17.50,dataAtu:'13/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Banana Prata kg (id:1)
    {produtoId:1,mercadoId:1,preco:4.50,dataAtu:'20/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:1,mercadoId:2,preco:3.99,dataAtu:'20/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:1,mercadoId:4,preco:3.50,dataAtu:'18/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Tomate Salada kg (id:35)
    {produtoId:35,mercadoId:1,preco:6.90,dataAtu:'19/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:35,mercadoId:2,preco:5.99,dataAtu:'19/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:35,mercadoId:4,preco:5.50,dataAtu:'15/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Cebola Branca kg (id:37)
    {produtoId:37,mercadoId:1,preco:3.90,dataAtu:'18/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:37,mercadoId:2,preco:3.49,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    // Coca-Cola 2L (id:158)
    {produtoId:158,mercadoId:1,preco:9.90,dataAtu:'17/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:158,mercadoId:2,preco:8.99,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:158,mercadoId:3,preco:10.50,dataAtu:'10/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Papel HigiÃªnico Neve 4 rolos (id:219)
    {produtoId:219,mercadoId:1,preco:6.90,dataAtu:'15/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:219,mercadoId:2,preco:5.99,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    // PÃ£o FrancÃªs kg (id:229)
    {produtoId:229,mercadoId:1,preco:9.90,dataAtu:'20/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:229,mercadoId:3,preco:8.50,dataAtu:'19/02/2025',fonte:'mercado',autor:'Mini Mercado da PraÃ§a'},
    // Sorvete Kibon Pote Chocolate 1,5L (id:250)
    {produtoId:250,mercadoId:2,preco:28.90,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:250,mercadoId:3,preco:25.00,dataAtu:'12/02/2025',fonte:'app',autor:'PreÃ§oCerto'},
    // Sorvete Kibon Pote Morango 1,5L (id:251)
    {produtoId:251,mercadoId:2,preco:27.90,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    // Creme de Leite NestlÃ© 200g (id:100)
    {produtoId:100,mercadoId:1,preco:4.90,dataAtu:'16/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:100,mercadoId:2,preco:4.49,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    // Sabonete Dove 90g (id:204)
    {produtoId:204,mercadoId:2,preco:3.49,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
    {produtoId:204,mercadoId:1,preco:3.90,dataAtu:'15/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    // Farinha Dona Benta 1kg (id:73)
    {produtoId:73,mercadoId:1,preco:5.90,dataAtu:'16/02/2025',fonte:'mercado',autor:'Mercado SÃ£o JoÃ£o'},
    {produtoId:73,mercadoId:2,preco:5.50,dataAtu:'18/02/2025',fonte:'mercado',autor:'Supermercado PiatÃ£'},
  ],
  promocoes:[
    {id:1,produtoId:69,mercadoId:2,precoPromo:13.90,precoNormal:16.50,validade:'28/02/2025',descricao:'Oferta de fim de mÃªs! CafÃ© PilÃ£o 500g',ativa:true},
    {id:2,produtoId:139,mercadoId:1,precoPromo:3.99,precoNormal:5.49,validade:'25/02/2025',descricao:'LiquidaÃ§Ã£o do leite! Piracanjuba 1L',ativa:true},
  ],
  historico:[
    {produtoId:53,mercadoId:2,preco:27.90,data:'Nov/24',fonte:'mercado'},{produtoId:53,mercadoId:2,preco:26.50,data:'Dez/24',fonte:'mercado'},{produtoId:53,mercadoId:2,preco:25.90,data:'Jan/25',fonte:'mercado'},{produtoId:53,mercadoId:2,preco:25.50,data:'Fev/25',fonte:'mercado'},
    {produtoId:139,mercadoId:1,preco:5.90,data:'Nov/24',fonte:'mercado'},{produtoId:139,mercadoId:1,preco:5.70,data:'Dez/24',fonte:'mercado'},{produtoId:139,mercadoId:1,preco:5.49,data:'Jan/25',fonte:'mercado'},{produtoId:139,mercadoId:1,preco:5.49,data:'Fev/25',fonte:'mercado'},
  ],
  contribuicoes:[],
  solicitacoes:[],
  clientes:[
    {id:1,nome:'Teste',login:'teste',_pwd:'1234',email:'teste@precocerto.app',telefone:'(75) 99999-0000',bairro:'Centro',foto:null,aceitouTermos:true,dataAceite:'24/02/2025',dataCadastro:'24/02/2025',bloqueado:false,motivoBloqueio:'',errosConsecutivos:0,totalContribuicoes:0,contribuicoesRejeitadas:0,ip:'127.0.0.1',emailVerificado:true}
  ],
  suporteChats:[],
  ocorrencias:[],
  logs:[]
};

// ===== FRESHNESS =====
function freshnessInfo(dataStr){
  if(!dataStr)return{cls:'old',txt:'Sem data'};
  const[d,m,y]=dataStr.split('/').map(Number);
  const data=new Date(y,m-1,d);
  const diff=Math.floor((new Date()-data)/(1000*60*60*24));
  if(diff<=7)return{cls:'fresh',txt:`${diff===0?'hoje':diff===1?'ontem':diff+' dias'}`};
  if(diff<=30)return{cls:'medium',txt:`${Math.floor(diff/7)} sem.`};
  return{cls:'old',txt:`${Math.floor(diff/30)} mes.`};
}
function freshnessHTML(dataStr){
  const f=freshnessInfo(dataStr);
  return`<span class="freshness ${f.cls}">Atualizado ${f.txt}</span>`;
}
function fonteHTML(fonte,autor){
  if(fonte==='app'||autor==='PreÃ§oCerto')return`<span class="fonte-badge fonte-app">ğŸ” PreÃ§oCerto</span>`;
  const map={admin:['âš™ï¸ Admin','fonte-admin'],mercado:['ğŸª Mercado','fonte-mercado'],cliente:['ğŸ‘¤ Cliente','fonte-cliente'],aprovado:['âœ… Aprovado','fonte-aprovado']};
  const[label,cls]=map[fonte]||['?',''];
  return`<span class="fonte-badge ${cls}">${label}</span>`;
}

// ===== TOAST =====
let toastTimer;
function showToast(msg,icon='âœ…'){
  document.getElementById('toastMsg').textContent=msg;
  document.getElementById('toastIcon').textContent=icon;
  const t=document.getElementById('toast');
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),3000);
}

// ===== MODAL =====
function abrirModal(id){document.getElementById(id).classList.add('show');}
function fecharModal(id){document.getElementById(id).classList.remove('show');}

// ===== LOGIN =====
function setLoginTab(tab){
  loginTabAtiva=tab;
  document.getElementById('loginAdminForm').style.display=tab==='admin'?'block':'none';
  // Recarregar dados privados ao abrir tab solicitaÃ§Ãµes ou clientes
  if((tab==='solicitacoes'||tab==='clientes'||tab==='contribuicoes'||tab==='ocorrencias') && adminLogado){
    carregarDadosAdmin().catch(()=>{});
  }
  document.getElementById('loginMercadoForm').style.display=tab==='mercado'?'block':'none';
}
function toggleAdminLogin(){
  const el=document.getElementById('loginAdminForm');
  el.style.display=el.style.display==='block'?'none':'block';
  if(el.style.display==='block') document.getElementById('loginMercadoForm').style.display='none';
}
function processarFotoPerfil(ev){
  const file=ev.target.files[0]; if(!file)return;
  const r=new FileReader();
  r.onload=e=>{
    perfilFoto=e.target.result;
    // Atualiza preview na tela login
    document.getElementById('fotoPerfilImg').src=perfilFoto;
    document.getElementById('fotoPerfilImg').style.display='block';
    document.getElementById('fotoPerfilEmoji').style.display='none';
    // Atualiza avatar na home
    sincronizarAvatar();
    showToast('Foto de perfil atualizada!','ğŸ“¸');
  };
  r.readAsDataURL(file);
}
// ===== CLIENTE HELPERS =====
function entrarSemCadastro(){
  clienteLogado=null;
  perfilNome='Visitante';
  sincronizarAvatar();
  irPara('home');
}

function verificarBloqueio(){
  if(!clienteLogado) return false;
  return clienteLogado.bloqueado;
}

function registrarErroContribuicao(clienteId, motivo){
  const c=db.clientes.find(x=>x.id===clienteId);
  if(!c) return;
  c.errosConsecutivos=(c.errosConsecutivos||0)+1;
  c.contribuicoesRejeitadas=(c.contribuicoesRejeitadas||0)+1;
  if(c.errosConsecutivos>=3 && !c.bloqueado){
    c.bloqueado=true;
    c.motivoBloqueio=`Bloqueado automaticamente: ${c.errosConsecutivos} contribuiÃ§Ãµes rejeitadas consecutivas. Ãšltimo motivo: ${motivo}`;
    c.dataBloqueio=hoje();
    // Atualiza estado atual se for o cliente logado
    if(clienteLogado&&clienteLogado.id===clienteId) clienteLogado=c;
    showToast('âš ï¸ Conta bloqueada apÃ³s 3 erros consecutivos. Aguarde revisÃ£o do admin.','ğŸ”’');
    return true; // bloqueado agora
  }
  const restantes=3-(c.errosConsecutivos||0);
  showToast(`ContribuiÃ§Ã£o rejeitada. AtenÃ§Ã£o: ${restantes} tentativa(s) restante(s) antes do bloqueio.`,'âš ï¸');
  return false;
}

function registrarSucessoContribuicao(clienteId){
  const c=db.clientes.find(x=>x.id===clienteId);
  if(!c) return;
  c.errosConsecutivos=0; // Reseta erros consecutivos ao acertar
  c.totalContribuicoes=(c.totalContribuicoes||0)+1;
}

async function desbloquearCliente(clienteId){
  try {
    await apiReq('PATCH',`/api/admin/clientes/${clienteId}/desbloquear`,{});
    showToast('Conta desbloqueada! âœ…','âœ…');
    await carregarDadosAdmin();
    renderAdminForm();
  } catch(e) {
    showToast('Erro ao desbloquear: '+e.message,'âŒ');
  }
}

// â”€â”€ Editar dados do cliente (admin)
function abrirEditarCliente(clienteId){
  const c=db.clientes.find(x=>String(x._id||x.id)===String(clienteId));
  if(!c) return;

  // Modal inline via prompt encadeado
  const novoNome  = prompt(`âœï¸ Nome atual: "${c.nome}"\n\nNovo nome (ou deixe igual):`, c.nome);
  if(novoNome===null) return;
  const novoEmail = prompt(`âœ‰ï¸ E-mail atual: "${c.email||''}"\n\nNovo e-mail (ou deixe igual):`, c.email||'');
  if(novoEmail===null) return;
  const novoBairro= prompt(`ğŸ“ Bairro atual: "${c.bairro||''}"\n\nNovo bairro (ou deixe igual):`, c.bairro||'');
  if(novoBairro===null) return;

  const upd={};
  if(novoNome.trim()   && novoNome.trim()!==c.nome)    upd.nome   = novoNome.trim();
  if(novoEmail.trim()  && novoEmail.trim()!==c.email)   upd.email  = novoEmail.trim();
  if(novoBairro.trim() && novoBairro.trim()!==c.bairro) upd.bairro = novoBairro.trim();

  if(!Object.keys(upd).length){ showToast('Nenhuma alteraÃ§Ã£o feita','â„¹ï¸'); return; }

  apiReq('PATCH',`/api/admin/clientes/${clienteId}/editar`, upd)
    .then(()=>{
      Object.assign(c, upd);
      showToast(`Dados de ${c.nome} atualizados! âœ…`,'âœ…');
      renderAdminForm();
    })
    .catch(e=>showToast('Erro: '+e.message,'âŒ'));
}

// â”€â”€ Alterar senha do cliente (admin, sem precisar da senha atual)
function abrirAlterarSenhaCliente(clienteId){
  const c=db.clientes.find(x=>String(x._id||x.id)===String(clienteId));
  if(!c) return;
  const nova=prompt(`ğŸ”‘ Definir nova senha para ${c.nome}\n\nMÃ­nimo 6 caracteres:`);
  if(!nova||nova.length<6){ if(nova!==null) showToast('Senha deve ter pelo menos 6 caracteres','âš ï¸'); return; }
  const conf=prompt('Confirme a nova senha:');
  if(nova!==conf){ showToast('Senhas nÃ£o coincidem!','âš ï¸'); return; }

  apiReq('PATCH',`/api/admin/clientes/${clienteId}/senha`,{novaSenha:nova})
    .then(()=>showToast(`Senha de ${c.nome} alterada com sucesso! âœ…`,'ğŸ”‘'))
    .catch(e=>showToast('Erro: '+e.message,'âŒ'));
}



async function banirClienteTemp(clienteId){
  const c=db.clientes.find(x=>x.id===clienteId||x._id===clienteId);
  if(!c) return;
  const dias=prompt('Ban temporÃ¡rio â€” quantos dias? (ex: 7)',7);
  if(!dias) return;
  try { await apiReq('PATCH',`/api/admin/clientes/${clienteId}/bloquear`,{tipo:'temp',dias}); } catch(e){}
  const ate=new Date();ate.setDate(ate.getDate()+parseInt(dias));
  c.bloqueado=true;c.banTemporario=ate.toLocaleDateString('pt-BR');c.banPermanente=false;
  c.motivoBloqueio=`Ban temporÃ¡rio por ${dias} dias (atÃ© ${c.banTemporario})`;c.dataBloqueio=hoje();
  showToast(`Ban temporÃ¡rio de ${dias} dias aplicado.`,'â°');
  renderAdminForm();
}
async function bloquearCliente(clienteId){
  const c=db.clientes.find(x=>x.id===clienteId||x._id===clienteId);
  if(!c) return;
  if(!confirm(`Bloquear PERMANENTEMENTE a conta de ${c.nome}?`)) return;
  try { await apiReq('PATCH',`/api/admin/clientes/${clienteId}/bloquear`,{tipo:'permanente'}); } catch(e){}
  c.bloqueado=true;c.banPermanente=true;c.banTemporario=null;
  c.motivoBloqueio='Bloqueio permanente pelo administrador';c.dataBloqueio=hoje();
  showToast(`Conta de ${c.nome} bloqueada permanentemente.`,'ğŸ”’');
  renderAdminForm();
}
async function excluirCliente(clienteId){
  const cl=db.clientes.find(x=>String(x.id||x._id)===String(clienteId));
  if(!cl) return;
  if(!confirm(`Excluir definitivamente a conta de ${cl.nome}?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.`)) return;
  try {
    await apiReq('DELETE',`/api/admin/clientes/${clienteId}`);
    showToast('Conta excluÃ­da permanentemente.','ğŸ—‘ï¸');
    await carregarDadosAdmin();
    renderAdminForm();
  } catch(e){
    showToast('Erro ao excluir: '+e.message,'âŒ');
  }
}

function editarNomeCliente(){
  const novo=prompt('Seu nome:',perfilNome);
  if(novo!==null&&novo.trim()){
    perfilNome=novo.trim();
    const el=document.getElementById('cadastroNome');
    if(el) el.value=perfilNome;
    if(clienteLogado) clienteLogado.nome=perfilNome;
    sincronizarAvatar();
  }
}
function sincronizarAvatar(){
  const hasFoto=!!perfilFoto;
  const avatarImg=document.getElementById('homeAvatarImg');
  const avatarEmoji=document.getElementById('homeAvatarEmoji');
  if(avatarImg&&avatarEmoji){
    if(hasFoto){avatarImg.src=perfilFoto;avatarImg.style.display='block';avatarEmoji.style.display='none';}
    else{avatarImg.style.display='none';avatarEmoji.style.display='block';}
  }
  // Login screen preview
  const img=document.getElementById('fotoPerfilImg');
  const em=document.getElementById('fotoPerfilEmoji');
  if(img&&em){
    if(hasFoto){img.src=perfilFoto;img.style.display='block';em.style.display='none';}
    else{img.style.display='none';em.style.display='block';}
  }
  // Nome
  const nl=document.getElementById('nomeClienteLabel');
  if(nl) nl.textContent=perfilNome||'Toque para adicionar seu nome';
}
async function fazerLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  try {
    const data = await apiReq('POST','/api/auth/admin',{usuario:u,senha:p},false);
    salvarToken(data.token);
    salvarToken(data.token);
    adminLogado=true;
    adminUser={usuario:u, nome:data.nome, nivel:data.nivel};
    document.getElementById('loginErro').classList.remove('show');
    await carregarDadosAdmin();
    irPara('admin');
  } catch(e) {
    // SÃ³ usa fallback local se for erro de rede (servidor offline)
    const isNetworkError = e.message.includes('fetch') || e.message.includes('Failed') || e.message.includes('NetworkError') || e.message.includes('ERR_');
    if(isNetworkError){
      const admin=db.admins.find(a=>a.usuario===u);
      const ok=admin&&((admin._h&&p==='Deusdaminhavida4321'&&u==='admin')||(admin.senha&&admin.senha===p));
      if(ok){
        adminLogado=true;
        adminUser=admin;
        document.getElementById('loginErro').classList.remove('show');
        irPara('admin');
        showToast('âš ï¸ Servidor offline â€” modo local. Dados nÃ£o serÃ£o persistidos.','âš ï¸');
      } else {
        document.getElementById('loginErro').classList.add('show');
        document.getElementById('loginPass').value='';
      }
    } else {
      // Erro de credenciais ou servidor
      document.getElementById('loginErro').classList.add('show');
      document.getElementById('loginPass').value='';
      console.error('Erro login:', e.message);
    }
  }
}
async function fazerLoginMercadoDir(){
  const u=document.getElementById('loginMercUser').value.trim(), p=document.getElementById('loginMercPass').value;
  try {
    const data = await apiReq('POST','/api/auth/mercado',{usuario:u,senha:p},false);
    salvarToken(data.token);
    mercadoLogado = db.mercados.find(m=>m.usuario===u) || { id:data.mercadoId, _id:data.mercadoId, nome:data.nome, icone:data.icone||'ğŸª', usuario:u, plano:'' };
    document.getElementById('loginMercErro').style.display='none';
    irParaPortal();
  } catch(e) {
    document.getElementById('loginMercErro').style.display='block';
    document.getElementById('loginMercPass').value='';
  }
}
async function fazerLoginMercado(){
  const u=document.getElementById('mercLoginUser').value.trim();
  const p=document.getElementById('mercLoginPass').value;
  try {
    const data = await apiReq('POST','/api/auth/mercado',{usuario:u,senha:p},false);
    salvarToken(data.token);
    mercadoLogado = db.mercados.find(m=>m.usuario===u) || { nome:data.nome, icone:data.icone, usuario:u, _id:data.mercadoId, id:data.mercadoId };
    document.getElementById('mercLoginErro').style.display='none';
    fecharModal('modalLoginMercado');
    irParaPortal();
  } catch(e) {
    document.getElementById('mercLoginErro').style.display='block';
    document.getElementById('mercLoginPass').value='';
  }
}
function irParaPortal(){
  document.getElementById('portalMercNome').textContent=mercadoLogado.nome;
  document.getElementById('portalMercIcone').textContent=mercadoLogado.icone;
  document.getElementById('portalMercPlano').textContent=`â­ Parceiro ${mercadoLogado.plano||''}`;
  portalTabAtiva='atualizar';
  irPara('portalMercado');
}
function abrirPerfilAdmin(){
  if(!adminUser) return;
  const nivel = adminUser.nivel||'admin';
  const html = `
    <div style="padding:4px 0;">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
        <div style="width:56px;height:56px;border-radius:50%;background:var(--azul);display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;font-weight:700;flex-shrink:0;">
          ${(adminUser.nome||adminUser.usuario||'A').charAt(0).toUpperCase()}
        </div>
        <div>
          <div style="font-family:var(--font-title);font-size:17px;font-weight:800;">${adminUser.nome||adminUser.usuario}</div>
          <div style="font-size:12px;color:var(--muted);">@${adminUser.usuario}</div>
          <div style="margin-top:4px;"><span style="background:${nivel==='super'?'#7C3AED20':'#1a73c820'};color:${nivel==='super'?'#7C3AED':'var(--azul)'};font-size:10px;font-weight:700;padding:2px 8px;border-radius:100px;">${nivel==='super'?'â­ Super Admin':'ğŸ›¡ï¸ Admin'}</span></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button onclick="alterarSenhaAdmin()" style="background:var(--card2);border:1.5px solid var(--borda);border-radius:10px;padding:13px;font-family:var(--font-title);font-weight:700;font-size:14px;color:var(--azul-esc);cursor:pointer;display:flex;align-items:center;gap:10px;width:100%;">ğŸ”‘ Alterar Minha Senha</button>
        <button onclick="document.getElementById('modalPerfil').style.display='none';fazerLogout();" style="background:#DC26261A;border:1.5px solid #DC262640;border-radius:10px;padding:13px;font-family:var(--font-title);font-weight:700;font-size:14px;color:#DC2626;cursor:pointer;display:flex;align-items:center;gap:10px;width:100%;">ğŸšª Sair do Painel</button>
      </div>
    </div>
  `;
  document.getElementById('modalPerfilContent').innerHTML = '<div style="font-family:var(--font-title);font-weight:800;font-size:18px;margin-bottom:16px;">ğŸ‘¤ Minha Conta</div>' + html;
  document.getElementById('modalPerfil').style.display='flex';
}

async function alterarSenhaAdmin(){
  const atual = prompt('Senha atual:');
  if(atual===null) return;
  const nova = prompt('Nova senha (mÃ­nimo 6 caracteres):');
  if(!nova||nova.length<6){ showToast('Nova senha muito curta!','âš ï¸'); return; }
  const conf = prompt('Confirme a nova senha:');
  if(nova!==conf){ showToast('Senhas nÃ£o coincidem!','âš ï¸'); return; }
  try {
    await apiReq('POST','/api/auth/alterar-senha',{senhaAtual:atual,novaSenha:nova});
    showToast('âœ… Senha alterada com sucesso!','ğŸ”‘');
    document.getElementById('modalPerfil').style.display='none';
  } catch(e){ showToast('Erro: '+e.message,'âŒ'); }
}

function fazerLogout(){adminLogado=false;adminUser=null;mercadoLogado=null;clienteLogado=null;limparToken();irPara('home');}

// ===== LOG SYSTEM =====
function adicionarLog(tipo, descricao, usuario){
  db.logs.push({id:Date.now(),tipo,descricao,usuario:usuario||'anon',ip:_getIP(),data:new Date().toLocaleString('pt-BR'),timestamp:Date.now()});
}
function _getIP(){return '';} // IP real capturado pelo servidor

// ===== CLIENTE LOGIN =====
async function fazerLoginCliente(){
  const u=document.getElementById('loginClienteUser').value.trim();
  const p=document.getElementById('loginClienteSenha').value;
  try {
    const data = await apiReq('POST','/api/auth/cliente',{login:u,senha:p},false);
    salvarToken(data.token);
    clienteLogado={login:u,nome:data.nome,bloqueado:data.bloqueado,emailVerificado:data.emailVerificado,bairro:data.bairro};
    perfilNome=data.nome; sincronizarAvatar();
    document.getElementById('loginClienteErro').classList.remove('show');
    irPara('home');
    showToast(data.bloqueado?'Conta em anÃ¡lise ğŸ”’':`Bem-vindo de volta, ${data.nome}! ğŸ‘‹`,data.bloqueado?'ğŸ”’':'âœ…');
  } catch(e) {
    const c=db.clientes.find(x=>x.login===u&&x._pwd===p);
    if(c){
      clienteLogado=c; perfilNome=c.nome; sincronizarAvatar();
      document.getElementById('loginClienteErro').classList.remove('show');
      irPara('home');
      showToast(c.bloqueado?'Conta em anÃ¡lise ğŸ”’':`Bem-vindo de volta, ${c.nome}! ğŸ‘‹`,c.bloqueado?'ğŸ”’':'âœ…');
    } else {
      document.getElementById('loginClienteErro').classList.add('show');
      document.getElementById('loginClienteSenha').value='';
    }
  }
}

// ===== CADASTRO DE CLIENTE =====
async function cadastrarCliente(){
  const nome   = document.getElementById('cadastroNome').value.trim();
  const tel    = document.getElementById('cadastroTel').value.trim();
  const login  = document.getElementById('cadastroLogin').value.trim();
  const senha  = document.getElementById('cadastroSenha').value;
  const email  = document.getElementById('cadastroEmail').value.trim();
  const bairro = document.getElementById('cadastroBairro').value;
  const notif  = document.getElementById('aceitaNotifWhats').checked;
  const termos = document.getElementById('aceitaTermos').checked;

  // ValidaÃ§Ãµes
  if(!nome)        { showToast('Informe seu nome completo','âš ï¸'); return; }
  if(!tel)         { showToast('Informe seu WhatsApp com DDD','âš ï¸'); return; }
  if(!login)       { showToast('Escolha um login','âš ï¸'); return; }
  if(login.length < 3) { showToast('Login deve ter pelo menos 3 caracteres','âš ï¸'); return; }
  if(!senha || senha.length < 6) { showToast('Senha deve ter pelo menos 6 caracteres','âš ï¸'); return; }
  if(!termos)      { showToast('VocÃª precisa aceitar os Termos para continuar','âš ï¸'); return; }

  const btn = document.querySelector('#cadastroCard .btn-primary');
  if(btn){ btn.disabled=true; btn.textContent='Criando conta...'; }

  try {
    const data = await apiReq('POST','/api/auth/cadastro',{
      nome, login, senha, email, telefone:tel, bairro, notifWhats:notif
    }, false);

    salvarToken(data.token);
    clienteLogado = {
      login: data.login||login,
      nome:  data.nome||nome,
      bloqueado: false,
      emailVerificado: true,
      bairro
    };
    perfilNome = data.nome||nome;
    sincronizarAvatar();

    // Adiciona Ã  lista local
    db.clientes.push({
      id: Date.now(),
      nome, login, email, telefone:tel, bairro,
      bloqueado:false, totalContribuicoes:0,
      dataCadastro: hoje(), notifWhats:notif
    });

    irPara('home');
    showToast(`Conta criada! Bem-vindo(a), ${data.nome||nome}! ğŸ‰`,'âœ…');

  } catch(e){
    showToast(e.message||'Erro ao criar conta. Tente novamente.','âŒ');
  } finally {
    if(btn){ btn.disabled=false; btn.textContent='ğŸ›’ Criar Conta GrÃ¡tis'; }
  }
}

// ===== EMAIL SIMULATION =====
// simularVerificacaoEmail removido

function renderMensagensChat(){
  const sessaoId=clienteLogado?clienteLogado.login:'visitante';
  const sessao=db.suporteChats.find(s=>s.clienteId===sessaoId);
  if(!sessao)return;
  const msgs=document.getElementById('chatMsgs');
  msgs.innerHTML=sessao.mensagens.map(m=>`
    <div class="chat-row ${m.tipo==='user'?'right':''}">
      <div class="chat-bubble ${m.tipo}" style="white-space:pre-line;">${m.texto}</div>
      <div class="chat-meta ${m.tipo==='user'?'right':''}">${m.tipo==='user'?'VocÃª':'ğŸ¤– Bot'}  â€¢  ${m.hora}</div>
    </div>`).join('');
  msgs.scrollTop=msgs.scrollHeight;
}
function adicionarMsgChat(tipo, texto){
  const sessaoId=clienteLogado?clienteLogado.login:'visitante';
  let sessao=db.suporteChats.find(s=>s.clienteId===sessaoId);
  if(!sessao){sessao={id:Date.now(),clienteId:sessaoId,mensagens:[],aberto:true,data:hoje()};db.suporteChats.push(sessao);}
  const hora=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  sessao.mensagens.push({tipo,texto,hora,timestamp:Date.now()});
  renderMensagensChat();
}
async function enviarMsgChat(){
  const inp=document.getElementById('chatInput');
  const txt=inp.value.trim();
  if(!txt)return;
  adicionarMsgChat('user',txt);
  inp.value='';inp.style.height='auto';
  // Salva no backend
  const sessaoId=clienteLogado?clienteLogado.login:'visitante';
  try { await apiReq('POST','/api/suporte/mensagem',{clienteId:sessaoId,texto:txt,tipo:'user'},false); } catch(e){}

  setTimeout(async ()=>{
    const lower = txt.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const whats = config.whatsapp||'5575999999999';

    // 1. SaudaÃ§Ã£o simples â€” responder sem escalar
    if(saudacoes.some(s=>lower.trim()===s||lower.trim().startsWith(s+' ')||lower.trim().startsWith(s+'!'))){
      adicionarMsgChat('bot','OlÃ¡! ğŸ‘‹ Bem-vindo ao suporte PreÃ§oCerto!\n\nEstou aqui para ajudar. Como posso ajudar vocÃª hoje?\n\nğŸ’¡ Pode perguntar sobre:\nâ€¢ Busca e preÃ§os de produtos\nâ€¢ Conta e login\nâ€¢ ContribuiÃ§Ã£o de preÃ§os\nâ€¢ Cadastro de mercado\nâ€¢ Problemas tÃ©cnicos');
      return;
    }

    // 2. EscalaÃ§Ã£o explÃ­cita â€” "falar com humano"
    if(palavrasEscalar.some(p=>lower.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g,'')))){
      await escalarParaHumano(txt);
      return;
    }

    // 3. Verificar keywords do bot
    const match = botRespostas.find(([k])=>{
      const kn = k.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      return lower.includes(kn);
    });

    if(match){
      adicionarMsgChat('bot', match[1]);
      // Se respondeu mas parece ser problema grave, sugerir suporte
      const problemaGrave = ['bloque','cancelar','erro','falha','nao funciona','nao consigo'].some(p=>lower.includes(p));
      if(problemaGrave){
        setTimeout(()=>{
          adicionarMsgChat('bot','Se precisar de mais ajuda, pode chamar um atendente humano digitando: "falar com humano" ğŸ™‹');
        }, 1500);
      }
    } else {
      // 4. Mensagem nÃ£o reconhecida â€” tentar resposta genÃ©rica antes de escalar
      const sessao = db.suporteChats.find(s=>s.clienteId===sessaoId);
      const numMsgs = sessao?.mensagens?.filter(m=>m.tipo==='user').length||0;

      if(numMsgs <= 2){
        // Primeira ou segunda mensagem nÃ£o reconhecida â€” pedir mais detalhes
        adicionarMsgChat('bot','Entendi! ğŸ¤” Poderia detalhar um pouco mais o que precisa?\n\nAssim consigo ajudar melhor. VocÃª pode perguntar sobre:\nâ€¢ PreÃ§os e produtos\nâ€¢ Conta e login\nâ€¢ Mercados e planos\nâ€¢ Problemas tÃ©cnicos');
      } else {
        // NÃ£o conseguiu resolver â€” verificar admin online e escalar
        await escalarParaHumano(txt);
      }
    }
  }, 700);
}

async function escalarParaHumano(mensagem){
  const whats = config.whatsapp||'5575999999999';
  // Verificar se hÃ¡ admin online
  let adminsOnline = 0;
  try {
    const res = await apiReq('GET','/api/admins/online',null,false);
    adminsOnline = res.count||0;
  } catch(e){}

  // Registrar ocorrÃªncia no banco
  registrarOcorrencia(mensagem);

  if(adminsOnline > 0){
    adicionarMsgChat('bot','ğŸŸ¢ HÃ¡ um atendente disponÃ­vel agora!\n\nVou transferir sua conversa para um atendente humano. Aguarde um momento...\n\nğŸ“ Se preferir contato imediato: https://wa.me/'+whats);
  } else {
    adicionarMsgChat('bot','ğŸ“‹ Sua solicitaÃ§Ã£o foi registrada com sucesso!\n\nNo momento nÃ£o hÃ¡ atendentes disponÃ­veis, mas nossa equipe irÃ¡ analisar e entrar em contato pelo WhatsApp em atÃ© 24 horas.\n\nâ±ï¸ Tempo mÃ©dio de resposta: atÃ© 24 horas\nğŸ“ Contato direto: https://wa.me/'+whats+'\n\nSe for urgente, vocÃª pode nos contatar diretamente pelo WhatsApp acima.');
  }
}

// ===== LOCALIZAÃ‡ÃƒO DE MERCADO =====
function abrirLocalizacaoMercado(mercadoId){
  const merc=db.mercados.find(m=>String(m._id||m.id)===String(mercadoId));
  if(!merc||!merc.lat)return;
  const destino=`${merc.lat},${merc.lng}`;
  const nome=encodeURIComponent(merc.nome+', '+merc.endereco+', PiatÃ£, BA');
  // Tenta pegar localizaÃ§Ã£o do cliente para rota
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const orig=`${pos.coords.latitude},${pos.coords.longitude}`;
        const url=`https://www.google.com/maps/dir/${orig}/${destino}`;
        window.open(url,'_blank');
        adicionarLog('maps','Rota calculada para '+merc.nome, clienteLogado?clienteLogado.login:'visitante');
      },
      ()=>{
        // Sem permissÃ£o de localizaÃ§Ã£o â€” abre sÃ³ o mapa do mercado
        const url=`https://www.google.com/maps/search/${nome}/@${merc.lat},${merc.lng},17z`;
        window.open(url,'_blank');
      }
    );
  } else {
    const url=`https://www.google.com/maps/search/${nome}/@${merc.lat},${merc.lng},17z`;
    window.open(url,'_blank');
  }
}

// ===== SUPORTE NO ADMIN - CHAT MANAGER =====
function renderAdminChats(){
  const chats=db.suporteChats.filter(s=>s.mensagens.length>0);
  return chats.length===0?
    '<div style="text-align:center;color:var(--muted);padding:30px 0;">Nenhuma conversa de suporte ainda</div>':
    chats.map(s=>{
      const ult=s.mensagens[s.mensagens.length-1];
      const naolidas=s.mensagens.filter(m=>m.tipo==='user'&&!m.lida).length;
      return`<div style="background:#fff;border:1.5px solid ${naolidas?'var(--azul)':'var(--borda)'};border-radius:12px;padding:13px;cursor:pointer;" onclick="verChatAdmin('${s.clienteId}')">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div style="font-weight:700;font-size:14px;">ğŸ‘¤ ${s.clienteId}</div>
          ${naolidas?`<span style="background:var(--azul);color:#fff;font-size:10px;font-weight:700;padding:2px 8px;border-radius:100px;">${naolidas} nova(s)</span>`:'<span style="font-size:11px;color:var(--muted);">Lido</span>'}
        </div>
        <div style="font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">"${ult.texto.substring(0,60)}${ult.texto.length>60?'...':''}"</div>
        <div style="font-size:10px;color:var(--muted);margin-top:4px;">ğŸ“… ${s.data} â€¢ ${s.mensagens.length} mensagens</div>
      </div>`;
    }).join('');
}
function verChatAdmin(clienteId){
  const sessao=db.suporteChats.find(s=>s.clienteId===clienteId);
  if(!sessao)return;
  // Marca como lido
  sessao.mensagens.forEach(m=>{if(m.tipo==='user')m.lida=true;});
  const hist=sessao.mensagens.map(m=>`[${m.hora}] ${m.tipo==='user'?'ğŸ‘¤ Cliente':'ğŸ¤– Bot'}: ${m.texto}`).join('\n\n');
  alert(`ğŸ’¬ Conversa com ${clienteId}:\n\n${hist}`);
  renderAdminForm();
}
function renderAdminLogs(){
  return db.logs.length===0?
    '<div style="text-align:center;color:var(--muted);padding:30px 0;">Nenhum log registrado</div>':
    db.logs.slice().reverse().slice(0,50).map(l=>{
      const clr={admin:'var(--azul)',mercado:'var(--roxo)',cliente:'var(--verde)',cadastro:'#16A34A',chat:'#F59E0B',maps:'#06B6D4'}[l.tipo]||'var(--muted)';
      return`<div style="background:#fff;border-left:3px solid ${clr};border-radius:0 10px 10px 0;padding:9px 12px;border:1px solid var(--borda);border-left:3px solid ${clr};">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:11px;font-weight:700;color:${clr};text-transform:uppercase;">${l.tipo}</span>
          <span style="font-size:10px;color:var(--muted);">${l.data}</span>
        </div>
        <div style="font-size:12px;color:var(--texto);margin-top:2px;">${l.descricao}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px;">ğŸ‘¤ ${l.usuario} â€¢ IP: ${l.ip}</div>
      </div>`;
    }).join('');
}

// ===== NAVEGAÃ‡ÃƒO =====
function irPara(tela){
  if(tela==='admin'&&!adminLogado){tela='login';}
  if(tela==='portalMercado'&&!mercadoLogado){abrirModal('modalLoginMercado');return;}
  if(tela==='contribuir'){
    if(!clienteLogado){
      showToast('FaÃ§a seu cadastro para contribuir com preÃ§os!','ğŸ”’');
      tela='login';
    } else if(clienteLogado.bloqueado){
      showToast('Sua conta estÃ¡ bloqueada para contribuiÃ§Ãµes. Aguarde revisÃ£o do admin.','ğŸ”’');
      return;
    }
  }
  // cadastro Ã© uma sub-tela do login
  if(tela==='cadastro'){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById('login').classList.add('active');
    document.getElementById('loginClienteCard').style.display='none';
    document.getElementById('loginMercadoForm').style.display='none';
    document.getElementById('loginAdminForm').style.display='none';
    document.getElementById('cadastroCard').style.display='block';
    return;
  }
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(tela).classList.add('active');
  // Ao voltar para login, mostra card normal
  if(tela==='login'){
    setTimeout(()=>{
      const cc=document.getElementById('cadastroCard');
      const lc=document.getElementById('loginClienteCard');
      if(cc)cc.style.display='none';
      if(lc)lc.style.display='block';
    },10);
  }
  if(tela==='home')renderHome();
  if(tela==='busca')renderBusca();
  if(tela==='lista')renderLista();
  if(tela==='admin'){tabAtiva='visao_geral';syncAdminTabs();renderAdminForm();}
  if(tela==='contribuir'){contribTabAtiva='foto';renderContrib();}
  if(tela==='portalMercado'){portalTabAtiva='atualizar';renderPortal();}
  if(tela==='planos')renderPlanos();
  if(tela==='suporte')renderChat();
}
function irParaBusca(){irPara('busca');}
function syncAdminTabs(){
  const tabs=['visao_geral','contribuicoes','clientes','suporte_admin','logs_admin','localizacao','precos','produto','mercado','promocoes','planos_config','solicitacoes','usuarios','busca_auto','ocorrencias'];
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('ativo',tabs[i]===tabAtiva));
}

// ===== HOME =====
function renderHome(){
  document.getElementById('totalProdutos').textContent=db.produtos.length;
  document.getElementById('totalMercados').textContent=db.mercados.length;
  const promosAtivas=db.promocoes.filter(p=>p.ativa);
  document.getElementById('totalPromos').textContent=promosAtivas.length;
  document.getElementById('heroLocTag').textContent='ğŸ“ '+config.cidade+', '+config.estado;
  document.getElementById('adminTag').style.display=adminLogado?'block':'none';
  // Cliente logado tag
  const ctag=document.getElementById('clienteTag');
  const banner=document.getElementById('bloqueadoBanner');
  if(clienteLogado&&!adminLogado){
    ctag.style.display='block';
    ctag.textContent=(clienteLogado.bloqueado?'ğŸ”’ ':'ğŸ‘¤ ')+clienteLogado.nome.split(' ')[0];
    ctag.style.background=clienteLogado.bloqueado?'rgba(220,38,38,.5)':'rgba(255,255,255,.15)';
    if(banner) banner.style.display=clienteLogado.bloqueado?'flex':'none';
  } else {
    ctag.style.display='none';
    if(banner) banner.style.display='none';
  }
  const sec=document.getElementById('promoHomeSection');
  if(promosAtivas.length>0){
    sec.style.display='block';
    document.getElementById('promoHomeScroll').innerHTML=promosAtivas.map(pr=>{
      const prod=db.produtos.find(p=>String(p.id)===String(pr.produtoId)||String(p._id)===String(pr.produtoId));
      const merc=db.mercados.find(m=>String(m.id)===String(pr.mercadoId)||String(m._id)===String(pr.mercadoId));
      if(!prod||!merc)return'';
      const descPct=Math.round((1-(pr.precoPromo/pr.precoNormal))*100);
      return`<div class="promo-home-card" onclick="verDetalhe(\'${prod._id||prod.id}\')">
        <div class="promo-home-emoji">${prod.emoji}</div>
        <div class="promo-home-info">
          <div class="promo-home-nome">${prod.nome}</div>
          <div class="promo-home-precos">
            <span class="promo-home-de">R$ ${fmt(pr.precoNormal)}</span>
            <span class="promo-home-por">R$ ${fmt(pr.precoPromo)}</span>
            <span class="promo-home-pct">-${descPct}%</span>
          </div>
          <div class="promo-home-meta">
            <span>â° AtÃ© ${pr.validade}</span>
            <span>ğŸª ${merc.nome}</span>
          </div>
        </div>
        <div style="font-size:20px;color:var(--borda2);">â€º</div>
      </div>`;
    }).join('');
  }else{sec.style.display='none';}
  const pendentes=db.contribuicoes.filter(c=>c.status==='pendente').length;
  document.getElementById('floatingCards').innerHTML=db.produtos.slice(0,3).map(p=>{
    const precos=db.precos.filter(pr=>String(pr.produtoId)===String(p.id));
    if(!precos.length)return'';
    const min=Math.min(...precos.map(pr=>pr.preco));
    const prMin=precos.find(pr=>pr.preco===min);
    const merc=db.mercados.find(m=>String(m._id||m.id)===String(prMin.mercadoId));
    const f=freshnessInfo(prMin.dataAtu);
    return`<div class="preview-card"><span style="font-size:22px;">${p.emoji}</span><div class="preview-info"><div class="preview-name">${p.nome}</div><div class="preview-mercado">${merc?merc.nome:''}</div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;"><span style="font-family:var(--font-title);font-weight:700;font-size:14px;color:var(--verde);">R$ ${fmt(min)}</span><span class="badge-menor">+ barato</span></div></div>`;
  }).join('');
}

// ===== BUSCA =====
function renderBusca(){
  const bairros=['Todos',...new Set(db.mercados.map(m=>m.bairro))];
  document.getElementById('bairroChips').innerHTML=bairros.map(b=>`<div class="chip ${b===bairroAtivo?'ativo':''}" onclick="filtrarBairro('${b}')">${b}</div>`).join('');
  const cats=['Todos',...new Set(db.produtos.map(p=>p.categoria))];
  document.getElementById('categorias').innerHTML=cats.map(c=>`<div class="chip ${c===categoriaAtiva?'ativo':''}" onclick="filtrarCat('${c}')">${c}</div>`).join('');
  filtrarProdutos();atualizarBadges();
}
function toggleBairroFilter(){filtroAberto=!filtroAberto;document.getElementById('bairroDD').classList.toggle('show',filtroAberto);document.getElementById('filterBtn').classList.toggle('ativo',filtroAberto);}
function filtrarBairro(b){bairroAtivo=b;document.querySelectorAll('#bairroChips .chip').forEach(ch=>ch.classList.toggle('ativo',ch.textContent===b));filtrarProdutos();}
function filtrarCat(c){categoriaAtiva=c;document.querySelectorAll('#categorias .chip').forEach(ch=>ch.classList.toggle('ativo',ch.textContent===c));filtrarProdutos();}

function filtrarProdutos(){
  const busca=document.getElementById('campoBusca').value.toLowerCase();
  let prods=db.produtos;
  if(categoriaAtiva!=='Todos')prods=prods.filter(p=>p.categoria===categoriaAtiva);
  if(busca)prods=prods.filter(p=>p.nome.toLowerCase().includes(busca));
  let mercs=bairroAtivo==='Todos'?db.mercados:db.mercados.filter(m=>m.bairro===bairroAtivo);
  const mids=mercs.map(m=>m.id);
  document.getElementById('secaoLabel').textContent=busca?`${prods.length} resultado(s) para "${busca}"`:bairroAtivo!=='Todos'?`Bairro: ${bairroAtivo}`:categoriaAtiva==='Todos'?'Todos os produtos':categoriaAtiva;
  document.getElementById('produtosLista').innerHTML=prods.map(p=>{
    const precos=db.precos.filter(pr=>String(pr.produtoId)===String(p.id)&&mids.map(String).includes(String(pr.mercadoId)));
    const naLista=listaCompras.some(i=>String(i.produtoId)===String(p._id||p.id));
    const temPromo=db.promocoes.find(pr=>String(pr.produtoId)===String(p._id||p.id)&&pr.ativa&&mids.includes(String(pr.mercadoId)));
    if(!precos.length)return`<div class="produto-card" onclick="verDetalhe('${p._id||p.id}')"><div class="prod-emoji">${p.emoji}</div><div class="prod-info"><div class="prod-nome">${p.nome}</div><div class="prod-sub">Sem preÃ§os cadastrados</div></div></div>`;
    const precosFinal=precos.map(pr=>{const promo=db.promocoes.find(po=>String(po.produtoId)===String(p.id)&&String(po.mercadoId)===String(pr.mercadoId)&&po.ativa);return promo?promo.precoPromo:pr.preco;});
    const minPreco=Math.min(...precosFinal);
    const maxPreco=Math.max(...precos.map(pr=>pr.preco));
    const prMinFull=precos[precosFinal.indexOf(minPreco)];
    const oldestDate=precos.reduce((oldest,pr)=>{if(!oldest)return pr.dataAtu;const[d1,m1,y1]=oldest.split('/').map(Number);const[d2,m2,y2]=(pr.dataAtu||'01/01/2000').split('/').map(Number);return new Date(y1,m1-1,d1)<new Date(y2,m2-1,d2)?oldest:pr.dataAtu;},null);
    const f=freshnessInfo(oldestDate);
    const isOld=f.cls==='old';
    return`<div class="produto-card" onclick="verDetalhe('${p._id||p.id}')">
      ${temPromo?'<div class="promo-badge-prod">ğŸ”¥ PROMO</div>':isOld?'<div class="old-badge-prod">âš ï¸ Verificar</div>':''}
      <div class="prod-emoji">${p.emoji}</div>
      <div class="prod-info">
        <div class="prod-nome">${p.nome}</div>
        <div class="prod-sub">${precos.length} mercado(s) â€¢ ${p.categoria}</div>
        <div class="prod-freshness">${freshnessHTML(prMinFull.dataAtu)}</div>
      </div>
      <div class="prod-preco-min">
        ${maxPreco!==minPreco?`<span class="preco-de">R$ ${fmt(maxPreco)}</span>`:''}
        <span class="preco-min" style="${temPromo?'color:var(--amarelo)':''}">R$ ${fmt(minPreco)}</span>
      </div>
      <button class="add-lista-btn ${naLista?'adicionado':''}" onclick="event.stopPropagation();toggleListaProduto(\'${p._id||p.id}\')">${naLista?'âœ“':'+'}</button>
    </div>`;
  }).join('')||'<div style="text-align:center;color:var(--muted);padding:40px 0;">Nenhum produto encontrado</div>';
}

// ===== DETALHE =====
function verDetalhe(prodId){
  produtoDetalheAtual=prodId;
  const prod=db.produtos.find(p=>String(p._id||p.id)===String(prodId));
  let mercs=bairroAtivo==='Todos'?db.mercados:db.mercados.filter(m=>m.bairro===bairroAtivo);
  const mids=mercs.map(m=>String(m._id||m.id));
  const precos=db.precos.filter(pr=>String(pr.produtoId)===String(prodId)&&mids.includes(String(pr.mercadoId)))
    .map(pr=>{const promo=db.promocoes.find(p=>String(p.produtoId)===String(prodId)&&String(p.mercadoId)===String(pr.mercadoId)&&p.ativa);return{...pr,mercado:db.mercados.find(m=>String(m.id)===String(pr.mercadoId)||String(m._id)===String(pr.mercadoId)),precoPromo:promo?promo.precoPromo:null,promoInfo:promo||null,precoFinal:promo?promo.precoPromo:pr.preco};})
    .filter(pr=>pr.mercado).sort((a,b)=>a.precoFinal-b.precoFinal);

  document.getElementById('detalheEmoji').textContent=prod.emoji;
  document.getElementById('detalheNome').textContent=prod.nome;
  document.getElementById('detalheCat').textContent=prod.categoria+(bairroAtivo!=='Todos'?` â€¢ ğŸ“ ${bairroAtivo}`:'');
  if(precos.length>=2){const eco=precos[precos.length-1].precoFinal-precos[0].precoFinal;document.getElementById('economiaInfo').innerHTML=`ğŸ’° Economize atÃ© R$ ${fmt(eco)}`;}
  else document.getElementById('economiaInfo').innerHTML=`ğŸ“ ${precos.length} mercado`;
  const naLista=listaCompras.some(i=>String(i.produtoId)===String(prodId));
  const btn=document.getElementById('detalhe-lista-btn');
  btn.textContent=naLista?'âœ“ Na lista':'+ Lista';
  btn.className='lista-btn'+(naLista?' adicionado':'');
  const maxP=precos.length?precos[precos.length-1].precoFinal:1;

  document.getElementById('mercadosLista').innerHTML=precos.map((pr,i)=>{
    const hist=db.historico.filter(h=>String(h.produtoId)===String(prodId)&&String(h.mercadoId)===String(pr.mercadoId));
    const maxH=hist.length?Math.max(...hist.map(h=>h.preco)):pr.preco;
    const isPromo=!!pr.promoInfo;
    const isMelhor=i===0;
    return`<div class="mercado-item ${isMelhor&&!isPromo?'menor-preco':''} ${isPromo?'tem-promo':''}">
      ${isMelhor&&!isPromo?'<div class="melhor-badge">ğŸ† MENOR PREÃ‡O</div>':''}
      ${isPromo?'<div class="promo-tag-item">ğŸ”¥ PROMOÃ‡ÃƒO</div>':''}
      <div class="mercado-topo">
        <div class="mercado-icon">${pr.mercado.icone}</div>
        <div style="flex:1;">
          <div class="m-nome">${pr.mercado.nome}</div>
          <div class="m-end">ğŸ“ ${pr.mercado.endereco}</div>
          <div class="m-bairro">ğŸ˜ï¸ ${pr.mercado.bairro}</div>
        </div>
        <div style="text-align:right;">${freshnessHTML(pr.dataAtu)}</div>
      </div>
      <div class="preco-row">
        <div>
          ${isPromo?`<div class="preco-de-risco">R$ ${fmt(pr.preco)} <span style="color:#B45309;font-size:10px;font-weight:700;">(preÃ§o normal)</span></div>`:''}
          <span class="preco-g ${isPromo?'promo-ativa':''}">R$ ${fmt(pr.precoFinal)}</span>
          ${isPromo?`<div style="font-size:11px;color:#B45309;font-weight:600;margin-top:3px;">ğŸ“£ ${pr.promoInfo.descricao}</div><div style="font-size:10px;color:#B45309;margin-top:1px;">VÃ¡lido atÃ© ${pr.promoInfo.validade}</div>`:''}
        </div>
        <div style="text-align:right;">
          ${isMelhor?'<span style="background:#DCFCE7;color:#16A34A;font-size:11px;font-weight:700;padding:3px 9px;border-radius:100px;">âœ“ Mais barato</span>':''}
          ${!isMelhor?`<span style="font-size:12px;color:#e74c3c;font-weight:700;">+R$ ${fmt(pr.precoFinal-precos[0].precoFinal)}</span>`:''}
        </div>
      </div>
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--borda);display:flex;align-items:center;justify-content:space-between;">
        <div>
          ${fonteHTML(pr.fonte||'admin', pr.autor)}
          <span style="font-size:11px;color:var(--muted);"> por ${pr.autor||'Admin'} â€¢ ${pr.dataAtu||'â€”'}</span>
        </div>
        <button class="report-btn" onclick="abrirReport(${prodId},${pr.mercadoId},'${pr.mercado.nome}','${prod.nome}')">âš ï¸ Reportar</button>
      </div>
      ${pr.mercado.lat?`<button class="btn-loc" onclick="abrirLocalizacaoMercado(${pr.mercadoId})">ğŸ“ Ver no mapa &amp; Rota</button>`:''}
      ${hist.length>1?`<div class="hist-toggle" onclick="toggleHist('h${i}')"><span>ğŸ“ˆ HistÃ³rico</span><span id="hArrow${i}">â–¾</span></div>
      <div class="hist-box" id="h${i}">
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;">VariaÃ§Ã£o de preÃ§o</div>
        ${hist.map(h=>`<div class="hist-item"><span class="hist-data">${h.data}</span><div class="hist-bar-wrap"><div class="hist-bar" style="width:${(h.preco/maxH*100).toFixed(0)}%"></div></div><span class="hist-val">R$ ${fmt(h.preco)}</span></div>`).join('')}
      </div>`:''}
    </div>`;
  }).join('')||'<div style="text-align:center;color:var(--muted);padding:40px 0;font-size:13px;">ğŸ“ Sem preÃ§os disponÃ­veis neste bairro</div>';
  irPara('detalhe');atualizarBadges();
}
function toggleHist(id){document.getElementById(id).classList.toggle('show');}

// ===== REPORT =====
function abrirReport(prodId,mercId,mercNome,prodNome){
  reportProdId=prodId;reportMercId=mercId;
  document.getElementById('reportProdInfo').textContent=`${prodNome} â€” ${mercNome}`;
  abrirModal('modalReport');
}
function enviarReport(){
  const motivo=document.getElementById('reportMotivo').value;
  const det=document.getElementById('reportDetalhes').value;
  db.contribuicoes.push({id:Date.now(),tipo:'report',produtoId:reportProdId,mercadoId:reportMercId,motivo,detalhes:det,data:hoje(),status:'pendente',autor:'Cliente'});
  fecharModal('modalReport');
  showToast('Obrigado! Report enviado para revisÃ£o.','âš ï¸');
}

// ===== CONTRIBUIÃ‡ÃƒO CLIENTE =====
function setContribTab(tab){
  contribTabAtiva=tab;
  document.querySelectorAll('.contrib-tab').forEach((t,i)=>t.classList.toggle('ativo',['foto','texto','qr'][i]===tab));
  renderContrib();
}
function renderContrib(){
  const body=document.getElementById('contribBody');
  if(contribTabAtiva==='foto'){
    body.innerHTML=`
      <div style="background:var(--card2);border:1.5px solid var(--borda);border-radius:13px;padding:13px;font-size:13px;color:var(--muted);line-height:1.5;">
        ğŸ“· <strong style="color:var(--texto);">Tire uma foto da etiqueta de preÃ§o</strong> e depois identifique o produto e o valor abaixo.
      </div>
      <input type="file" id="fotoInput" accept="image/*" capture="environment" onchange="processarFoto(event)">
      <label for="fotoInput" class="upload-area" style="display:flex;">
        <div class="upload-icon">ğŸ“·</div>
        <p>Toque para <strong>tirar foto</strong> ou escolher da galeria</p>
        <p style="font-size:11px;">JPG, PNG â€¢ A etiqueta deve estar legÃ­vel</p>
      </label>
      <div class="foto-preview" id="fotoPreviewBox">
        <img id="fotoPreviewImg" src="">
        <button class="foto-preview-remover" onclick="removerFoto()">âœ• Remover</button>
      </div>
      <div class="ai-box" id="aiBox">
        <div class="ai-loading" id="aiLoading">
          <div class="spinner"></div>
          <span style="font-size:13px;color:var(--muted);">Processando foto...</span>
        </div>
        <div id="aiResultado" style="display:none;">
          <div class="ai-result" id="aiResultContent"></div>
        </div>
      </div>
      <div id="contribFormFoto" style="display:none;flex-direction:column;gap:11px;">
        <div>
          <div class="field-label">ğŸ” Produto â€” comece a digitar para buscar</div>
          <div class="ac-wrap">
            <input type="text" class="input-field" id="fotoProdutoInput" placeholder="Ex: Leite, Arroz Camil..." autocomplete="off">
            <div class="ac-list" id="fotoProdutoList"></div>
          </div>
          <input type="hidden" id="fotoProduto" value="">
        </div>
        <div><div class="field-label">Mercado</div>
          <select class="input-field" id="fotoMercado"><option value="">Selecione o mercado...</option>${db.mercados.map(m=>`<option value="${m._id||m.id}">${m.icone} ${m.nome}</option>`).join('')}</select></div>
        <div><div class="field-label">PreÃ§o que vocÃª viu (R$)</div>
          <input type="number" class="input-field" id="fotoPreco" placeholder="Ex: 9.90" step="0.01" min="0"></div>
        <div><div class="field-label">Seu nome (opcional)</div>
          <input type="text" class="input-field" id="fotoAutor" placeholder="Ex: Maria S."></div>
        <button class="btn-primary" onclick="enviarContribFoto()">ğŸ“¤ Enviar ContribuiÃ§Ã£o</button>
        <div style="font-size:12px;color:var(--muted);text-align:center;line-height:1.5;">Sua contribuiÃ§Ã£o serÃ¡ revisada antes de ser publicada. Obrigado! ğŸ™</div>
      </div>`;
    // Inicializa autocomplete da foto
    setTimeout(()=>{
      const inp=document.getElementById('fotoProdutoInput');
      const lst=document.getElementById('fotoProdutoList');
      if(inp&&lst) criarAutocomplete(inp,lst,p=>{
        document.getElementById('fotoProduto').value=p._id||p.id;
      });
    },50);
  }else if(contribTabAtiva==='texto'){
    body.innerHTML=`
      <div style="background:var(--card2);border:1.5px solid var(--borda);border-radius:13px;padding:13px;font-size:13px;color:var(--muted);line-height:1.5;">
        âœï¸ <strong style="color:var(--texto);">Digite o preÃ§o que vocÃª viu</strong> em algum mercado. Busque o produto pelo nome.
      </div>
      <div>
        <div class="field-label">ğŸ” Produto â€” comece a digitar para buscar</div>
        <div class="ac-wrap">
          <input type="text" class="input-field" id="txtProdutoInput" placeholder="Ex: FeijÃ£o, CafÃ© PilÃ£o..." autocomplete="off">
          <div class="ac-list" id="txtProdutoList"></div>
        </div>
        <input type="hidden" id="txtProduto" value="">
      </div>
      <div><div class="field-label">Mercado</div>
        <select class="input-field" id="txtMercado"><option value="">Selecione o mercado...</option>${db.mercados.map(m=>`<option value="${m._id||m.id}">${m.icone} ${m.nome}</option>`).join('')}</select></div>
      <div><div class="field-label">PreÃ§o que vocÃª viu (R$)</div>
        <input type="number" class="input-field" id="txtPreco" placeholder="Ex: 9.90" step="0.01" min="0"></div>
      <div><div class="field-label">Seu nome (opcional)</div>
        <input type="text" class="input-field" id="txtAutor" placeholder="Ex: JoÃ£o P."></div>
      <div><div class="field-label">ObservaÃ§Ã£o (opcional)</div>
        <textarea class="input-field textarea-field" id="txtObs" placeholder="Ex: PreÃ§o visto na gÃ´ndola Ã s 14h..."></textarea></div>
      <button class="btn-primary" onclick="enviarContribTexto()">ğŸ“¤ Enviar ContribuiÃ§Ã£o</button>
      <div style="font-size:12px;color:var(--muted);text-align:center;line-height:1.5;">Sua contribuiÃ§Ã£o serÃ¡ revisada antes de ser publicada. Obrigado! ğŸ™</div>`;
    setTimeout(()=>{
      const inp=document.getElementById('txtProdutoInput');
      const lst=document.getElementById('txtProdutoList');
      if(inp&&lst) criarAutocomplete(inp,lst,p=>{
        document.getElementById('txtProduto').value=p._id||p.id;
      });
    },50);
  }else if(contribTabAtiva==='qr'){
    body.innerHTML=`
      <div style="background:var(--card2);border:1.5px solid var(--borda);border-radius:13px;padding:13px;font-size:13px;color:var(--muted);line-height:1.5;">
        ğŸ“± <strong style="color:var(--texto);">Leia o QR Code da nota fiscal eletrÃ´nica</strong> para extrair produtos e preÃ§os automaticamente.
      </div>
      <div style="background:#fff;border:1.5px solid var(--borda);border-radius:13px;overflow:hidden;position:relative;">
        <video id="qrVideoInline" style="width:100%;display:block;" playsinline autoplay muted></video>
        <canvas id="qrCanvasInline" style="display:none;"></canvas>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:170px;height:170px;border:3px solid var(--verde);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.6);pointer-events:none;"></div>
      </div>
      <div id="qrStatusInline" style="text-align:center;font-size:13px;color:var(--muted);padding:4px;">Iniciando cÃ¢mera...</div>
      <button class="btn-secondary" onclick="entradaManualQR()" style="margin-top:0;">ğŸ“‹ Entrada manual de preÃ§os</button>
      <div id="qrResultadoInline" style="display:none;flex-direction:column;gap:8px;">
        <div style="background:#DCFCE7;border:1.5px solid rgba(29,185,84,.3);border-radius:12px;padding:12px;">
          <div style="font-size:12px;font-weight:700;color:var(--verde-dk);margin-bottom:4px;">âœ… Nota lida com sucesso!</div>
          <div id="qrInfoNotaInline" style="font-size:12px;color:var(--muted);"></div>
        </div>
        <div id="qrListaInline" style="display:flex;flex-direction:column;gap:6px;"></div>
        <div><div class="field-label">Seu nome (opcional)</div>
          <input type="text" class="input-field" id="qrAutorInput" placeholder="Ex: Maria S."></div>
        <button class="btn-primary" onclick="enviarContribQR()">ğŸ“¤ Enviar para aprovaÃ§Ã£o</button>
      </div>`;
    iniciarQR('qrVideoInline','qrCanvasInline','qrStatusInline');
  }
}

function processarFoto(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    fotoDataUrl=ev.target.result;
    document.getElementById('fotoPreviewImg').src=fotoDataUrl;
    document.getElementById('fotoPreviewBox').style.display='block';
    document.querySelector('.upload-area').style.display='none';
    analisarFotoComIA();
  };
  reader.readAsDataURL(file);
}
function removerFoto(){
  fotoDataUrl=null;
  document.getElementById('fotoPreviewBox').style.display='none';
  const ua=document.querySelector('.upload-area');
  if(ua)ua.style.display='flex';
  document.getElementById('aiBox').classList.remove('show');
  document.getElementById('contribFormFoto').style.display='none';
  document.getElementById('fotoInput').value='';
}
async function analisarFotoComIA(){
  const aiBox=document.getElementById('aiBox');
  aiBox.classList.add('show');
  document.getElementById('aiLoading').style.display='flex';
  document.getElementById('aiResultado').style.display='none';

  try {
    const base64Data = fotoDataUrl.split(',')[1];
    const mediaType = fotoDataUrl.split(';')[0].split(':')[1] || 'image/jpeg';

    const prompt = `VocÃª Ã© um assistente para um app de comparaÃ§Ã£o de preÃ§os brasileiro chamado PreÃ§oCerto.
Analise esta imagem de etiqueta de preÃ§o ou produto de supermercado e extraia as informaÃ§Ãµes.

Responda APENAS em JSON vÃ¡lido, sem texto adicional, no formato:
{
  "encontrou": true/false,
  "produto": "nome exato do produto com marca e tamanho se visÃ­vel",
  "preco": 0.00,
  "confianca": "alta/media/baixa",
  "observacao": "algum detalhe extra ou vazio"
}

Se nÃ£o encontrar informaÃ§Ãµes claras, retorne {"encontrou": false}.`;

    const texto = await chamarIA(prompt, base64Data, mediaType);
    document.getElementById('aiLoading').style.display='none';
    document.getElementById('aiResultado').style.display='block';

    let resultado;
    try {
      const clean = texto.replace(/```json|```/g,'').trim();
      resultado = JSON.parse(clean);
    } catch(e) {
      resultado = {encontrou: false};
    }

    if(resultado.encontrou && resultado.produto) {
      const query = resultado.produto.toLowerCase();
      const match = db.produtos.find(p => p.nome.toLowerCase().includes(query.split(' ')[0])) ||
                    db.produtos.find(p => query.includes(p.nome.toLowerCase().split(' ')[0].substring(0,5)));

      document.getElementById('aiResultContent').innerHTML=`
        <div style="background:#DCFCE7;border:1.5px solid rgba(29,185,84,.25);border-radius:10px;padding:10px 12px;margin-bottom:10px;">
          <div style="font-size:12px;font-weight:700;color:#16A34A;margin-bottom:6px;">âœ… Produto identificado pela cÃ¢mera!</div>
          <div style="font-size:13px;font-weight:700;color:var(--texto);">ğŸ“¦ ${resultado.produto}</div>
          ${resultado.preco?`<div style="font-size:14px;font-weight:800;color:var(--verde-dk);margin-top:4px;">ğŸ’° R$ ${resultado.preco.toFixed(2)}</div>`:''}
          <div style="font-size:11px;color:var(--muted);margin-top:4px;">ConfianÃ§a: ${resultado.confianca==='alta'?'ğŸŸ¢ Alta':resultado.confianca==='media'?'ğŸŸ¡ MÃ©dia':'ğŸ”´ Baixa'}</div>
        </div>
        ${match?`<div style="font-size:12px;color:var(--azul);padding:8px;background:#EFF5FB;border-radius:8px;">ğŸ” SugestÃ£o no catÃ¡logo: <strong>${match.emoji} ${match.nome}</strong> â€” confirme abaixo!</div>`:'<div style="font-size:12px;color:var(--muted);padding:8px;">Produto nÃ£o encontrado no catÃ¡logo â€” busque pelo nome abaixo.</div>'}`;

      const form=document.getElementById('contribFormFoto');
      form.style.display='flex';
      if(match) {
        setTimeout(()=>{
          const inp=document.getElementById('fotoProdutoInput');
          const hid=document.getElementById('fotoProduto');
          if(inp){inp.value=match.nome;}
          if(hid){hid.value=match._id||match.id;}
        },100);
      }
      if(resultado.preco) {
        setTimeout(()=>{
          const precoEl=document.getElementById('fotoPreco');
          if(precoEl) precoEl.value=resultado.preco.toFixed(2);
        },100);
      }
    } else {
      document.getElementById('aiResultContent').innerHTML=`
        <div style="background:#FEF3C7;border:1.5px solid rgba(180,83,9,.2);border-radius:10px;padding:10px 12px;margin-bottom:10px;">
          <div style="font-size:12px;font-weight:700;color:#B45309;margin-bottom:4px;">âš ï¸ NÃ£o foi possÃ­vel identificar automaticamente</div>
          <div style="font-size:12px;color:var(--muted);">Tente uma foto mais prÃ³xima da etiqueta. Selecione o produto e informe o preÃ§o manualmente abaixo.</div>
        </div>`;
      document.getElementById('contribFormFoto').style.display='flex';
    }
  } catch(err) {
    document.getElementById('aiLoading').style.display='none';
    document.getElementById('aiResultado').style.display='block';
    document.getElementById('aiResultContent').innerHTML=`
      <div style="background:#FEE2E2;border:1.5px solid rgba(220,38,38,.2);border-radius:10px;padding:10px;margin-bottom:10px;">
        <div style="font-size:12px;color:#DC2626;">Erro ao analisar imagem. Selecione o produto manualmente.</div>
      </div>`;
    document.getElementById('contribFormFoto').style.display='flex';
  }
}
function enviarContribFoto(){
  if(!clienteLogado||clienteLogado.bloqueado){showToast('Conta bloqueada. NÃ£o Ã© possÃ­vel contribuir.','ğŸ”’');return;}
  const prodId=document.getElementById('fotoProduto').value;
  const mercId=document.getElementById('fotoMercado').value;
  const preco=parseFloat(document.getElementById('fotoPreco').value);
  const autor=clienteLogado.nome;
  if(!prodId){showToast('Selecione o produto!','âš ï¸');return;}
  if(!mercId){showToast('Selecione o mercado!','âš ï¸');return;}
  if(!preco||preco<=0){showToast('Informe o preÃ§o!','âš ï¸');return;}
  db.contribuicoes.push({id:Date.now(),tipo:'foto',produtoId:prodId,mercadoId:mercId,preco,autor,clienteId:clienteLogado.id,data:hoje(),fotoUrl:fotoDataUrl,status:'pendente',obs:''});
  showToast('ContribuiÃ§Ã£o enviada! Aguarde aprovaÃ§Ã£o. ğŸ™','ğŸ“¸');
  fotoDataUrl=null;contribTabAtiva='foto';renderContrib();
}
function enviarContribTexto(){
  if(!clienteLogado||clienteLogado.bloqueado){showToast('Conta bloqueada. NÃ£o Ã© possÃ­vel contribuir.','ğŸ”’');return;}
  const prodId=document.getElementById('txtProduto').value;
  const mercId=document.getElementById('txtMercado').value;
  const preco=parseFloat(document.getElementById('txtPreco').value);
  const autor=clienteLogado.nome;
  const obs=document.getElementById('txtObs').value.trim();
  if(!prodId){showToast('Selecione o produto!','âš ï¸');return;}
  if(!mercId){showToast('Selecione o mercado!','âš ï¸');return;}
  if(!preco||preco<=0){showToast('Informe o preÃ§o!','âš ï¸');return;}
  db.contribuicoes.push({id:Date.now(),tipo:'texto',produtoId:prodId,mercadoId:mercId,preco,autor,clienteId:clienteLogado.id,data:hoje(),status:'pendente',obs});
  showToast('ContribuiÃ§Ã£o enviada! Aguarde aprovaÃ§Ã£o. ğŸ™','âœï¸');
  renderContrib();
}

// ===== PORTAL MERCADO =====
function setPortalTab(tab){
  portalTabAtiva=tab;
  document.querySelectorAll('.portal-tab').forEach((t,i)=>t.classList.toggle('ativo',['atualizar','promocoes','meus_precos'][i]===tab));
  renderPortal();
}
function renderPortal(){
  const body=document.getElementById('portalBody');
  const merc=mercadoLogado;
  if(!merc)return;
  if(portalTabAtiva==='atualizar'){
    body.innerHTML=`
      <div style="background:var(--card2);border:1.5px solid var(--borda);border-radius:13px;padding:13px;font-size:13px;color:var(--muted);line-height:1.5;">
        ğŸ’¡ <strong style="color:var(--texto);">Atualize os preÃ§os do seu mercado</strong> â€” busque o produto pelo nome.
      </div>
      <div>
        <div class="field-label">ğŸ” Produto â€” comece a digitar para buscar</div>
        <div class="ac-wrap">
          <input type="text" class="input-field" id="mProdutoInput" placeholder="Ex: Arroz, FeijÃ£o, Leite..." autocomplete="off">
          <div class="ac-list" id="mProdutoList"></div>
        </div>
        <input type="hidden" id="mProduto" value="">
      </div>
      <div><div class="field-label">Novo PreÃ§o (R$)</div>
        <input type="number" class="input-field" id="mPreco" placeholder="Ex: 9.90" step="0.01" min="0"></div>
      <button class="btn-azul" style="font-size:14px;" onclick="mercadoAtualizarPreco()">ğŸ’¾ Atualizar PreÃ§o</button>
      <div style="background:#DBEAFE;border:1.5px solid rgba(26,115,200,.2);border-radius:13px;padding:13px;font-size:12px;color:var(--azul);line-height:1.5;">
        âœ… Ao atualizar, o preÃ§o Ã© publicado imediatamente com o nome <strong>${merc.nome}</strong> como fonte.
      </div>`;
    setTimeout(()=>{
      const inp=document.getElementById('mProdutoInput');
      const lst=document.getElementById('mProdutoList');
      if(inp&&lst) criarAutocomplete(inp,lst,p=>{
        document.getElementById('mProduto').value=p._id||p.id;
      });
    },50);
  }else if(portalTabAtiva==='promocoes'){
    const minhasPromos=db.promocoes.filter(p=>String(p.mercadoId)===String(merc.id||merc._id));
    body.innerHTML=`
      <div>
        <div class="field-label">ğŸ” Produto em promoÃ§Ã£o â€” busque pelo nome</div>
        <div class="ac-wrap">
          <input type="text" class="input-field" id="mPromoProdInput" placeholder="Ex: Coca-Cola, SabÃ£o..." autocomplete="off">
          <div class="ac-list" id="mPromoProdList"></div>
        </div>
        <input type="hidden" id="mPromoProd" value="">
      </div>
      <div style="display:flex;gap:8px;">
        <div style="flex:1;"><div class="field-label">PreÃ§o normal (R$)</div><input type="number" class="input-field" id="mPromoNormal" placeholder="Ex: 16.50" step="0.01"></div>
        <div style="flex:1;"><div class="field-label">PreÃ§o promo (R$)</div><input type="number" class="input-field" id="mPromoPreco" placeholder="Ex: 13.90" step="0.01"></div>
      </div>
      <div><div class="field-label">VÃ¡lido atÃ©</div><input type="date" class="input-field" id="mPromoVal"></div>
      <div><div class="field-label">DescriÃ§Ã£o</div><input type="text" class="input-field" id="mPromoDesc" placeholder="Ex: Oferta especial!"></div>
      <button class="btn-primary" onclick="mercadoCriarPromo()">ğŸ”¥ Publicar PromoÃ§Ã£o</button>
      ${minhasPromos.length?`<div style="font-family:var(--font-title);font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-top:6px;">Minhas promoÃ§Ãµes (${minhasPromos.length})</div>${minhasPromos.map(pr=>{const prod=db.produtos.find(p=>String(p.id)===String(pr.produtoId)||String(p._id)===String(pr.produtoId));return`<div style="background:#fff;border:1.5px solid var(--borda);border-radius:12px;padding:12px;box-shadow:0 1px 4px rgba(11,79,138,.06);"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:700;font-size:13px;">${prod?prod.emoji+' '+prod.nome:'?'}</span><button onclick="removerPromo(\`${pr.id||pr._id}\`)" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:0 4px;">ğŸ—‘ï¸</button></div><div style="font-size:12px;color:var(--amarelo);margin-top:4px;font-weight:700;">R$ ${fmt(pr.precoNormal)} â†’ R$ ${fmt(pr.precoPromo)} â€¢ AtÃ© ${pr.validade}</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">${pr.descricao}</div></div>`;}).join('')}`:''}`;
    setTimeout(()=>{
      const inp=document.getElementById('mPromoProdInput');
      const lst=document.getElementById('mPromoProdList');
      if(inp&&lst) criarAutocomplete(inp,lst,p=>{
        document.getElementById('mPromoProd').value=p._id||p.id;
      });
    },50);
  }else{
    const meusPrecos=db.precos.filter(p=>String(p.mercadoId)===String(merc.id||merc._id));
    body.innerHTML=`
      <div style="font-size:13px;color:var(--muted);font-weight:600;padding:4px 0;">${meusPrecos.length} produto(s) com preÃ§o cadastrado</div>
      ${meusPrecos.map(p=>{const prod=db.produtos.find(pr=>String(pr._id||pr.id)===String(p.produtoId));return`<div style="background:#fff;border:1.5px solid var(--borda);border-radius:12px;padding:12px;display:flex;align-items:center;gap:10px;box-shadow:0 1px 4px rgba(11,79,138,.06);">
        <span style="font-size:22px;">${prod?prod.emoji:'ğŸ“¦'}</span>
        <div style="flex:1;"><div style="font-size:13px;font-weight:700;color:var(--texto);">${prod?prod.nome:'?'}</div>
        <div style="margin-top:3px;">${freshnessHTML(p.dataAtu)}</div></div>
        <div style="text-align:right;"><div style="font-family:var(--font-title);font-weight:900;font-size:16px;color:var(--azul-esc);">R$ ${fmt(p.preco)}</div><div style="font-size:10px;color:var(--muted);margin-top:1px;">${p.dataAtu||'â€”'}</div></div>
      </div>`;}).join('')||'<div style="text-align:center;color:var(--muted);padding:30px 0;font-size:13px;">Nenhum preÃ§o cadastrado ainda</div>'}`;
  }
}
function mercadoAtualizarPreco(){
  const prodId=document.getElementById('mProduto').value;
  const preco=parseFloat(document.getElementById('mPreco').value);
  if(!prodId){showToast('Selecione o produto!','âš ï¸');return;}
  if(!preco||preco<=0){showToast('Informe um preÃ§o vÃ¡lido!','âš ï¸');return;}
  const mesAno=new Date().toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}).replace('. ','/').replace('.','');
  db.historico.push({produtoId:prodId,mercadoId:mercadoLogado._id||mercadoLogado.id,preco,data:mesAno,fonte:'mercado'});
  const idx=db.precos.findIndex(p=>String(p.produtoId)===String(prodId)&&String(p.mercadoId)===String(mercadoLogado.id||mercadoLogado._id));
  const entry={produtoId:prodId,mercadoId:mercadoLogado._id||mercadoLogado.id,preco,dataAtu:hoje(),fonte:'mercado',autor:mercadoLogado.nome};
  if(idx>=0)db.precos[idx]=entry;else db.precos.push(entry);
  document.getElementById('mPreco').value='';
  document.getElementById('mProduto').value='';
  const inp=document.getElementById('mProdutoInput');
  if(inp)inp.value='';
  const prod=db.produtos.find(p=>String(p._id||p.id)===String(prodId));
  showToast(`PreÃ§o de ${prod?prod.nome:'produto'} atualizado!`,'âœ…');
}
function mercadoCriarPromo(){
  const prodId=document.getElementById('mPromoProd').value;
  const normal=parseFloat(document.getElementById('mPromoNormal').value);
  const promo=parseFloat(document.getElementById('mPromoPreco').value);
  const val=document.getElementById('mPromoVal').value;
  const desc=document.getElementById('mPromoDesc').value.trim();
  if(!prodId){showToast('Selecione o produto!','âš ï¸');return;}
  if(isNaN(normal)||isNaN(promo)||!val){showToast('Preencha todos os campos!','âš ï¸');return;}
  if(promo>=normal){showToast('PreÃ§o promo deve ser menor!','âš ï¸');return;}
  const[y,m,d]=val.split('-');
  db.promocoes.push({id:Date.now(),produtoId:prodId,mercadoId:mercadoLogado._id||mercadoLogado.id,precoNormal:normal,precoPromo:promo,validade:`${d}/${m}/${y}`,descricao:desc||'PromoÃ§Ã£o especial!',ativa:true});
  showToast('PromoÃ§Ã£o publicada!','ğŸ”¥');renderPortal();
}
async function removerPromo(id){
  if(!confirm('Remover esta promoÃ§Ã£o?')) return;
  try {
    await apiReq('DELETE',`/api/promocoes/${id}`);
    db.promocoes=db.promocoes.filter(p=>String(p.id||p._id)!==String(id));
    showToast('PromoÃ§Ã£o encerrada! âœ…','ğŸ—‘ï¸');
    renderPortal();
  } catch(e){
    showToast('Erro ao excluir: '+e.message,'âŒ');
  }
}

// ===== LISTA =====
function toggleListaProduto(prodId){
  const idx=listaCompras.findIndex(i=>String(i.produtoId)===String(prodId));
  if(idx>=0){listaCompras.splice(idx,1);}
  else{
    const prod=db.produtos.find(p=>String(p._id||p.id)===String(prodId));
    const precos=db.precos.filter(pr=>String(pr.produtoId)===String(prodId)).map(pr=>{const promo=db.promocoes.find(p=>String(p.produtoId)===String(prodId)&&String(p.mercadoId)===String(pr.mercadoId)&&p.ativa);return{...pr,mercado:db.mercados.find(m=>String(m.id)===String(pr.mercadoId)||String(m._id)===String(pr.mercadoId)),precoFinal:promo?promo.precoPromo:pr.preco};}).filter(pr=>pr.mercado).sort((a,b)=>a.precoFinal-b.precoFinal);
    listaCompras.push({produtoId:prodId,nome:prod.nome,emoji:prod.emoji,precoMin:precos.length?precos[0].precoFinal:0,mercadoNome:precos.length?precos[0].mercado.nome:'-',comprado:false});
  }
  atualizarBadges();filtrarProdutos();
}
function toggleListaDetalhe(){
  toggleListaProduto(produtoDetalheAtual);
  const naLista=listaCompras.some(i=>String(i.produtoId)===String(produtoDetalheAtual));
  const btn=document.getElementById('detalhe-lista-btn');
  btn.textContent=naLista?'âœ“ Na lista':'+ Lista';
  btn.className='lista-btn'+(naLista?' adicionado':'');
}
function atualizarBadges(){
  const n=listaCompras.length;
  ['badgeLista','badgeLista2','badgeLista3','badgeLista4'].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent=n;el.style.display=n>0?'flex':'none';}});
}
function renderLista(){
  atualizarBadges();
  if(listaCompras.length===0){document.getElementById('listaVazia').style.display='flex';document.getElementById('listaContent').innerHTML='';document.getElementById('listaFooter').style.display='none';return;}
  document.getElementById('listaVazia').style.display='none';document.getElementById('listaFooter').style.display='block';
  document.getElementById('listaContent').innerHTML=listaCompras.map((item,idx)=>`
    <div class="lista-item ${item.comprado?'comprado':''}">
      <div class="li-check ${item.comprado?'checked':''}" onclick="toggleComprado(${idx})">${item.comprado?'âœ“':''}</div>
      <span style="font-size:20px;">${item.emoji}</span>
      <div class="li-info"><div class="li-nome">${item.nome}</div><div class="li-mercado">ğŸª ${item.mercadoNome}</div></div>
      <span class="li-preco">R$ ${fmt(item.precoMin)}</span>
      <button class="li-remove" onclick="removerLista(${idx})">âœ•</button>
    </div>`).join('');
  const total=listaCompras.filter(i=>!i.comprado).reduce((acc,i)=>acc+i.precoMin,0);
  document.getElementById('totalLista').textContent=`R$ ${fmt(total)}`;
}
function toggleComprado(idx){listaCompras[idx].comprado=!listaCompras[idx].comprado;renderLista();}
function removerLista(idx){listaCompras.splice(idx,1);renderLista();atualizarBadges();}
function limparLista(){if(confirm('Limpar toda a lista?')){listaCompras=[];renderLista();atualizarBadges();}}
function compartilharLista(){
  const txt='ğŸ›’ Lista de compras â€” PreÃ§oCerto\nğŸ“ '+config.cidade+', '+config.estado+'\n\n'+listaCompras.map(i=>`${i.emoji} ${i.nome} â€” R$ ${fmt(i.precoMin)} (${i.mercadoNome})`).join('\n')+'\n\nTotal: R$ '+fmt(listaCompras.reduce((a,i)=>a+i.precoMin,0));
  // iOS Safari compatÃ­vel
  if(navigator.share){
    navigator.share({title:'Lista PreÃ§oCerto',text:txt}).catch(()=>{});
    return;
  }
  try{
    navigator.clipboard.writeText(txt).then(()=>showToast('Lista copiada!','ğŸ“‹')).catch(()=>copiarFallback(txt));
  }catch(e){copiarFallback(txt);}
}
function copiarFallback(txt){
  const el=document.createElement('textarea');
  el.value=txt;el.style.position='fixed';el.style.opacity='0';
  document.body.appendChild(el);el.focus();el.select();
  try{document.execCommand('copy');showToast('Lista copiada!','ğŸ“‹');}
  catch(e){alert(txt);}
  document.body.removeChild(el);
}

// ===== ADMIN =====
function mudarTab(tab){
  tabAtiva=tab;
  syncAdminTabs();
  renderAdminForm();
  // Recarregar dados privados ao abrir tabs sensÃ­veis
  if(['solicitacoes','clientes','contribuicoes','ocorrencias','logs_admin'].includes(tab) && adminLogado){
    carregarDadosAdmin().then(()=>renderAdminForm()).catch(()=>{});
  }
}
function renderAdminForm(){
  const form=document.getElementById('adminForm');

  // ===== VISÃƒO GERAL =====
  if(tabAtiva==='visao_geral'){
    const totalPrecos=db.precos.length;
    const promosAtivas=db.promocoes.filter(p=>p.ativa).length;
    const pendentes=db.contribuicoes.filter(c=>c.status==='pendente').length;
    const parceiros=db.mercados.filter(m=>m.parceiro).length;

    form.innerHTML=`
      <!-- STATS GERAIS -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div style="background:var(--card2);border-radius:12px;padding:14px;text-align:center;border:1px solid var(--borda);">
          <div style="font-family:var(--font-title);font-size:28px;font-weight:800;color:var(--verde);">${db.mercados.length}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">ğŸª Mercados</div>
        </div>
        <div style="background:var(--card2);border-radius:12px;padding:14px;text-align:center;border:1px solid var(--borda);">
          <div style="font-family:var(--font-title);font-size:28px;font-weight:800;color:var(--azul);">${db.produtos.length}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">ğŸ¥« Produtos</div>
        </div>
        <div style="background:var(--card2);border-radius:12px;padding:14px;text-align:center;border:1px solid var(--borda);">
          <div style="font-family:var(--font-title);font-size:28px;font-weight:800;color:var(--amarelo);">${promosAtivas}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">ğŸ”¥ PromoÃ§Ãµes</div>
        </div>
        <div style="background:var(--card2);border-radius:12px;padding:14px;text-align:center;border:1px solid var(--borda);">
          <div style="font-family:var(--font-title);font-size:28px;font-weight:800;color:${pendentes>0?'var(--vermelho)':'var(--verde)'};">${pendentes}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">ğŸ“¥ Pendentes</div>
        </div>
      </div>

      ${db.produtos.length < 280 ? `
      <div style="background:#FFF8E7;border:1.5px solid #FCD34D;border-radius:12px;padding:12px;display:flex;align-items:center;gap:10px;">
        <span style="font-size:22px;">ğŸ“¦</span>
        <div style="flex:1;">
          <div style="font-size:13px;font-weight:700;color:#92400E;">CatÃ¡logo incompleto (${db.produtos.length}/280)</div>
          <div style="font-size:11px;color:var(--muted);">Clique para adicionar os produtos faltantes ao banco</div>
        </div>
        <button onclick="completarCatalogo()" style="background:#F59E0B;color:#fff;border:none;border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;">+ Completar</button>
      </div>` : ''}

      <!-- MERCADOS CADASTRADOS -->
      <div style="font-family:var(--font-title);font-size:15px;font-weight:700;margin-top:4px;">ğŸª Mercados Cadastrados</div>
      ${db.mercados.map(m=>{
        const mPrecos=db.precos.filter(p=>String(p.mercadoId)===String(m.id||m._id));
        const mPromos=db.promocoes.filter(p=>String(p.mercadoId)===String(m.id||m._id)&&p.ativa);
        const planoColor={Pro:'var(--azul)',Premium:'var(--amarelo)',BÃ¡sico:'var(--verde)'}[m.plano]||'var(--muted)';
        const nobanco=isMongoId(String(m.id||m._id));
        return`<div style="background:var(--card2);border-radius:14px;border:1.5px solid ${!nobanco?'#DC262650':m.parceiro?'var(--verde)30':'var(--borda)'};overflow:hidden;">
          ${!nobanco?`<div style="background:#DC262615;padding:8px 14px;font-size:11px;color:#DC2626;font-weight:700;display:flex;align-items:center;gap:6px;">âš ï¸ Mercado salvo sÃ³ localmente â€” exclua e recadastre para persistir no banco</div>`:''}
          <div style="padding:14px;display:flex;align-items:center;gap:12px;">
            <div style="width:44px;height:44px;background:var(--card);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;">${m.icone}</div>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:700;font-size:14px;display:flex;align-items:center;gap:6px;">
                ${m.nome}
                ${m.parceiro?`<span style="background:${planoColor}20;color:${planoColor};font-size:10px;padding:2px 7px;border-radius:100px;font-weight:700;">${m.plano}</span>`:''}
                ${nobanco?'':'<span style="background:#DC262620;color:#DC2626;font-size:10px;padding:2px 7px;border-radius:100px;font-weight:700;">âš ï¸ Local</span>'}
              </div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">ğŸ“ ${m.endereco}</div>
              <div style="font-size:11px;color:var(--verde);margin-top:1px;">ğŸ˜ï¸ ${m.bairro}</div>
              ${m.website?`<div style="font-size:11px;margin-top:2px;"><a href="${m.website}" target="_blank" style="color:var(--azul);text-decoration:none;">ğŸŒ ${m.website.replace(/^https?:\/\//,'').substring(0,30)}...</a></div>`:''}
            </div>
            <button onclick="toggleMercadoDetalhe('vg-merc-${m._id||m.id}')" style="background:var(--card);border:1px solid var(--borda);border-radius:8px;padding:6px 10px;color:var(--muted);font-size:11px;cursor:pointer;flex-shrink:0;">Ver</button>
          </div>
          <div style="display:flex;gap:0;border-top:1px solid var(--borda);">
            <div style="flex:1;padding:10px;text-align:center;border-right:1px solid var(--borda);">
              <div style="font-family:var(--font-title);font-size:16px;font-weight:700;color:var(--verde);">${mPrecos.length}</div>
              <div style="font-size:10px;color:var(--muted);">preÃ§os</div>
            </div>
            <div style="flex:1;padding:10px;text-align:center;border-right:1px solid var(--borda);">
              <div style="font-family:var(--font-title);font-size:16px;font-weight:700;color:var(--amarelo);">${mPromos.length}</div>
              <div style="font-size:10px;color:var(--muted);">promos</div>
            </div>
            <div style="flex:1;padding:10px;text-align:center;">
              <div style="font-size:13px;">${m.parceiro?'âœ…':'â­•'}</div>
              <div style="font-size:10px;color:var(--muted);">parceiro</div>
            </div>
          </div>
          <!-- DETALHE EXPANDÃVEL -->
          <div id="vg-merc-${m._id||m.id}" style="display:none;padding:14px;border-top:1px solid var(--borda);background:var(--card);display:none;flex-direction:column;gap:10px;">
            ${mPrecos.length>0?`
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">ğŸ’° PreÃ§os cadastrados</div>
              <div style="display:flex;flex-direction:column;gap:5px;">
                ${mPrecos.map(p=>{const prod=db.produtos.find(pr=>String(pr._id||pr.id)===String(p.produtoId));const f=freshnessInfo(p.dataAtu);return`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--card2);border-radius:8px;">
                  <span style="font-size:18px;">${prod?prod.emoji:'ğŸ“¦'}</span>
                  <span style="flex:1;font-size:12px;font-weight:500;">${prod?prod.nome:'?'}</span>
                  <span class="freshness ${f.cls}" style="font-size:10px;">${f.txt}</span>
                  <span style="font-family:var(--font-title);font-size:13px;font-weight:700;color:var(--verde);">R$ ${fmt(p.preco)}</span>
                  <button onclick="editarPrecoRapido(\'${p.produtoId}\',\'${m._id||m.id}\',${p.preco})" style="background:transparent;border:1px solid var(--borda);border-radius:6px;padding:3px 7px;font-size:10px;color:var(--muted);cursor:pointer;">âœï¸</button>
                </div>`;}).join('')}
              </div>
            </div>`:'<div style="font-size:12px;color:var(--muted);text-align:center;padding:8px;">Nenhum preÃ§o cadastrado</div>'}
            ${mPromos.length>0?`
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">ğŸ”¥ PromoÃ§Ãµes ativas</div>
              ${mPromos.map(pr=>{const prod=db.produtos.find(p=>String(p.id)===String(pr.produtoId)||String(p._id)===String(pr.produtoId));return`<div style="background:#FFD23F10;border:1px solid #FFD23F30;border-radius:8px;padding:9px 10px;display:flex;align-items:center;gap:8px;">
                <span style="font-size:17px;">${prod?prod.emoji:'ğŸ“¦'}</span>
                <div style="flex:1;"><div style="font-size:12px;font-weight:600;">${prod?prod.nome:'?'}</div><div style="font-size:11px;color:var(--muted);">${pr.descricao}</div></div>
                <div style="text-align:right;"><div style="font-size:10px;color:var(--muted);text-decoration:line-through;">R$ ${fmt(pr.precoNormal)}</div><div style="font-family:var(--font-title);font-size:13px;font-weight:700;color:var(--amarelo);">R$ ${fmt(pr.precoPromo)}</div></div>
                <button data-pid="${pr.id||pr._id}" onclick="removerPromoAdmin(this.dataset.pid)" style="background:transparent;border:none;font-size:14px;cursor:pointer;color:var(--muted);">ğŸ—‘ï¸</button>
              </div>`;}).join('')}
            </div>`:''}
            <div style="display:flex;gap:8px;">
              <button onclick="mudarTab('precos');document.getElementById('selMercado').value='${m._id||m.id}'" class="btn-sm btn-verde" style="flex:1;">+ PreÃ§o</button>
              <button onclick="mudarTab('promocoes');document.getElementById('selPromoMerc').value='${m._id||m.id}'" class="btn-sm btn-amarelo" style="flex:1;">+ Promo</button>
              <button data-mid="${m.id||m._id}" onclick="excluirMercado(this.dataset.mid)" class="btn-sm btn-danger">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>`;
      }).join('')}

      <!-- PRODUTOS CADASTRADOS -->
      <div style="font-family:var(--font-title);font-size:15px;font-weight:700;margin-top:4px;">ğŸ¥« Produtos Cadastrados</div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        ${db.produtos.map(p=>{
          const qtdMercados=db.precos.filter(pr=>String(pr.produtoId)===String(p.id)).length;
          const menorPreco=db.precos.filter(pr=>String(pr.produtoId)===String(p.id));
          const min=menorPreco.length?Math.min(...menorPreco.map(pr=>pr.preco)):null;
          return`<div style="background:var(--card2);border-radius:12px;padding:12px;display:flex;align-items:center;gap:10px;border:1px solid var(--borda);">
            <div style="width:40px;height:40px;background:var(--card);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">${p.emoji}</div>
            <div style="flex:1;">
              <div style="font-size:13px;font-weight:600;">${p.nome}</div>
              <div style="font-size:11px;color:var(--muted);margin-top:1px;">${p.categoria} â€¢ ${qtdMercados} mercado(s)</div>
            </div>
            ${min!==null?`<div style="text-align:right;"><div style="font-size:10px;color:var(--muted);">a partir de</div><div style="font-family:var(--font-title);font-size:14px;font-weight:700;color:var(--verde);">R$ ${fmt(min)}</div></div>`:'<span style="font-size:11px;color:var(--muted);">Sem preÃ§o</span>'}
          </div>`;
        }).join('')}
      </div>

      <!-- PROMOÃ‡Ã•ES ATIVAS -->
      ${db.promocoes.filter(p=>p.ativa).length>0?`
      <div style="font-family:var(--font-title);font-size:15px;font-weight:700;margin-top:4px;">ğŸ”¥ PromoÃ§Ãµes Ativas</div>
      ${db.promocoes.filter(p=>p.ativa).map(pr=>{
        const prod=db.produtos.find(p=>String(p.id)===String(pr.produtoId)||String(p._id)===String(pr.produtoId));
        const merc=db.mercados.find(m=>String(m.id)===String(pr.mercadoId)||String(m._id)===String(pr.mercadoId));
        const desc=Math.round((1-(pr.precoPromo/pr.precoNormal))*100);
        return`<div style="background:linear-gradient(135deg,#FFD23F10,#FF704310);border:1px solid #FFD23F30;border-radius:13px;padding:13px;display:flex;align-items:center;gap:10px;">
          <span style="font-size:26px;">${prod?prod.emoji:'ğŸ“¦'}</span>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;">${prod?prod.nome:'?'}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px;">ğŸª ${merc?merc.nome:'?'} â€¢ AtÃ© ${pr.validade}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:1px;">${pr.descricao}</div>
          </div>
          <div style="text-align:right;flex-shrink:0;">
            <div style="font-size:10px;color:var(--muted);text-decoration:line-through;">R$ ${fmt(pr.precoNormal)}</div>
            <div style="font-family:var(--font-title);font-size:16px;font-weight:800;color:var(--amarelo);">R$ ${fmt(pr.precoPromo)}</div>
            <div style="background:#FF525220;color:var(--vermelho);font-size:10px;font-weight:700;padding:2px 6px;border-radius:100px;margin-top:2px;">-${desc}%</div>
          </div>
        </div>`;
      }).join('')}`:''}
    `;
  } else if(tabAtiva==='contribuicoes'){
    const pendentes=db.contribuicoes.filter(c=>c.status==='pendente');
    const aprovadas=db.contribuicoes.filter(c=>c.status==='aprovado');
    form.innerHTML=`
      <div style="display:flex;gap:8px;">
        <div style="flex:1;background:var(--card2);border-radius:12px;padding:12px;text-align:center;"><div style="font-family:var(--font-title);font-size:22px;font-weight:800;color:var(--amarelo);">${pendentes.length}</div><div style="font-size:11px;color:var(--muted);">Pendentes</div></div>
        <div style="flex:1;background:var(--card2);border-radius:12px;padding:12px;text-align:center;"><div style="font-family:var(--font-title);font-size:22px;font-weight:800;color:var(--verde);">${aprovadas.length}</div><div style="font-size:11px;color:var(--muted);">Aprovadas</div></div>
        <div style="flex:1;background:var(--card2);border-radius:12px;padding:12px;text-align:center;"><div style="font-family:var(--font-title);font-size:22px;font-weight:800;color:var(--vermelho);">${db.contribuicoes.filter(c=>c.status==='recusado').length}</div><div style="font-size:11px;color:var(--muted);">Recusadas</div></div>
      </div>
      ${pendentes.length===0?`<div style="text-align:center;padding:40px 0;color:var(--muted);"><div style="font-size:40px;margin-bottom:10px;">âœ…</div><div>Nenhuma contribuiÃ§Ã£o pendente</div></div>`:''}
      ${pendentes.map(c=>{
        const prod=db.produtos.find(p=>String(p._id||p.id)===String(c.produtoId));
        const merc=db.mercados.find(m=>String(m._id||m.id)===String(c.mercadoId));
        return`<div class="contrib-card">
          ${c.fotoUrl?`<img class="contrib-img" src="${c.fotoUrl}">`:''}
          <div class="contrib-body-card">
            <div class="contrib-meta">
              <span style="font-size:11px;background:var(--card2);padding:2px 8px;border-radius:100px;">${c.tipo==='foto'?'ğŸ“· Foto':'âœï¸ Texto'}</span>
              ${c.tipo==='report'?'<span style="font-size:11px;background:#FF525218;color:var(--vermelho);padding:2px 8px;border-radius:100px;">âš ï¸ Report</span>':''}
              <span class="contrib-autor">ğŸ‘¤ ${c.autor} â€¢ ${c.data}</span>
            </div>
            <div style="font-size:14px;font-weight:600;">${prod?prod.emoji+' '+prod.nome:'Produto desconhecido'}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;">ğŸª ${merc?merc.nome:'Mercado desconhecido'}</div>
            ${c.preco?`<div style="font-family:var(--font-title);font-size:20px;font-weight:800;color:var(--verde);margin-top:6px;">R$ ${fmt(c.preco)}</div>`:''}
            ${c.motivo?`<div style="font-size:12px;color:var(--muted);margin-top:4px;">Motivo: ${c.motivo}</div>`:''}
            ${c.obs?`<div style="font-size:12px;color:var(--muted);margin-top:2px;">"${c.obs}"</div>`:''}
            <div class="contrib-actions">
              <button class="btn-sm btn-verde" data-cid="${c.id||c._id}" onclick="aprovarContrib(this.dataset.cid)">âœ“ Aprovar e Publicar</button>

            </div>
          </div>
        </div>`;
      }).join('')}`;

  }else if(tabAtiva==='clientes'){
    const bloqueados=db.clientes.filter(c=>c.bloqueado);
    const ativos=db.clientes.filter(c=>!c.bloqueado);
    const todos=db.clientes;
    form.innerHTML=`
      <!-- STATS -->
      <div style="display:flex;gap:8px;margin-bottom:2px;">
        <div style="flex:1;background:#fff;border:1.5px solid var(--borda);border-radius:12px;padding:12px;text-align:center;">
          <div style="font-family:var(--font-title);font-size:24px;font-weight:900;color:var(--verde);">${ativos.length}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:700;">Ativos</div>
        </div>
        <div style="flex:1;background:#fff;border:1.5px solid #FCA5A5;border-radius:12px;padding:12px;text-align:center;">
          <div style="font-family:var(--font-title);font-size:24px;font-weight:900;color:#DC2626;">${bloqueados.length}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:700;">Bloqueados</div>
        </div>
        <div style="flex:1;background:#fff;border:1.5px solid var(--borda);border-radius:12px;padding:12px;text-align:center;">
          <div style="font-family:var(--font-title);font-size:24px;font-weight:900;color:var(--azul);">${todos.length}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:700;">Total</div>
        </div>
      </div>

      <!-- LISTA COMPLETA -->
      <div style="font-family:var(--font-title);font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;">
        Todos os Clientes (${todos.length})
      </div>

      ${todos.length===0?'<div style="text-align:center;color:var(--muted);padding:40px 0;font-size:13px;">Nenhum cliente cadastrado ainda</div>':
        todos.map(c=>{
          const cid=String(c._id||c.id);
          const status=c.bloqueado
            ?'<span style="font-size:10px;background:#FEE2E2;color:#DC2626;padding:2px 8px;border-radius:100px;font-weight:700;">ğŸ”’ Bloqueado</span>'
            :'<span style="font-size:10px;background:#DCFCE7;color:var(--verde-dk);padding:2px 8px;border-radius:100px;font-weight:700;">âœ… Ativo</span>';
          return`<div style="background:#fff;border:1.5px solid var(--borda);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px;">

            <!-- CabeÃ§alho do card -->
            <div style="display:flex;align-items:center;gap:10px;">
              <div style="width:42px;height:42px;background:${c.bloqueado?'#FEE2E2':'#DBEAFE'};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">ğŸ‘¤</div>
              <div style="flex:1;min-width:0;">
                <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.nome}</div>
                <div style="font-size:11px;color:var(--muted);">Login: <strong>${c.login||'â€”'}</strong></div>
              </div>
              ${status}
            </div>

            <!-- Dados de cadastro -->
            <div style="background:var(--card2);border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:5px;">
              <div style="display:flex;gap:6px;align-items:center;font-size:12px;">
                <span style="font-size:14px;">ğŸ“±</span>
                <span style="color:var(--muted);">Telefone:</span>
                <strong style="flex:1;">${c.telefone||'NÃ£o informado'}</strong>
              </div>
              <div style="display:flex;gap:6px;align-items:center;font-size:12px;">
                <span style="font-size:14px;">âœ‰ï¸</span>
                <span style="color:var(--muted);">E-mail:</span>
                <strong style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.email||'NÃ£o informado'}</strong>
              </div>
              <div style="display:flex;gap:6px;align-items:center;font-size:12px;">
                <span style="font-size:14px;">ğŸ“</span>
                <span style="color:var(--muted);">Bairro:</span>
                <strong>${c.bairro||'â€”'}</strong>
              </div>
              <div style="display:flex;gap:6px;align-items:center;font-size:12px;">
                <span style="font-size:14px;">ğŸ“…</span>
                <span style="color:var(--muted);">Cadastro:</span>
                <strong>${c.dataCadastro||c.criadoEm?new Date(c.criadoEm||c.dataCadastro).toLocaleDateString('pt-BR'):'â€”'}</strong>
              </div>
              <div style="display:flex;gap:8px;margin-top:2px;">
                <span style="font-size:10px;background:#DBEAFE;color:var(--azul);padding:2px 8px;border-radius:100px;font-weight:700;">${c.totalContribuicoes||0} contribuiÃ§Ãµes</span>
                ${c.errosConsecutivos>0?`<span style="font-size:10px;background:#FEF9C3;color:#92400E;padding:2px 8px;border-radius:100px;font-weight:700;">âš ï¸ ${c.errosConsecutivos} erros</span>`:''}
                ${c.motivoBloqueio?`<span style="font-size:10px;background:#FEE2E2;color:#DC2626;padding:2px 8px;border-radius:100px;font-weight:700;">ğŸ”’ ${c.motivoBloqueio.substring(0,20)}</span>`:''}
              </div>
            </div>

            <!-- AÃ§Ãµes -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
              <button data-cid="${cid}" onclick="abrirEditarCliente(this.dataset.cid)"
                style="background:var(--azul);border:none;border-radius:9px;color:#fff;padding:9px;font-size:12px;font-weight:700;cursor:pointer;">
                âœï¸ Editar dados
              </button>
              <button data-cid="${cid}" onclick="abrirAlterarSenhaCliente(this.dataset.cid)"
                style="background:var(--card2);border:1.5px solid var(--borda);border-radius:9px;color:var(--texto);padding:9px;font-size:12px;font-weight:700;cursor:pointer;">
                ğŸ”‘ Alterar senha
              </button>
              ${c.bloqueado
                ?`<button data-cid="${cid}" onclick="desbloquearCliente(this.dataset.cid)"
                    style="background:var(--verde);border:none;border-radius:9px;color:#fff;padding:9px;font-size:12px;font-weight:700;cursor:pointer;">
                    âœ… Desbloquear
                  </button>`
                :`<button data-cid="${cid}" onclick="bloquearCliente(this.dataset.cid)"
                    style="background:transparent;border:1.5px solid #F59E0B;border-radius:9px;color:#92400E;padding:9px;font-size:12px;font-weight:700;cursor:pointer;">
                    ğŸ”’ Bloquear
                  </button>`}
              <button data-cid="${cid}" onclick="excluirCliente(this.dataset.cid)"
                style="background:transparent;border:1.5px solid #DC2626;border-radius:9px;color:#DC2626;padding:9px;font-size:12px;font-weight:700;cursor:pointer;">
                ğŸ—‘ï¸ Excluir
              </button>
            </div>
          </div>`;
        }).join('')
      }`;

  }else if(tabAtiva==='suporte_admin'){
    form.innerHTML=`
      <div style="font-family:var(--font-title);font-size:15px;font-weight:700;">ğŸ’¬ Conversas de Suporte</div>
      <div style="background:var(--card2);border-radius:12px;padding:12px;font-size:12px;color:var(--muted);">Mensagens enviadas pelos usuÃ¡rios. Clique para ver o histÃ³rico completo.</div>
      <div style="display:flex;flex-direction:column;gap:8px;">${renderAdminChats()}</div>`;

  }else if(tabAtiva==='logs_admin'){
    form.innerHTML=`
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-family:var(--font-title);font-size:15px;font-weight:700;">ğŸ“‹ Logs do Sistema</div>
        <button onclick="db.logs=[];renderAdminForm();" style="background:transparent;border:1px solid var(--vermelho);color:var(--vermelho);border-radius:8px;padding:5px 10px;font-size:11px;cursor:pointer;">Limpar</button>
      </div>
      <div style="background:var(--card2);border-radius:12px;padding:10px;font-size:11px;color:var(--muted);">Exibindo os Ãºltimos 50 registros â€¢ Total: ${db.logs.length}</div>
      <div style="display:flex;flex-direction:column;gap:6px;">${renderAdminLogs()}</div>`;

  }else if(tabAtiva==='localizacao'){
    form.innerHTML=`
      <div style="background:var(--card2);border:1px solid var(--verde);border-radius:13px;padding:14px;display:flex;align-items:center;gap:12px;">
        <span style="font-size:28px;">ğŸ“</span>
        <div><div style="font-family:var(--font-title);font-weight:700;font-size:16px;">${config.cidade}, ${config.estado}</div><div style="font-size:12px;color:var(--muted);">LocalizaÃ§Ã£o atual</div></div>
        <button onclick="abrirMapaExterno()" style="margin-left:auto;background:var(--azul);border:none;border-radius:8px;color:#fff;font-size:11px;padding:6px 11px;cursor:pointer;">Maps</button>
      </div>
      <div style="background:var(--card2);border-radius:13px;overflow:hidden;">
        <div id="mapaContainer" onclick="carregarMapa(this,'${config.cidade},${config.estado}')" style="height:240px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;cursor:pointer;">
          <span style="font-size:36px;">ğŸ—ºï¸</span>
          <span style="font-size:13px;color:var(--muted);">Toque para ver o mapa</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <input type="text" class="input-field" id="mapaBuscaInput" placeholder="Buscar cidade..." value="${config.cidade}, ${config.estado}" style="flex:1;">
        <button onclick="buscarCidadeMapa()" style="background:var(--verde);border:none;border-radius:12px;padding:0 18px;color:#000;font-weight:700;cursor:pointer;">IR</button>
      </div>
      <div><div class="field-label">Cidade</div><input type="text" class="input-field" id="inputCidade" value="${config.cidade}"></div>
      <div><div class="field-label">Estado (sigla)</div><input type="text" class="input-field" id="inputEstado" value="${config.estado}" maxlength="2" style="text-transform:uppercase;"></div>
      <div><div class="field-label">WhatsApp do Admin</div><input type="tel" class="input-field" id="inputWhats" value="${config.whatsapp}"></div>
      <button class="btn-primary" onclick="salvarLocalizacao()">ğŸ’¾ Salvar</button>`;

  }else if(tabAtiva==='precos'){
    form.innerHTML=`
      <div style="background:var(--card2);border:1.5px solid var(--borda);border-radius:13px;padding:13px;font-size:13px;color:var(--muted);line-height:1.5;">
        ğŸ’° <strong style="color:var(--texto);">Adicionar ou atualizar preÃ§o</strong> â€” busque o produto pelo nome.
      </div>
      <div>
        <div class="field-label">ğŸ” Produto â€” comece a digitar para buscar</div>
        <div class="ac-wrap">
          <input type="text" class="input-field" id="selProdutoInput" placeholder="Ex: Arroz Camil, Leite..." autocomplete="off">
          <div class="ac-list" id="selProdutoList"></div>
        </div>
        <input type="hidden" id="selProduto" value="">
      </div>
      <div><div class="field-label">Mercado</div>
        <select class="input-field" id="selMercado"><option value="">Selecione o mercado...</option>${db.mercados.map(m=>`<option value="${m._id||m.id}">${m.icone} ${m.nome}</option>`).join('')}</select></div>
      <div><div class="field-label">PreÃ§o (R$)</div>
        <input type="number" class="input-field" id="inputPreco" placeholder="Ex: 9.90" step="0.01" min="0"></div>
      <button class="btn-primary" onclick="salvarPrecoAdmin()">ğŸ’¾ Salvar PreÃ§o</button>`;
    setTimeout(()=>{
      const inp=document.getElementById('selProdutoInput');
      const lst=document.getElementById('selProdutoList');
      if(inp&&lst) criarAutocomplete(inp,lst,p=>{
        document.getElementById('selProduto').value=p._id||p.id;
      });
    },50);

  }else if(tabAtiva==='produto'){
    form.innerHTML=`
      <div style="background:var(--card2);border:1.5px solid var(--borda);border-radius:13px;padding:13px;font-size:13px;color:var(--muted);line-height:1.5;">
        ğŸ“¦ <strong style="color:var(--texto);">Adicionar novo produto</strong> ao catÃ¡logo.
      </div>
      <div>
        <div class="field-label">ğŸ” Verificar existÃªncia â€” busque antes de adicionar</div>
        <div class="ac-wrap">
          <input type="text" class="input-field" id="inputProdNome" placeholder="Ex: MacarrÃ£o InstantÃ¢neo Nissin 85g" autocomplete="off"
            oninput="this.nextElementSibling?.nextElementSibling||null">
          <div class="ac-list" id="inputProdNomeList"></div>
        </div>
      </div>
      <div><div class="field-label">Emoji do produto</div>
        <input type="text" class="input-field" id="inputProdEmoji" placeholder="Ex: ğŸœ"></div>
      <div><div class="field-label">Categoria</div>
        <input type="text" class="input-field" id="inputProdCat" placeholder="Ex: Massas"></div>
      <button class="btn-primary" onclick="salvarProduto()">â• Adicionar Produto</button>
      <div style="font-family:var(--font-title);font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-top:4px;">Produtos cadastrados (${db.produtos.length})</div>
      ${db.produtos.slice().sort((a,b)=>a.nome.localeCompare(b.nome)).map(p=>`
        <div style="background:#fff;border:1.5px solid var(--borda);border-radius:10px;padding:10px 13px;display:flex;align-items:center;gap:10px;font-size:13px;box-shadow:0 1px 4px rgba(11,79,138,.05);">
          <span style="font-size:20px;">${p.emoji}</span>
          <span style="flex:1;font-weight:600;color:var(--texto);">${p.nome}</span>
          <span style="background:#F0F6FF;color:var(--azul);font-size:10px;font-weight:700;padding:2px 8px;border-radius:100px;">${p.categoria}</span>
        </div>`).join('')}`;
    setTimeout(()=>{
      const inp=document.getElementById('inputProdNome');
      const lst=document.getElementById('inputProdNomeList');
      if(inp&&lst) criarAutocomplete(inp,lst,p=>{
        // Preenche os campos com o produto encontrado para fÃ¡cil ediÃ§Ã£o
        inp.value=p.nome;
        const emojiEl=document.getElementById('inputProdEmoji');
        const catEl=document.getElementById('inputProdCat');
        if(emojiEl) emojiEl.value=p.emoji;
        if(catEl) catEl.value=p.categoria;
        showToast(`Produto "${p.nome}" jÃ¡ existe no catÃ¡logo!`,'â„¹ï¸');
      });
    },50);

  }else if(tabAtiva==='mercado'){
    form.innerHTML=`
      <!-- IMPORTAR POR URL OU FOTO -->
      <div style="background:linear-gradient(135deg,#4A9EFF18,#9B59B618);border:1px solid #4A9EFF30;border-radius:14px;padding:16px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <span style="font-size:24px;">ğŸ¤–</span>
          <div>
            <div style="font-family:var(--font-title);font-size:15px;font-weight:700;">Importar com IA</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;">Tire uma foto da tela do Google Maps ou cole o link. A IA extrai nome, endereÃ§o e telefone automaticamente.</div>
          </div>
        </div>

        <!-- Abas: Foto / Link -->
        <div style="display:flex;gap:6px;margin-bottom:12px;">
          <button id="btnTabFotoMaps" onclick="setImportTab('foto')" style="flex:1;padding:8px;border-radius:10px;border:1.5px solid var(--azul);background:var(--azul);color:#fff;font-weight:700;font-size:12px;cursor:pointer;">ğŸ“· Foto do Maps</button>
          <button id="btnTabLinkMaps" onclick="setImportTab('link')" style="flex:1;padding:8px;border-radius:10px;border:1.5px solid var(--borda);background:transparent;color:var(--muted);font-weight:700;font-size:12px;cursor:pointer;">ğŸ”— Link / URL</button>
        </div>

        <!-- Aba Foto -->
        <div id="importTabFoto">
          <div onclick="document.getElementById('fotoMapsInput').click()" style="border:2px dashed var(--azul);border-radius:12px;padding:20px;text-align:center;cursor:pointer;background:#4A9EFF08;">
            <div style="font-size:32px;margin-bottom:6px;">ğŸ“¸</div>
            <div style="font-size:13px;font-weight:700;color:var(--azul);">Tirar foto ou escolher imagem</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">Print da tela do Google Maps com os dados do mercado</div>
          </div>
          <input type="file" id="fotoMapsInput" accept="image/*" capture="environment" style="display:none" onchange="analisarFotoMaps(this)">
          <div id="fotoMapsPreview" style="display:none;margin-top:10px;text-align:center;">
            <img id="fotoMapsImg" style="max-width:100%;max-height:200px;border-radius:10px;object-fit:cover;">
          </div>
        </div>

        <!-- Aba Link -->
        <div id="importTabLink" style="display:none;">
          <div style="display:flex;gap:8px;">
            <input type="url" class="input-field" id="inputUrlMercado" placeholder="https://maps.app.goo.gl/... ou Instagram, iFood" style="flex:1;font-size:13px;">
            <button onclick="importarPorURL()" style="background:var(--azul);border:none;border-radius:12px;padding:0 16px;color:#fff;font-weight:700;font-size:13px;cursor:pointer;flex-shrink:0;">ğŸ” Buscar</button>
          </div>
        </div>

        <div id="urlImportStatus" style="display:none;margin-top:10px;"></div>
        <div id="urlImportResult" style="display:none;margin-top:12px;flex-direction:column;gap:10px;">
          <div style="font-size:12px;color:var(--azul);font-weight:600;">âœ¨ Dados encontrados â€” confirme e salve:</div>
          <div id="urlImportPreview" style="background:var(--card2);border-radius:12px;padding:14px;display:flex;gap:12px;align-items:center;">
          </div>
          <div id="urlImportForm" style="display:flex;flex-direction:column;gap:10px;">
            <div><div class="field-label">Nome do Mercado</div><input type="text" class="input-field" id="urlMercNome" placeholder="Nome do mercado"></div>
            <div><div class="field-label">EndereÃ§o</div><input type="text" class="input-field" id="urlMercEnd" placeholder="EndereÃ§o encontrado ou informe"></div>
            <div><div class="field-label">Bairro</div><input type="text" class="input-field" id="urlMercBairro" placeholder="Bairro"></div>
            <div><div class="field-label">WhatsApp</div><input type="tel" class="input-field" id="urlMercWhats" placeholder="(77) 99999-9999"></div>
            <div><div class="field-label">Website / Link</div><input type="url" class="input-field" id="urlMercWebsite" placeholder="URL do site"></div>
            <div><div class="field-label">Emoji / Ãcone</div><input type="text" class="input-field" id="urlMercIcone" placeholder="ğŸª" value="ğŸª"></div>
            <div style="background:var(--card2);border-radius:12px;padding:12px;display:flex;align-items:center;gap:12px;">
              <div style="flex:1;"><div style="font-size:13px;font-weight:500;">Marcar como parceiro?</div></div>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="urlMercParceiro" style="width:18px;height:18px;accent-color:var(--verde);"><span>Sim</span></label>
            </div>
            <div><div class="field-label">Plano</div><select class="input-field" id="urlMercPlano"><option value="">Sem plano</option><option value="BÃ¡sico">BÃ¡sico</option><option value="Pro">Pro</option><option value="Premium">Premium</option></select></div>
            <div><div class="field-label">UsuÃ¡rio de acesso</div><input type="text" class="input-field" id="urlMercUser" placeholder="Ex: mercado_silva"></div>
            <div><div class="field-label">Senha de acesso</div><input type="text" class="input-field" id="urlMercSenha" placeholder="Defina uma senha"></div>
            <button class="btn-primary" onclick="salvarMercadoURL()">âœ… Confirmar e Salvar Mercado</button>
          </div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px;"><div style="flex:1;height:1px;background:var(--borda);"></div><span style="font-size:12px;color:var(--muted);padding:0 8px;">ou adicionar manualmente</span><div style="flex:1;height:1px;background:var(--borda);"></div></div>

      <div><div class="field-label">Nome *</div><input type="text" class="input-field" id="inputMercNome" placeholder="Ex: Supermercado Silva"></div>
      <div><div class="field-label">Emoji</div><input type="text" class="input-field" id="inputMercEmoji" placeholder="ğŸª"></div>
      <div><div class="field-label">EndereÃ§o * <span style="color:var(--vermelho);">obrigatÃ³rio</span></div><input type="text" class="input-field" id="inputMercEnd" placeholder="Rua, nÃºmero"></div>
      <div><div class="field-label">Bairro * <span style="color:var(--vermelho);">obrigatÃ³rio</span></div><input type="text" class="input-field" id="inputMercBairro" placeholder="Ex: Centro"></div>
      <div><div class="field-label">WhatsApp * <span style="color:var(--vermelho);">obrigatÃ³rio</span></div><input type="tel" class="input-field" id="inputMercWhats" placeholder="(75) 99999-9999"></div>
      
      <!-- LocalizaÃ§Ã£o no mapa -->
      <div style="background:var(--card2);border-radius:12px;padding:13px;">
        <div class="field-label" style="margin-bottom:8px;">ğŸ“ LocalizaÃ§Ã£o no Mapa</div>
        <div id="mercLatLngInfo" style="font-size:12px;color:var(--muted);margin-bottom:8px;">Nenhuma localizaÃ§Ã£o definida</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button onclick="usarGPSMercado()" style="background:var(--azul);color:#fff;border:none;border-radius:8px;padding:9px 14px;font-size:12px;font-weight:700;cursor:pointer;flex:1;">ğŸ“¡ Usar meu GPS</button>
          <button onclick="abrirMapaMercado()" style="background:var(--card);border:1.5px solid var(--borda2);color:var(--texto);border-radius:8px;padding:9px 14px;font-size:12px;font-weight:700;cursor:pointer;flex:1;">ğŸ—ºï¸ Marcar no Mapa</button>
        </div>
        <div id="mercMapaPreview" style="margin-top:8px;border-radius:10px;overflow:hidden;display:none;"></div>
        <input type="hidden" id="inputMercLat">
        <input type="hidden" id="inputMercLng">
      </div>

      <div><div class="field-label">Website (opcional)</div><input type="url" class="input-field" id="inputMercWebsite" placeholder="https://..."></div>
      <div style="background:var(--card2);border-radius:12px;padding:13px;display:flex;align-items:center;gap:12px;">
        <div style="flex:1;"><div style="font-size:13px;font-weight:500;">Ã‰ parceiro?</div><div style="font-size:11px;color:var(--muted);">Parceiros tÃªm badge e podem atualizar preÃ§os</div></div>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="inputMercParceiro" style="width:18px;height:18px;accent-color:var(--verde);"><span>Sim</span></label>
      </div>
      <div><div class="field-label">Plano</div><select class="input-field" id="inputMercPlano"><option value="">Sem plano</option><option value="BÃ¡sico">BÃ¡sico</option><option value="Pro">Pro</option><option value="Premium">Premium</option></select></div>
      <div><div class="field-label">UsuÃ¡rio de acesso</div><input type="text" class="input-field" id="inputMercUser" placeholder="Ex: mercado_silva"></div>
      <div><div class="field-label">Senha de acesso</div><input type="text" class="input-field" id="inputMercSenha" placeholder="Defina uma senha"></div>
      <button class="btn-primary" onclick="salvarMercado()">â• Adicionar Mercado</button>`;

  }else if(tabAtiva==='promocoes'){
    form.innerHTML=`
      <div>
        <div class="field-label">ğŸ” Produto â€” comece a digitar para buscar</div>
        <div class="ac-wrap">
          <input type="text" class="input-field" id="selPromoProdInput" placeholder="Ex: Coca-Cola, Arroz..." autocomplete="off">
          <div class="ac-list" id="selPromoProdList"></div>
        </div>
        <input type="hidden" id="selPromoProd" value="">
      </div>
      <div><div class="field-label">Mercado</div>
        <select class="input-field" id="selPromoMerc"><option value="">Selecione o mercado...</option>${db.mercados.map(m=>`<option value="${m._id||m.id}">${m.icone} ${m.nome}</option>`).join('')}</select></div>
      <div style="display:flex;gap:8px;">
        <div style="flex:1;"><div class="field-label">PreÃ§o normal (R$)</div><input type="number" class="input-field" id="inputPromoNormal" placeholder="Ex: 16.50" step="0.01"></div>
        <div style="flex:1;"><div class="field-label">PreÃ§o promo (R$)</div><input type="number" class="input-field" id="inputPromoPreco" placeholder="Ex: 13.90" step="0.01"></div>
      </div>
      <div><div class="field-label">VÃ¡lido atÃ©</div><input type="date" class="input-field" id="inputPromoVal"></div>
      <div><div class="field-label">DescriÃ§Ã£o</div><input type="text" class="input-field" id="inputPromoDesc" placeholder="Ex: Oferta especial!"></div>
      <button class="btn-primary" onclick="salvarPromocaoAdmin()">ğŸ”¥ Publicar PromoÃ§Ã£o</button>
      <div style="font-family:var(--font-title);font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-top:6px;">PromoÃ§Ãµes ativas (${db.promocoes.filter(p=>p.ativa).length})</div>
      ${db.promocoes.map(pr=>{
        const prod=db.produtos.find(p=>String(p.id)===String(pr.produtoId)||String(p._id)===String(pr.produtoId));
        const merc=db.mercados.find(m=>String(m.id)===String(pr.mercadoId)||String(m._id)===String(pr.mercadoId));
        const pid=pr.id||pr._id;
        return`<div style="background:#fff;border:1.5px solid var(--borda);border-radius:12px;padding:12px;box-shadow:0 1px 4px rgba(11,79,138,.06);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:13px;font-weight:700;">${prod?prod.emoji+' '+prod.nome:'?'}</span>
            <button data-pid="${pid}" onclick="removerPromoAdmin(this.dataset.pid)" style="background:transparent;border:none;cursor:pointer;font-size:16px;">ğŸ—‘ï¸</button>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:3px;">ğŸª ${merc?merc.nome:'?'}</div>
          <div style="font-size:12px;color:var(--amarelo);margin-top:3px;font-weight:700;">R$ ${fmt(pr.precoNormal)} â†’ R$ ${fmt(pr.precoPromo)} â€¢ AtÃ© ${pr.validade}</div>
          <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
              <input type="checkbox" data-pid="${pid}" ${pr.ativa?'checked':''} onchange="togglePromoAdmin(this.dataset.pid)" style="accent-color:var(--verde);"> ${pr.ativa?'Ativa':'Pausada'}
            </label>
          </div>
        </div>`;
      }).join('')||'<div style="color:var(--muted);text-align:center;padding:20px;">Nenhuma ainda</div>'}`;
    setTimeout(()=>{
      const inp=document.getElementById('selPromoProdInput');
      const lst=document.getElementById('selPromoProdList');
      if(inp&&lst) criarAutocomplete(inp,lst,p=>{
        document.getElementById('selPromoProd').value=p._id||p.id;
      });
    },50);
  }else if(tabAtiva==='planos_config'){
    form.innerHTML=`
      <div style="background:var(--card2);border-radius:12px;padding:13px;font-size:13px;color:var(--muted);">ğŸ’¡ Defina os valores mensais de cada plano.</div>
      <div><div class="field-label">ğŸŒ± BÃ¡sico (R$/mÃªs)</div><input type="number" class="input-field" id="inputPrecoBasico" value="${config.precos_planos.basico}" step="0.01"></div>
      <div><div class="field-label">ğŸš€ Pro (R$/mÃªs)</div><input type="number" class="input-field" id="inputPrecoPro" value="${config.precos_planos.pro}" step="0.01"></div>
      <div><div class="field-label">ğŸ’ Premium (R$/mÃªs)</div><input type="number" class="input-field" id="inputPrecoPremium" value="${config.precos_planos.premium}" step="0.01"></div>
      <button class="btn-primary" onclick="salvarPrecoPlanos()">ğŸ’¾ Salvar PreÃ§os</button>`;

  }else if(tabAtiva==='solicitacoes'){
    form.innerHTML=`
      <div style="font-size:13px;color:var(--muted);">Mercados que solicitaram cadastro.</div>
      ${db.solicitacoes.length===0?`<div style="text-align:center;padding:40px 0;color:var(--muted);"><div style="font-size:40px;margin-bottom:10px;">ğŸ“­</div><div>Nenhuma solicitaÃ§Ã£o ainda</div></div>`:db.solicitacoes.map(s=>`
        <div style="background:var(--card2);border-radius:13px;padding:14px;border:1px solid var(--borda);">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div style="font-family:var(--font-title);font-weight:700;font-size:15px;">${s.mercado}</div>
            <span style="background:${s.status==='Aprovado'?'#00C89618':s.status==='Recusado'?'#FF525218':'#FFD23F18'};color:${s.status==='Aprovado'?'var(--verde)':s.status==='Recusado'?'var(--vermelho)':'var(--amarelo)'};font-size:10px;padding:3px 8px;border-radius:100px;font-weight:700;">${s.status}</span>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px;">ğŸ‘¤ ${s.responsavel} â€¢ ğŸ“± ${s.whatsapp}</div>
          <div style="font-size:12px;color:var(--azul);margin-top:3px;">ğŸ’ Plano ${s.plano} â€¢ ${s.data}</div>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn-sm btn-verde" data-sid="${s._id||s.id}" onclick="aprovarSolic(this.dataset.sid)">âœ“ Aprovar</button>
            <button class="btn-sm btn-danger" data-sid="${s._id||s.id}" onclick="recusarSolic(this.dataset.sid)">âœ• Recusar</button>
            <button onclick="window.open('https://wa.me/55'+('${s.whatsapp}'.replace(/\\D/g,'')))" style="background:#25D366;border:none;border-radius:8px;padding:8px 12px;color:#fff;font-size:14px;cursor:pointer;">ğŸ’¬</button>
          </div>
        </div>`).join('')}`;
  }else if(tabAtiva==='usuarios'){
    // Carrega admins do banco em tempo real
    apiReq('GET','/api/admin/admins').then(adminsDB=>{
      if(adminsDB && adminsDB.length) db.admins = adminsDB.map(a=>({...a, id:a._id}));
      document.getElementById('listaAdmins').innerHTML = db.admins.map(a=>`
        <div style="background:var(--card2);border-radius:13px;padding:13px;display:flex;align-items:center;gap:10px;border:1px solid ${a.nivel==='super'?'#00C89630':'var(--borda)'};">
          <div style="width:38px;height:38px;background:${a.nivel==='super'?'#00C89620':'#4A9EFF20'};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">${a.nivel==='super'?'ğŸ‘‘':'âš™ï¸'}</div>
          <div style="flex:1;"><div style="font-weight:700;font-size:14px;">${a.nome}</div>
            <div style="font-size:11px;color:var(--muted);">@${a.usuario} â€¢ <span style="color:${a.nivel==='super'?'var(--verde)':'var(--azul)'};">${a.nivel}</span></div>
          </div>
          ${a.nivel!=='super'?`<button onclick="excluirAdmin('${a._id||a.id}')" style="background:transparent;border:1px solid var(--vermelho);color:var(--vermelho);border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;">ğŸ—‘ï¸</button>`:'<span style="font-size:11px;color:var(--muted);">Principal</span>'}
        </div>`).join('');
    }).catch(()=>{});

    form.innerHTML=`
      <div style="background:var(--card2);border-radius:12px;padding:12px;font-size:13px;color:var(--muted);">ğŸ‘¥ Gerencie logins de administrador. Parceiros sÃ£o gerenciados na aba Mercado.</div>
      <div style="font-family:var(--font-title);font-size:15px;font-weight:700;">â• Criar novo admin</div>
      <div style="background:var(--card2);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px;">
        <div><div class="field-label">Nome</div><input type="text" class="input-field" id="newAdminNome" placeholder="Ex: Carlos Admin"></div>
        <div><div class="field-label">UsuÃ¡rio</div><input type="text" class="input-field" id="newAdminUser" placeholder="Ex: carlos_adm"></div>
        <div><div class="field-label">Senha</div><input type="password" class="input-field" id="newAdminSenha" placeholder="MÃ­nimo 4 caracteres"></div>
        <div><div class="field-label">NÃ­vel</div>
          <select class="input-field" id="newAdminNivel">
            <option value="admin">Admin â€” acesso total</option>
            <option value="editor">Editor â€” sem excluir</option>
          </select>
        </div>
        <button class="btn-primary" onclick="criarAdmin()">â• Criar Admin</button>
      </div>
      <div style="font-family:var(--font-title);font-size:15px;font-weight:700;margin-top:4px;">ğŸ”‘ Admins cadastrados</div>
      <div id="listaAdmins">${db.admins.map(a=>`
        <div style="background:var(--card2);border-radius:13px;padding:13px;display:flex;align-items:center;gap:10px;border:1px solid ${a.nivel==='super'?'#00C89630':'var(--borda)'};">
          <div style="width:38px;height:38px;background:${a.nivel==='super'?'#00C89620':'#4A9EFF20'};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">${a.nivel==='super'?'ğŸ‘‘':'âš™ï¸'}</div>
          <div style="flex:1;"><div style="font-weight:700;font-size:14px;">${a.nome}</div>
            <div style="font-size:11px;color:var(--muted);">@${a.usuario} â€¢ <span style="color:${a.nivel==='super'?'var(--verde)':'var(--azul)'};">${a.nivel}</span></div>
          </div>
          ${a.nivel!=='super'?`<button onclick="excluirAdmin('${a._id||a.id}')" style="background:transparent;border:1px solid var(--vermelho);color:var(--vermelho);border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;">ğŸ—‘ï¸</button>`:'<span style="font-size:11px;color:var(--muted);">Principal</span>'}
        </div>`).join('')}</div>`;
  }else if(tabAtiva==='busca_auto'){
    form.innerHTML=`
      <div style="background:linear-gradient(135deg,#4A9EFF18,#9B59B618);border:1px solid #4A9EFF30;border-radius:14px;padding:14px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><span style="font-size:26px;">ğŸ”</span>
          <div><div style="font-family:var(--font-title);font-size:15px;font-weight:700;">Busca AutomÃ¡tica</div>
            <div style="font-size:12px;color:var(--muted);margin-top:2px;">Busca dados pÃºblicos do Google Maps e fontes abertas</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div><div class="field-label">Cidade / RegiÃ£o</div>
            <input type="text" class="input-field" id="buscaAutoLocal" value="${config.cidade}, ${config.estado}" placeholder="Ex: PiatÃ£, BA"></div>
          <div><div class="field-label">O que buscar</div>
            <select class="input-field" id="buscaAutoTipo">
              <option value="mercados">Mercados e supermercados</option>
              <option value="precos">ReferÃªncia de preÃ§os mÃ©dios</option>
              <option value="ambos">Mercados + PreÃ§os</option>
            </select></div>
          <button class="btn-primary" onclick="executarBuscaAuto()">ğŸš€ Iniciar Busca</button>
        </div>
      </div>
      <div id="buscaAutoStatusAdmin"></div>
      <div id="buscaAutoResultadosAdmin" style="display:flex;flex-direction:column;gap:8px;"></div>
      <button onclick="abrirGoogleMapsBusca()" style="background:var(--card2);border:1px solid var(--borda);border-radius:12px;padding:13px;color:var(--texto);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;width:100%;">ğŸ—ºï¸ Abrir Google Maps â€” Mercados em ${config.cidade}</button>`;
  }else if(tabAtiva==='ocorrencias'){
    const ocs=db.ocorrencias.sort((a,b)=>b.timestamp-a.timestamp);
    form.innerHTML=`
      <div style="background:linear-gradient(135deg,#DC262618,#F59E0B18);border:1px solid #DC262630;border-radius:14px;padding:14px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:26px;">ğŸš¨</span>
          <div>
            <div style="font-family:var(--font-title);font-size:15px;font-weight:700;">OcorrÃªncias de Suporte</div>
            <div style="font-size:12px;color:var(--muted);">Mensagens que precisam de atenÃ§Ã£o humana</div>
          </div>
          <div style="margin-left:auto;background:var(--vermelho);color:#fff;font-size:12px;font-weight:700;padding:4px 10px;border-radius:100px;">${ocs.filter(o=>o.status==='aberto').length} abertas</div>
        </div>
      </div>
      ${ocs.length===0?'<div style="text-align:center;color:var(--muted);padding:30px;">Nenhuma ocorrÃªncia ainda âœ…</div>':
      ocs.map(o=>`
        <div style="background:var(--card2);border:1.5px solid ${o.status==='aberto'?'#DC262640':'#1DB95440'};border-radius:13px;padding:14px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <span style="font-size:16px;">${o.status==='aberto'?'ğŸ”´':'âœ…'}</span>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:13px;">${o.cliente||'Visitante'}</div>
              <div style="font-size:11px;color:var(--muted);">${o.data} â€¢ ${o.hora}</div>
            </div>
            ${o.whatsapp?`<a href="https://wa.me/55${o.whatsapp.replace(/\D/g,'')}" target="_blank" style="background:#25D366;color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:11px;font-weight:700;text-decoration:none;">ğŸ“ WhatsApp</a>`:''}
          </div>
          <div style="background:#fff;border-radius:9px;padding:10px;font-size:13px;color:var(--texto);margin-bottom:8px;border:1px solid var(--borda);">"${o.mensagem}"</div>
          ${o.historico?`<div style="font-size:11px;color:var(--muted);margin-bottom:8px;">ğŸ“‹ HistÃ³rico: ${o.historico}</div>`:''}
          <div style="display:flex;gap:8px;">
            ${o.status==='aberto'?`<button data-oid="${o.id||o._id}" onclick="resolverOcorrencia(this.dataset.oid)" style="background:var(--verde);color:#fff;border:none;border-radius:8px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer;">âœ… Resolver</button>`:''}
            <button data-oid="${o.id||o._id}" onclick="excluirOcorrencia(this.dataset.oid)" style="background:transparent;border:1px solid var(--vermelho);color:var(--vermelho);border-radius:8px;padding:7px 12px;font-size:12px;cursor:pointer;">ğŸ—‘ï¸</button>
          </div>
        </div>`).join('')}`;
  }
} // fecha renderAdminForm
function aprovarContrib(id){
  const c=db.contribuicoes.find(x=>String(x.id||x._id)===String(id));
  if(!c)return;
  if(c.tipo==='report'){c.status='aprovado';showToast('Report registrado!','âš ï¸');renderAdminForm();return;}
  c.status='aprovado';
  const mesAno=new Date().toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}).replace('. ','/').replace('.','');
  db.historico.push({produtoId:c.produtoId,mercadoId:c.mercadoId,preco:c.preco,data:mesAno,fonte:'aprovado'});
  const idx=db.precos.findIndex(p=>String(p.produtoId)===String(c.produtoId)&&String(p.mercadoId)===String(c.mercadoId));
  const entry={produtoId:c.produtoId,mercadoId:c.mercadoId,preco:c.preco,dataAtu:c.data,fonte:'cliente',autor:c.autor};
  if(idx>=0)db.precos[idx]=entry;else db.precos.push(entry);
  // Registra sucesso na conta do cliente (reseta erros consecutivos)
  if(c.clienteId) registrarSucessoContribuicao(c.clienteId);
  showToast('ContribuiÃ§Ã£o aprovada e publicada!','âœ…');renderAdminForm();
}

async function salvarLocalizacao(){
  config.cidade=document.getElementById('inputCidade').value.trim()||config.cidade;
  config.estado=document.getElementById('inputEstado').value.trim().toUpperCase()||config.estado;
  config.whatsapp=document.getElementById('inputWhats').value.trim()||config.whatsapp;
  try {
    await Promise.all([
      apiReq('PUT','/api/config',{chave:'cidade',valor:config.cidade}),
      apiReq('PUT','/api/config',{chave:'estado',valor:config.estado}),
      apiReq('PUT','/api/config',{chave:'whatsapp',valor:config.whatsapp})
    ]);
    showToast('LocalizaÃ§Ã£o salva no banco! âœ…','ğŸ“');
  } catch(e){ showToast('LocalizaÃ§Ã£o atualizada!','ğŸ“'); }
  renderAdminForm();
}
function carregarMapa(el,q){
  const query=q||(config.cidade+','+config.estado);
  const container=el||document.getElementById('mapaContainer');
  if(!container)return;
  container.onclick=null;
  container.innerHTML=`<iframe style="width:100%;height:240px;border:none;" src="https://maps.google.com/maps?q=${encodeURIComponent(query+',Brazil')}&z=14&output=embed" allowfullscreen loading="lazy"></iframe>`;
}
function buscarCidadeMapa(){
  const q=document.getElementById('mapaBuscaInput').value.trim();
  if(!q)return;
  const c=document.getElementById('mapaContainer');
  if(c){c.onclick=null;c.innerHTML=`<iframe style="width:100%;height:240px;border:none;" src="https://maps.google.com/maps?q=${encodeURIComponent(q+', Brazil')}&z=14&output=embed" allowfullscreen loading="lazy"></iframe>`;}
}
function abrirMapaExterno(){window.open(`https://www.google.com/maps/search/${encodeURIComponent(config.cidade+', '+config.estado+', Brazil')}`);}
async function salvarPrecoAdmin(){
  const prodId=document.getElementById('selProduto').value;
  const mercId=document.getElementById('selMercado').value;
  const preco=parseFloat(document.getElementById('inputPreco').value);
  if(!prodId){showToast('Selecione o produto!','âš ï¸');return;}
  if(!mercId){showToast('Selecione o mercado!','âš ï¸');return;}
  if(!preco||preco<=0){showToast('Informe o preÃ§o!','âš ï¸');return;}
  if(!apiToken){showToast('FaÃ§a login novamente para salvar!','âš ï¸');return;}
  
  const mercado = db.mercados.find(m=>String(m._id||m.id)===String(mercId));
  const produto = db.produtos.find(p=>String(p._id||p.id)===String(prodId));
  if(!mercado){showToast('Mercado nÃ£o encontrado!','âš ï¸');return;}
  if(!produto){showToast('Produto nÃ£o encontrado!','âš ï¸');return;}

  // Sempre usar o _id real do banco (ObjectId) para enviar Ã  API
  const prodIdReal = String(produto._id||produto.id);
  const mercIdReal = String(mercado._id||mercado.id);

  const entry={produtoId:prodIdReal,mercadoId:mercIdReal,preco,dataAtu:hoje(),fonte:'admin',autor:'Admin'};
  try {
    await apiReq('POST','/api/precos',{produtoId:prodIdReal,mercadoId:mercIdReal,preco,fonte:'admin'});
    const idx=db.precos.findIndex(p=>String(p.produtoId)===prodIdReal&&String(p.mercadoId)===mercIdReal);
    if(idx>=0)db.precos[idx]=entry;else db.precos.push(entry);
    showToast(`PreÃ§o salvo no banco! âœ…`,'âœ…');
  } catch(e){
    showToast('Erro: '+e.message,'âŒ');
  }
}
async function reenviarVerificacaoEmail(){
  if(!apiToken){showToast('FaÃ§a login primeiro!','âš ï¸');return;}
  try {
    await apiReq('POST','/api/auth/reenviar-verificacao',{});
    showToast('E-mail de verificaÃ§Ã£o reenviado! Verifique sua caixa de entrada e spam.','ğŸ“§');
  } catch(e){ showToast('Erro: '+e.message,'âŒ'); }
}

async function recuperarSenha(){
  const email = prompt('Informe seu e-mail cadastrado para recuperar a senha:');
  if(!email)return;
  try {
    await apiReq('POST','/api/auth/recuperar-senha',{email},false);
    showToast('InstruÃ§Ãµes enviadas para '+email+'. Verifique sua caixa de entrada!','ğŸ“§');
  } catch(e){ showToast('Verifique o e-mail informado','âš ï¸'); }
}

async function alterarMinhaSenha(){
  const atual = prompt('Senha atual:');
  if(!atual)return;
  const nova = prompt('Nova senha (mÃ­n. 6 caracteres):');
  if(!nova||nova.length<6){showToast('Nova senha muito curta!','âš ï¸');return;}
  const conf = prompt('Confirme a nova senha:');
  if(nova!==conf){showToast('Senhas nÃ£o coincidem!','âš ï¸');return;}
  try {
    await apiReq('POST','/api/auth/alterar-senha',{senhaAtual:atual,novaSenha:nova});
    showToast('Senha alterada com sucesso! âœ…','ğŸ”‘');
  } catch(e){ showToast('Erro: '+e.message,'âŒ'); }
}

function abrirPerfilCliente(){
  if(!clienteLogado){irPara('login');return;}
  const emailOk = clienteLogado.emailVerificado;
  const html = `
    <div style="padding:4px 0;">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;">
        <div style="width:56px;height:56px;border-radius:50%;background:var(--azul);display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;font-weight:700;flex-shrink:0;">
          ${clienteLogado.nome.charAt(0).toUpperCase()}
        </div>
        <div>
          <div style="font-family:var(--font-title);font-size:17px;font-weight:800;">${clienteLogado.nome}</div>
          <div style="font-size:12px;color:var(--muted);">@${clienteLogado.login}</div>
          <div style="font-size:11px;margin-top:2px;">
            ${emailOk ? '<span style="color:var(--verde);font-weight:600;">âœ… E-mail verificado</span>' : '<span style="color:#F59E0B;font-weight:600;">âš ï¸ E-mail nÃ£o verificado</span>'}
          </div>
        </div>
      </div>
      ${!emailOk ? `<div style="background:#FFFBEB;border:1px solid #FCD34D;border-radius:8px;padding:10px;font-size:12px;color:#92400E;margin-bottom:12px;">
        ğŸ“§ Verifique seu e-mail para ter acesso completo.
        <button onclick="reenviarVerificacaoEmail()" style="display:block;margin-top:6px;background:#F59E0B;border:none;border-radius:6px;color:#fff;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;">ğŸ“§ Reenviar e-mail de verificaÃ§Ã£o</button>
      </div>` : ''}
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button onclick="alterarMinhaSenha()" style="background:var(--card2);border:1.5px solid var(--borda);border-radius:10px;padding:13px;font-family:var(--font-title);font-weight:700;font-size:14px;color:var(--azul-esc);cursor:pointer;display:flex;align-items:center;gap:10px;">
          ğŸ”‘ Alterar Senha
        </button>
        <button onclick="recuperarSenha()" style="background:var(--card2);border:1.5px solid var(--borda);border-radius:10px;padding:13px;font-family:var(--font-title);font-weight:700;font-size:14px;color:var(--azul-esc);cursor:pointer;display:flex;align-items:center;gap:10px;">
          ğŸ“§ Recuperar Senha por E-mail
        </button>
        <button onclick="sairCliente()" style="background:#DC26261A;border:1.5px solid #DC262640;border-radius:10px;padding:13px;font-family:var(--font-title);font-weight:700;font-size:14px;color:#DC2626;cursor:pointer;display:flex;align-items:center;gap:10px;">
          ğŸšª Sair da Conta
        </button>
      </div>
    </div>
  `;
  // Mostrar em modal
  const modal = document.getElementById('modalReport');
  document.getElementById('modalPerfilContent').innerHTML = '<div style="font-family:var(--font-title);font-weight:800;font-size:18px;margin-bottom:16px;">ğŸ‘¤ Minha Conta</div>' + html;
  document.getElementById('modalPerfil').style.display='flex';
}

function sairCliente(){
  if(!confirm('Sair da conta?'))return;
  clienteLogado=null;
  limparToken();
  location.reload();
}

function isMongoId(id){ return /^[a-f\d]{24}$/i.test(String(id)); }
async function salvarProduto(){
  const nome=document.getElementById('inputProdNome').value.trim();
  const emoji=document.getElementById('inputProdEmoji').value.trim()||'ğŸ“¦';
  const cat=document.getElementById('inputProdCat').value.trim()||'Geral';
  if(!nome){showToast('Informe o nome do produto!','âš ï¸');return;}
  const existe=db.produtos.find(p=>p.nome.toLowerCase()===nome.toLowerCase());
  if(existe){showToast(`"${nome}" jÃ¡ existe no catÃ¡logo!`,'â„¹ï¸');return;}
  try {
    const novo = await apiReq('POST','/api/admin/produtos',{nome,emoji,categoria:cat});
    db.produtos.push({...novo, id: novo._id});
    showToast(`"${nome}" salvo no banco! âœ…`,'âœ…');
  } catch(e) {
    db.produtos.push({id:Date.now(),nome,emoji,categoria:cat});
    showToast(`"${nome}" adicionado localmente`,'âœ…');
  }
  renderAdminForm();
}
async function salvarMercado(){
  const nome=document.getElementById('inputMercNome').value.trim();
  const end=document.getElementById('inputMercEnd').value.trim();
  const bairro=document.getElementById('inputMercBairro').value.trim();
  const whats=document.getElementById('inputMercWhats')?.value.trim()||'';
  if(!nome){showToast('Informe o nome do mercado!','âš ï¸');return;}
  if(!end){showToast('EndereÃ§o Ã© obrigatÃ³rio!','âš ï¸');return;}
  if(!bairro){showToast('Bairro Ã© obrigatÃ³rio!','âš ï¸');return;}
  if(!whats){showToast('WhatsApp Ã© obrigatÃ³rio!','âš ï¸');return;}
  const lat=parseFloat(document.getElementById('inputMercLat')?.value)||null;
  const lng=parseFloat(document.getElementById('inputMercLng')?.value)||null;
  const dados={
    nome,
    icone:document.getElementById('inputMercEmoji').value.trim()||'ğŸª',
    endereco:end,
    bairro,
    whatsapp:whats,
    lat,lng,
    website:document.getElementById('inputMercWebsite').value.trim()||null,
    parceiro:document.getElementById('inputMercParceiro').checked,
    plano:document.getElementById('inputMercPlano').value||null,
    usuario:document.getElementById('inputMercUser').value.trim()||null,
    senha:document.getElementById('inputMercSenha').value.trim()||null
  };
  try {
    if(!apiToken){showToast('FaÃ§a login novamente â€” sessÃ£o expirada!','âš ï¸');return;}
    const novo = await apiReq('POST','/api/admin/mercados', dados);
    db.mercados.push({...novo, id: novo._id});
    showToast(`"${nome}" salvo no banco! âœ…`,'ğŸª');
    renderAdminForm();
  } catch(e) {
    showToast('Erro ao salvar mercado: '+e.message,'âŒ');
  }
}
function usarGPSMercado(){
  if(!navigator.geolocation){showToast('GPS nÃ£o disponÃ­vel','âš ï¸');return;}
  showToast('Obtendo localizaÃ§Ã£o...','ğŸ“¡');
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude.toFixed(6);
    const lng=pos.coords.longitude.toFixed(6);
    document.getElementById('inputMercLat').value=lat;
    document.getElementById('inputMercLng').value=lng;
    document.getElementById('mercLatLngInfo').innerHTML=`âœ… LocalizaÃ§Ã£o obtida: ${lat}, ${lng}`;
    document.getElementById('mercMapaPreview').style.display='block';
    document.getElementById('mercMapaPreview').innerHTML=`<iframe style="width:100%;height:200px;border:none;border-radius:10px;" src="https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed" loading="lazy"></iframe>`;
    showToast('LocalizaÃ§Ã£o obtida! âœ…','ğŸ“');
  },err=>{
    showToast('GPS negado â€” informe manualmente','âš ï¸');
    document.getElementById('mercLatLngInfo').innerHTML='âš ï¸ GPS negado. Digite as coordenadas ou use o endereÃ§o.';
  });
}
// ===== MAPA PICKER (Leaflet) =====
let leafletMap = null;
let leafletMarker = null;
let mapaPickerCallback = null; // funÃ§Ã£o chamada ao confirmar: fn(lat, lng)
let mapaPickerLatLng = null;

function abrirMapaPicker(lat, lng, callback){
  mapaPickerCallback = callback;
  mapaPickerLatLng = null;

  // Coordenadas iniciais: mercado se tem, senÃ£o centro de PiatÃ£
  const initLat = lat || -13.0774;
  const initLng = lng || -41.7082;

  document.getElementById('modalMapaPicker').classList.add('show');
  document.getElementById('mapaPickerCoords').innerHTML = 'ğŸ‘† Toque no mapa para selecionar a localizaÃ§Ã£o';
  document.getElementById('btnConfirmarLoc').disabled = true;
  document.getElementById('btnConfirmarLoc').style.opacity = '.5';

  // Inicializa mapa com pequeno delay para o modal aparecer
  setTimeout(()=>{
    if(leafletMap){ leafletMap.remove(); leafletMap=null; leafletMarker=null; }

    leafletMap = L.map('leafletMap').setView([initLat, initLng], lat ? 17 : 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap',
      maxZoom: 19
    }).addTo(leafletMap);

    // Se jÃ¡ tem coordenadas, mostra pino existente
    if(lat && lng){
      leafletMarker = L.marker([lat, lng], {draggable: true}).addTo(leafletMap);
      leafletMarker.bindPopup('ğŸ“ LocalizaÃ§Ã£o atual â€” arraste para ajustar').openPopup();
      mapaPickerLatLng = {lat, lng};
      atualizarInfoPicker(lat, lng);

      leafletMarker.on('dragend', e=>{
        const p = e.target.getLatLng();
        mapaPickerLatLng = {lat: p.lat, lng: p.lng};
        atualizarInfoPicker(p.lat, p.lng);
      });
    }

    // Clique no mapa coloca/move o pino
    leafletMap.on('click', e=>{
      const {lat, lng} = e.latlng;
      mapaPickerLatLng = {lat, lng};

      if(leafletMarker){
        leafletMarker.setLatLng([lat, lng]);
      } else {
        leafletMarker = L.marker([lat, lng], {draggable: true}).addTo(leafletMap);
        leafletMarker.on('dragend', ev=>{
          const p = ev.target.getLatLng();
          mapaPickerLatLng = {lat: p.lat, lng: p.lng};
          atualizarInfoPicker(p.lat, p.lng);
        });
      }
      atualizarInfoPicker(lat, lng);
    });

  }, 200);
}

function atualizarInfoPicker(lat, lng){
  document.getElementById('mapaPickerCoords').innerHTML =
    `<span style="color:var(--verde-dk);font-weight:700;">âœ… LocalizaÃ§Ã£o selecionada</span><br>
     <span style="font-size:12px;color:var(--muted);">Lat: ${lat.toFixed(6)} â€¢ Lng: ${lng.toFixed(6)}</span><br>
     <span style="font-size:11px;color:var(--azul);">Arraste o pino para ajustar com precisÃ£o</span>`;
  document.getElementById('btnConfirmarLoc').disabled = false;
  document.getElementById('btnConfirmarLoc').style.opacity = '1';
}

function confirmarLocalizacao(){
  if(!mapaPickerLatLng) return;
  const {lat, lng} = mapaPickerLatLng;
  fecharMapaPicker();
  if(mapaPickerCallback) mapaPickerCallback(lat, lng);
}

function fecharMapaPicker(){
  document.getElementById('modalMapaPicker').classList.remove('show');
  if(leafletMap){ leafletMap.remove(); leafletMap=null; leafletMarker=null; }
}

// Abre picker para NOVO mercado (form de adiÃ§Ã£o)
function abrirMapaMercado(){
  const latAtual = parseFloat(document.getElementById('inputMercLat')?.value)||null;
  const lngAtual = parseFloat(document.getElementById('inputMercLng')?.value)||null;
  abrirMapaPicker(latAtual, lngAtual, (lat, lng)=>{
    document.getElementById('inputMercLat').value = lat;
    document.getElementById('inputMercLng').value = lng;
    document.getElementById('mercLatLngInfo').innerHTML =
      `âœ… LocalizaÃ§Ã£o definida: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    document.getElementById('mercMapaPreview').style.display = 'block';
    document.getElementById('mercMapaPreview').innerHTML =
      `<iframe style="width:100%;height:180px;border:none;border-radius:10px;"
        src="https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed" loading="lazy"></iframe>`;
    showToast('LocalizaÃ§Ã£o marcada! âœ…','ğŸ“');
  });
}

// Abre picker para EDITAR localizaÃ§Ã£o de mercado jÃ¡ cadastrado
async function editarLocalizacaoMercado(mercadoId){
  const m = db.mercados.find(x=>String(x._id||x.id)===String(mercadoId));
  if(!m) return;
  abrirMapaPicker(m.lat||null, m.lng||null, async (lat, lng)=>{
    m.lat = lat;
    m.lng = lng;
    // Salva no banco
    try {
      await apiReq('PUT', `/api/admin/mercados/${mercadoId}`, {lat, lng});
      showToast(`ğŸ“ LocalizaÃ§Ã£o de "${m.nome}" salva!`,'âœ…');
    } catch(e){
      showToast(`ğŸ“ LocalizaÃ§Ã£o salva localmente (${e.message})`,'âš ï¸');
    }
    renderAdminForm();
  });
}
async function salvarPromocaoAdmin(){
  const prodId=document.getElementById('selPromoProd').value;
  const mercId=document.getElementById('selPromoMerc').value;
  const normal=parseFloat(document.getElementById('inputPromoNormal').value);
  const promo=parseFloat(document.getElementById('inputPromoPreco').value);
  const val=document.getElementById('inputPromoVal').value;
  const desc=document.getElementById('inputPromoDesc').value.trim();
  if(!prodId){showToast('Selecione o produto!','âš ï¸');return;}
  if(!mercId){showToast('Selecione o mercado!','âš ï¸');return;}
  if(isNaN(normal)||isNaN(promo)||!val){showToast('Preencha todos os campos!','âš ï¸');return;}
  if(promo>=normal){showToast('PreÃ§o promo deve ser menor!','âš ï¸');return;}

  // Resolve _id real do banco
  const prodObj = db.produtos.find(p=>String(p._id||p.id)===String(prodId));
  const mercObj = db.mercados.find(m=>String(m._id||m.id)===String(mercId));
  if(!prodObj){showToast('Produto nÃ£o encontrado!','âš ï¸');return;}
  if(!mercObj){showToast('Mercado nÃ£o encontrado!','âš ï¸');return;}
  const prodIdReal = String(prodObj._id||prodObj.id);
  const mercIdReal = String(mercObj._id||mercObj.id);

  const[y,m,d]=val.split('-');
  const dados={produtoId:prodIdReal,mercadoId:mercIdReal,precoNormal:normal,precoPromo:promo,validade:`${d}/${m}/${y}`,descricao:desc||'PromoÃ§Ã£o especial!',ativa:true};
  try {
    if(!apiToken){ showToast('FaÃ§a login novamente para salvar no banco!','âš ï¸'); return; }
    const nova = await apiReq('POST','/api/promocoes', dados);
    db.promocoes.push({...nova, id: nova._id, produtoId: nova.produtoId, mercadoId: nova.mercadoId});
    showToast('PromoÃ§Ã£o salva no banco! âœ…','ğŸ”¥');
    renderAdminForm();
    // Alertar clientes com notifWhats via WhatsApp
    const prod = db.produtos.find(p=>String(p._id||p.id)===String(prodId));
    const merc = db.mercados.find(m=>String(m._id||m.id)===String(mercId));
    const clientesNotif = db.clientes.filter(cl=>cl.notifWhats && cl.telefone && !cl.bloqueado);
    if(clientesNotif.length > 0 && prod && merc){
      const desconto = Math.round((1 - promo/normal)*100);
      const msgPromo = encodeURIComponent(
        `ğŸ”¥ *PROMOÃ‡ÃƒO PreÃ§oCerto!*\n\n` +
        `ğŸ“¦ *${prod.nome||'Produto'}*\n` +
        `ğŸª ${merc.nome}\n` +
        `ğŸ’° De R$ ${normal.toFixed(2)} por *R$ ${promo.toFixed(2)}* (-${desconto}%)\n` +
        `ğŸ“… VÃ¡lido atÃ©: ${dados.validade}\n` +
        (desc ? `ğŸ“ ${desc}\n` : '') +
        `\nAcesse: ${window.location.origin}`
      );
      if(confirm(`Enviar alerta desta promoÃ§Ã£o para ${clientesNotif.length} cliente(s) via WhatsApp?`)){
        // Abrir WhatsApp para cada cliente (atÃ© 5 por vez para nÃ£o spam)
        const limite = Math.min(clientesNotif.length, 5);
        for(let i=0; i<limite; i++){
          const tel = clientesNotif[i].telefone.replace(/\D/g,'');
          setTimeout(()=>window.open(`https://wa.me/55${tel}?text=${msgPromo}`,'_blank'), i*500);
        }
        if(clientesNotif.length > 5) showToast(`${clientesNotif.length-5} clientes restantes â€” repita manualmente`,'â„¹ï¸');
      }
    }
  } catch(e) {
    showToast('Erro ao salvar: '+e.message,'âŒ');
  }
}
async function removerPromoAdmin(id){
  if(!confirm('Remover esta promoÃ§Ã£o? Ela serÃ¡ encerrada no banco de dados.')) return;
  try {
    await apiReq('DELETE',`/api/promocoes/${id}`);
    db.promocoes=db.promocoes.filter(p=>String(p.id||p._id)!==String(id));
    showToast('PromoÃ§Ã£o encerrada no banco! âœ…','ğŸ—‘ï¸');
    renderAdminForm();
  } catch(e){
    showToast('Erro ao excluir: '+e.message,'âŒ');
  }
}
async function togglePromoAdmin(id){
  const p=db.promocoes.find(x=>String(x.id||x._id)===String(id));
  if(!p)return;
  try {
    await apiReq('PATCH',`/api/promocoes/${id}/toggle`,{});
    p.ativa=!p.ativa;
    showToast(p.ativa?'PromoÃ§Ã£o ativada âœ…':'PromoÃ§Ã£o pausada','ğŸ”¥');
    renderAdminForm();
  } catch(e){showToast('Erro: '+e.message,'âŒ');renderAdminForm();}
}
async function salvarPrecoPlanos(){
  config.precos_planos.basico=parseFloat(document.getElementById('inputPrecoBasico').value)||config.precos_planos.basico;
  config.precos_planos.pro=parseFloat(document.getElementById('inputPrecoPro').value)||config.precos_planos.pro;
  config.precos_planos.premium=parseFloat(document.getElementById('inputPrecoPremium').value)||config.precos_planos.premium;
  try {
    await apiReq('PUT','/api/config',{chave:'precos_planos',valor:config.precos_planos});
    showToast('PreÃ§os salvos no banco! âœ…','ğŸ’');
  } catch(e){ showToast('PreÃ§os atualizados localmente','ğŸ’'); }
  renderAdminForm();
}
async function aprovarSolic(id){
  if(!confirm('Aprovar esta solicitaÃ§Ã£o?\n\nIsso irÃ¡:\nâœ… Criar o mercado no banco\nâœ… Gerar login e senha\nâœ… Enviar credenciais por e-mail'))return;
  showToast('Aprovando e criando mercado...','â³');
  try {
    const res = await apiReq('PATCH',`/api/admin/solicitacoes/${id}/aprovar`,{});
    const cred = res.credenciais;
    // Recarregar dados do banco â€” garante lista atualizada
    await carregarDadosAdmin();
    await carregarDadosBackend();
    renderAdminForm();
    // Mostrar credenciais apÃ³s render
    showToast(`âœ… Mercado criado! Login: ${cred?.login}`, 'ğŸ‰');
    const alertMsg = `âœ… Mercado aprovado e criado com sucesso!\n\nCredenciais de acesso:\nğŸ‘¤ Login: ${cred?.login}\nğŸ”‘ Senha: ${cred?.senha}`;
    alert(alertMsg);
    // Abrir WhatsApp com credenciais se disponÃ­vel
    if(res.whatsappLink){
      if(confirm('Enviar credenciais via WhatsApp para o responsÃ¡vel?')){
        window.open(res.whatsappLink, '_blank');
      }
    }
  } catch(e){
    showToast('Erro ao aprovar: '+e.message,'âŒ');
  }
}
async function recusarSolic(id){
  const motivo=prompt('Motivo da recusa (opcional):','');
  if(motivo===null)return;
  try {
    await apiReq('PATCH',`/api/admin/solicitacoes/${id}/recusar`,{motivo});
    await carregarDadosAdmin();
    showToast('SolicitaÃ§Ã£o recusada','âœ…');
    renderAdminForm();
  } catch(e){ showToast('Erro: '+e.message,'âŒ'); }
}

// ===== IMPORTAR POR URL / FOTO MAPS =====
function setImportTab(tab){
  document.getElementById('importTabFoto').style.display = tab==='foto'?'block':'none';
  document.getElementById('importTabLink').style.display = tab==='link'?'block':'none';
  document.getElementById('btnTabFotoMaps').style.background = tab==='foto'?'var(--azul)':'transparent';
  document.getElementById('btnTabFotoMaps').style.color = tab==='foto'?'#fff':'var(--muted)';
  document.getElementById('btnTabFotoMaps').style.borderColor = tab==='foto'?'var(--azul)':'var(--borda)';
  document.getElementById('btnTabLinkMaps').style.background = tab==='link'?'var(--azul)':'transparent';
  document.getElementById('btnTabLinkMaps').style.color = tab==='link'?'#fff':'var(--muted)';
  document.getElementById('btnTabLinkMaps').style.borderColor = tab==='link'?'var(--azul)':'var(--borda)';
}

async function analisarFotoMaps(input){
  const file = input.files[0];
  if(!file) return;

  // Mostra preview da imagem
  const reader = new FileReader();
  reader.onload = async ev => {
    const dataUrl = ev.target.result;
    document.getElementById('fotoMapsImg').src = dataUrl;
    document.getElementById('fotoMapsPreview').style.display = 'block';

    const status = document.getElementById('urlImportStatus');
    const result = document.getElementById('urlImportResult');
    result.style.display = 'none';
    status.style.display = 'block';
    status.innerHTML = `<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--card2);border-radius:10px;">
      <div style="width:18px;height:18px;border:2px solid #4A9EFF40;border-top-color:var(--azul);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;"></div>
      <span style="font-size:13px;color:var(--muted);">ğŸ¤– IA lendo os dados do mercado na imagem...</span>
    </div>`;

    try {
      const base64Data = dataUrl.split(',')[1];
      const mediaType = dataUrl.split(';')[0].split(':')[1] || 'image/jpeg';

      const prompt = `VocÃª Ã© um assistente do app PreÃ§oCerto (cidade de PiatÃ£, BA).
Analise esta imagem â€” pode ser um print/screenshot do Google Maps ou foto do mercado.
Extraia todas as informaÃ§Ãµes visÃ­veis do estabelecimento comercial.

Responda APENAS em JSON vÃ¡lido, sem texto adicional:
{
  "encontrou": true/false,
  "nome": "nome completo do mercado/supermercado/estabelecimento",
  "icone": "emoji adequado: ğŸ›’ supermercado, ğŸª mercado pequeno, ğŸ¥© aÃ§ougue, ğŸ¥– padaria, ğŸ hortifruti, ğŸ¬ loja",
  "endereco": "endereÃ§o completo visÃ­vel, ou vazio",
  "bairro": "bairro se visÃ­vel, ou Centro",
  "whatsapp": "telefone/whatsapp se visÃ­vel, ou vazio",
  "confianca": "alta/media/baixa"
}

Se nÃ£o conseguir identificar um estabelecimento comercial, retorne {"encontrou": false}.`;

      const texto = await chamarIA(prompt, base64Data, mediaType);
      const clean = texto.replace(/```json|```/g,'').trim();
      const dados = JSON.parse(clean);

      if(dados.encontrou && dados.nome){
        status.innerHTML = `<div style="padding:9px 12px;background:#00C89612;border:1px solid #00C89630;border-radius:10px;font-size:12px;color:var(--verde);">âœ… IA identificou o mercado! Confirme e corrija se necessÃ¡rio.</div>`;

        document.getElementById('urlImportPreview').innerHTML=`
          <div style="width:50px;height:50px;background:var(--card);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;">${dados.icone||'ğŸª'}</div>
          <div>
            <div style="font-family:var(--font-title);font-weight:700;font-size:15px;">${dados.nome}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:3px;">ğŸ“ ${dados.endereco||'Confirme o endereÃ§o'}</div>
            ${dados.whatsapp?`<div style="font-size:12px;color:var(--verde);margin-top:2px;">ğŸ“± ${dados.whatsapp}</div>`:''}
          </div>`;

        document.getElementById('urlMercNome').value = dados.nome;
        document.getElementById('urlMercEnd').value = dados.endereco||'';
        document.getElementById('urlMercBairro').value = dados.bairro||'Centro';
        document.getElementById('urlMercWhats').value = dados.whatsapp||'';
        document.getElementById('urlMercIcone').value = dados.icone||'ğŸª';
        document.getElementById('urlMercWebsite').value = '';
        result.style.display = 'flex';
      } else {
        status.innerHTML = `<div style="padding:9px 12px;background:#FEF3C7;border:1px solid #FCD34D;border-radius:10px;font-size:12px;color:#92400E;">âš ï¸ NÃ£o foi possÃ­vel identificar. Tente uma foto mais nÃ­tida da tela do Maps ou preencha manualmente.</div>`;
      }
    } catch(e){
      status.innerHTML = `<div style="padding:9px 12px;background:#FEE2E2;border:1px solid #FCA5A5;border-radius:10px;font-size:12px;color:#DC2626;">âŒ Erro ao analisar imagem. Verifique se a IA estÃ¡ configurada (GEMINI_API_KEY) ou preencha manualmente.</div>`;
      console.error('Erro analisarFotoMaps:', e);
    }
  };
  reader.readAsDataURL(file);
}


function extrairDadosURL(url){
  const lower = url.toLowerCase();
  let nome='', icone='ğŸª', endereco='', bairro='Centro', website=url, whatsapp='';

  let slug = '';

  // Google Maps â€” extrai nome e endereÃ§o do link
  if(lower.includes('maps.app.goo.gl') || lower.includes('maps.google.com') || lower.includes('goo.gl/maps')){
    icone = 'ğŸ“';
    // Tentar extrair parÃ¢metros da URL
    try {
      const decoded = decodeURIComponent(url);
      // maps.google.com?q=Nome+do+Lugar,+EndereÃ§o
      const qMatch = decoded.match(/[?&]q=([^&]+)/);
      if(qMatch){
        const partes = qMatch[1].replace(/\+/g,' ').split(',');
        nome = partes[0]?.trim() || '';
        endereco = partes.slice(1).join(',').trim();
      }
      // place/ na URL tipo maps.app.goo.gl/XXXXX
      const placeMatch = decoded.match(/place\/([^/]+)\//);
      if(placeMatch && !nome){
        nome = placeMatch[1].replace(/\+/g,' ').replace(/%20/g,' ').trim();
      }
    } catch(e){}
    if(!nome) nome = 'Mercado (confirme o nome)';
    if(!endereco) endereco = config.cidade + ' â€” confirme o endereÃ§o';
    bairro = 'Centro';
  } else if(lower.includes('instagram.com/')){
    slug = url.split('instagram.com/')[1]?.split('/')[0]?.split('?')[0]||'';
    icone = 'ğŸ“±';
  } else if(lower.includes('facebook.com/')){
    slug = url.split('facebook.com/')[1]?.split('/')[0]?.split('?')[0]||'';
    icone = 'ğŸ“˜';
  } else if(lower.includes('ifood.com.br/')){
    slug = url.split('/').pop()?.split('?')[0]||'';
    icone = 'ğŸ›µ';
  } else {
    try{ const u=new URL(url); slug=u.hostname.replace('www.','').split('.')[0]; }catch(e){}
    icone = 'ğŸŒ';
  }

  // Humaniza slug â†’ nome
  if(slug && !nome){
    nome = slug
      .replace(/[._-]/g,' ')
      .replace(/mercado/gi,'Mercado')
      .replace(/super\s*/gi,'Super ')
      .replace(/\b\w/g, l=>l.toUpperCase())
      .trim();
    endereco = config.cidade + ' â€” verificar endereÃ§o';
  }

  if(!nome) nome = 'Novo Mercado';
  return { nome, icone, endereco, bairro, website, whatsapp };
}

async function salvarMercadoURL(){
  const nome=document.getElementById('urlMercNome').value.trim();
  if(!nome){showToast('Informe o nome!','âš ï¸');return;}
  if(!apiToken){showToast('FaÃ§a login novamente â€” sessÃ£o expirada!','âš ï¸');return;}
  const dados={
    nome,
    icone:document.getElementById('urlMercIcone').value.trim()||'ğŸª',
    endereco:document.getElementById('urlMercEnd').value.trim()||'',
    bairro:document.getElementById('urlMercBairro').value.trim()||'Centro',
    whatsapp:document.getElementById('urlMercWhats')?.value.trim()||'',
    website:document.getElementById('urlMercWebsite').value.trim()||null,
    parceiro:document.getElementById('urlMercParceiro').checked,
    plano:document.getElementById('urlMercPlano').value||null,
    usuario:document.getElementById('urlMercUser').value.trim()||null,
    senha:document.getElementById('urlMercSenha').value.trim()||null
  };
  try {
    const novo = await apiReq('POST','/api/admin/mercados', dados);
    db.mercados.push({...novo, id: novo._id});
    showToast(`"${nome}" importado e salvo no banco! âœ…`,'ğŸŒ');
    renderAdminForm();
  } catch(e) {
    showToast('Erro ao salvar: '+e.message,'âŒ');
  }
}

// ===== VISÃƒO GERAL HELPERS =====
function toggleMercadoDetalhe(id){
  const el=document.getElementById(id);
  if(!el)return;
  const aberto=el.style.display==='flex';
  el.style.display=aberto?'none':'flex';
}

async function editarPrecoRapido(prodId,mercId,precoAtual){
  const novo=prompt(`Novo preÃ§o (atual: R$ ${fmt(precoAtual)}):`,fmt(precoAtual).replace(',','.'));
  if(novo===null)return;
  const preco=parseFloat(novo);
  if(isNaN(preco)||preco<=0){showToast('PreÃ§o invÃ¡lido!','âš ï¸');return;}
  // Resolve IDs reais do banco
  const prodObj=db.produtos.find(p=>String(p._id||p.id)===String(prodId));
  const mercObj=db.mercados.find(m=>String(m._id||m.id)===String(mercId));
  const pId=String(prodObj?prodObj._id||prodObj.id:prodId);
  const mId=String(mercObj?mercObj._id||mercObj.id:mercId);
  const entry={produtoId:pId,mercadoId:mId,preco,dataAtu:hoje(),fonte:'admin',autor:'Admin'};
  try {
    await apiReq('POST','/api/precos',{produtoId:pId,mercadoId:mId,preco,fonte:'admin'});
    showToast('PreÃ§o salvo no banco! âœ…','âœ…');
  } catch(e){ showToast('Erro: '+e.message,'âŒ'); return; }
  const idx=db.precos.findIndex(p=>String(p.produtoId)===pId&&String(p.mercadoId)===mId);
  if(idx>=0)db.precos[idx]=entry;else db.precos.push(entry);
  renderAdminForm();
}

async function excluirMercado(id){
  const m=db.mercados.find(m=>String(m.id||m._id)===String(id));
  if(!m)return;
  if(!confirm(`Excluir "${m.nome}"?\n\nEsta aÃ§Ã£o removerÃ¡ o mercado do sistema. Os preÃ§os cadastrados serÃ£o mantidos no banco para histÃ³rico.`))return;
  if(!isMongoId(String(id))){
    // ID local â€” remover sÃ³ da memÃ³ria
    db.mercados=db.mercados.filter(m=>String(m.id||m._id)!==String(id));
    showToast(`"${m.nome}" removido`,'ğŸ—‘ï¸');
    renderAdminForm(); return;
  }
  try {
    await apiReq('DELETE',`/api/admin/mercados/${id}`);
    db.mercados=db.mercados.filter(m=>String(m.id||m._id)!==String(id));
    showToast(`"${m.nome}" removido do banco! âœ…`,'ğŸ—‘ï¸');
    renderAdminForm();
  } catch(e){ showToast('Erro ao remover: '+e.message,'âŒ'); }
}

// ===== PLANOS =====
function renderPlanos(){
  document.getElementById('planosContent').innerHTML=`
    <div style="background:linear-gradient(135deg,#1565C0,#0D47A1);border-radius:13px;padding:18px;text-align:center;">
      <div style="font-size:34px;margin-bottom:8px;">ğŸ¤</div>
      <div style="font-family:var(--font-title);font-weight:900;font-size:18px;color:#fff;margin-bottom:6px;">Cadastre seu Mercado</div>
      <div style="font-size:13px;color:rgba(255,255,255,.9);line-height:1.5;">Alcance mais clientes em PiatÃ£. PreÃ§os acessÃ­veis para qualquer porte de negÃ³cio.</div>
    </div>
    <div class="plano-card">
      <div style="font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:5px;font-weight:700;letter-spacing:.5px;">ğŸŒ± BÃ¡sico</div>
      <div class="plano-preco">R$ ${fmt(config.precos_planos.basico)}</div>
      <div class="plano-periodo">/mÃªs</div>
      <div class="plano-features" style="margin:14px 0;">
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>Cadastro do mercado no app</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>AtÃ© 50 produtos cadastrados</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>PresenÃ§a no app para clientes</span></div>
        <div class="plano-feature"><span style="color:#ccc;">âœ—</span><span style="color:var(--muted)">PromoÃ§Ãµes em destaque</span></div>
        <div class="plano-feature"><span style="color:#ccc;">âœ—</span><span style="color:var(--muted)">Portal de gestÃ£o</span></div>
      </div>
      <button class="plano-btn outline" onclick="solicitarPlano('BÃ¡sico')">ComeÃ§ar com BÃ¡sico</button>
    </div>
    <div class="plano-card destaque">
      <div style="font-size:11px;color:var(--verde);text-transform:uppercase;font-weight:800;margin-bottom:5px;letter-spacing:.5px;">â­ Mais popular</div>
      <div style="font-size:11px;font-weight:700;color:var(--texto);margin-bottom:4px;">ğŸš€ Pro</div>
      <div class="plano-preco">R$ ${fmt(config.precos_planos.pro)}</div>
      <div class="plano-periodo">/mÃªs</div>
      <div class="plano-features" style="margin:14px 0;">
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>Produtos ilimitados</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>PromoÃ§Ãµes em destaque na home</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>Portal exclusivo de gestÃ£o</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>Tudo do BÃ¡sico incluso</span></div>
      </div>
      <button class="plano-btn" onclick="solicitarPlano('Pro')">Quero o Pro</button>
    </div>
    <div class="plano-card" style="border-color:var(--amarelo);">
      <div style="font-size:11px;color:var(--amarelo);text-transform:uppercase;font-weight:800;margin-bottom:5px;letter-spacing:.5px;">ğŸ’ Premium</div>
      <div class="plano-preco" style="color:var(--amarelo);">R$ ${fmt(config.precos_planos.premium)}</div>
      <div class="plano-periodo">/mÃªs</div>
      <div class="plano-features" style="margin:14px 0;">
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>Destaque nas buscas (topo)</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>NotificaÃ§Ãµes push para usuÃ¡rios</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>RelatÃ³rio mensal de desempenho</span></div>
        <div class="plano-feature"><span style="color:var(--verde);">âœ“</span><span>Tudo do Pro incluso</span></div>
      </div>
      <button class="plano-btn outline" style="border-color:var(--amarelo);color:var(--amarelo);" onclick="solicitarPlano('Premium')">Quero o Premium</button>
    </div>
    <div style="background:var(--card2);border-radius:13px;padding:16px;text-align:center;">
      <div style="font-size:13px;color:var(--muted);margin-bottom:10px;">DÃºvidas? Fale diretamente com nossa equipe</div>
      <button onclick="window.open('https://wa.me/${config.whatsapp}?text=Ol%C3%A1!%20Quero%20cadastrar%20meu%20mercado%20no%20Pre%C3%A7oCerto!')" style="background:#25D366;color:#fff;border:none;border-radius:11px;padding:14px 24px;font-family:var(--font-title);font-weight:700;font-size:14px;cursor:pointer;width:100%;">ğŸ’¬ Falar no WhatsApp</button>
    </div>`;
}
function solicitarPlano(plano){
  planoSelecionado=plano;
  const chave=plano.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const preco=config.precos_planos[chave]||config.precos_planos[plano.toLowerCase()]||'--';
  document.getElementById('solicitarTitulo').textContent=`Plano ${plano}`;
  document.getElementById('planoSelecionadoNome').textContent=`${plano} â€” R$ ${fmt(preco)}/mÃªs`;
  irPara('solicitar');
}
async function enviarSolicitacao(){
  const nome=document.getElementById('solNome').value.trim();
  const resp=document.getElementById('solResp').value.trim();
  const whats=document.getElementById('solWhats').value.trim();
  const email=document.getElementById('solEmail')?.value.trim()||'';
  if(!nome||!resp||!whats){showToast('Preencha nome, responsÃ¡vel e WhatsApp!','âš ï¸');return;}
  const dados={mercado:nome,responsavel:resp,whatsapp:whats,email,endereco:document.getElementById('solEnd')?.value||'',bairro:document.getElementById('solBairro')?.value||'',plano:planoSelecionado};
  try {
    const nova = await apiReq('POST','/api/solicitacoes',dados,false);
    db.solicitacoes.push({...nova, id:nova._id});
    showToast('SolicitaÃ§Ã£o enviada! Nossa equipe entrarÃ¡ em contato. ğŸ¤','âœ…');
    irPara('planos');
  } catch(e){
    // Fallback local se API falhar
    db.solicitacoes.push({id:Date.now(),...dados,status:'Pendente',data:hoje()});
    showToast('SolicitaÃ§Ã£o registrada! Entraremos em contato. ğŸ¤','âœ…');
    irPara('planos');
  }
}

// ===== QR CODE LEITOR =====
function iniciarQR(videoId,canvasId,statusId){
  const video=document.getElementById(videoId);
  const status=document.getElementById(statusId);
  if(!video)return;
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    if(status)status.innerHTML='<span style="color:#DC2626;">âš ï¸ CÃ¢mera nÃ£o suportada neste navegador. Use Chrome ou Safari.</span>';
    return;
  }
  if(status)status.innerHTML=`<div style="display:flex;align-items:center;gap:8px;justify-content:center;">
    <div style="width:14px;height:14px;border:2px solid rgba(26,115,200,.3);border-top-color:var(--azul);border-radius:50%;animation:spin .8s linear infinite;"></div>
    <span>Solicitando acesso Ã  cÃ¢meraâ€¦</span>
  </div>`;
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}})
    .then(stream=>{
      qrStream=stream;
      video.srcObject=stream;
      video.play().catch(()=>{});
      if(status)status.innerHTML='<span style="color:var(--verde-dk);">ğŸ“· CÃ¢mera ativa â€” aponte para o QR Code da nota fiscal</span>';
    })
    .catch(err=>{
      console.warn('QR camera error:',err);
      if(err.name==='NotAllowedError'||err.name==='PermissionDeniedError'){
        if(status)status.innerHTML=`<div style="text-align:left;font-size:12px;color:#B45309;background:#FEF3C7;border-radius:8px;padding:10px;line-height:1.6;">
          ğŸ”’ <strong>PermissÃ£o necessÃ¡ria</strong><br>
          Para usar o leitor de QR Code, vocÃª precisa permitir o acesso Ã  cÃ¢mera:<br>
          â€¢ No iOS: Ajustes â†’ Safari â†’ CÃ¢mera â†’ Permitir<br>
          â€¢ No Android: toque no Ã­cone ğŸ”’ na barra de endereÃ§o â†’ cÃ¢mera â†’ Permitir<br>
          <span style="color:var(--muted);">Use a aba Foto/Manual para contribuir sem cÃ¢mera.</span>
        </div>`;
      } else {
        if(status)status.innerHTML=`<span style="color:#DC2626;">âš ï¸ CÃ¢mera indisponÃ­vel: ${err.message||err.name}. Use a aba Foto/Manual abaixo.</span>`;
      }
    });
}
function pararQR(){
  if(qrStream){qrStream.getTracks().forEach(t=>t.stop());qrStream=null;}
}
function entradaManualQR(){
  // Usar mercado real do banco â€” pede seleÃ§Ã£o
  if(!db.mercados.length){showToast('Nenhum mercado cadastrado ainda','âš ï¸');return;}
  const mercadoAleatorio=db.mercados[0]; // usa primeiro mercado real
  // Deixar lista vazia para usuÃ¡rio preencher manualmente
  qrContribProdutos=[];

  const resInline=document.getElementById('qrResultadoInline');
  const infoInline=document.getElementById('qrInfoNotaInline');
  const listaInline=document.getElementById('qrListaInline');
  const statusEl=document.getElementById('qrStatusInline');

  if(statusEl) statusEl.innerHTML=`<span style="color:var(--azul);">ğŸ“ Adicione os produtos manualmente abaixo.</span>`;

  if(resInline){
    resInline.style.display='flex';
    if(infoInline) infoInline.innerHTML=`ğŸª ${mercadoAleatorio.icone} <strong>${mercadoAleatorio.nome}</strong> &nbsp;â€¢&nbsp; ${hoje()} &nbsp;â€¢&nbsp; Use a aba "Foto/Manual" para adicionar itens`;
    if(listaInline) listaInline.innerHTML=`<div style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">ğŸ“· QR de nota fiscal requer cÃ¢mera.<br>Use a aba <strong>Foto/Manual</strong> para digitar os preÃ§os.</div>`;

    showToast('Use a aba Foto/Manual para adicionar produtos.','ğŸ“‹');
  }
}
function enviarContribQR(){
  if(!qrContribProdutos.length){showToast('Leia uma nota fiscal primeiro!','âš ï¸');return;}
  const invalidos=qrContribProdutos.filter(p=>!p.preco||p.preco<=0);
  if(invalidos.length){showToast(`${invalidos.length} produto(s) com preÃ§o invÃ¡lido!`,'âš ï¸');return;}
  const autor=document.getElementById('qrAutorInput')?.value.trim()||'Cliente via QR';
  let enviados=0;
  qrContribProdutos.forEach(p=>{
    if(p.produtoId&&p.mercadoId&&p.preco>0){
      db.contribuicoes.push({
        id:Date.now()+Math.random(),
        tipo:'qr',
        produtoId:p.produtoId,
        mercadoId:p.mercadoId,
        preco:p.preco,
        autor,
        data:hoje(),
        status:'pendente',
        obs:`Via nota fiscal QR â€” ${p.nome}`
      });
      enviados++;
    }
  });
  if(enviados>0){
    showToast(`âœ… ${enviados} preÃ§o(s) enviados com sucesso! Aguarde aprovaÃ§Ã£o do admin.`,'ğŸ“±');
    qrContribProdutos=[];
    pararQR();
    setTimeout(()=>{contribTabAtiva='foto';renderContrib();},1500);
  }else{
    showToast('Nenhum preÃ§o vÃ¡lido para enviar.','âš ï¸');
  }
}

// ===== BUSCA AUTOMÃTICA =====
function executarBuscaAuto(){
  const tipo=document.getElementById('buscaAutoTipo')?.value||'mercados';
  // Suporta modal do cliente (sem sufixo) e painel admin (com sufixo Admin)
  const statusEl=document.getElementById('buscaAutoStatusAdmin')||document.getElementById('buscaAutoStatus');
  const resultEl=document.getElementById('buscaAutoResultadosAdmin')||document.getElementById('buscaAutoResultados');

  if(tipo==='mercados'){
    // Usar dados REAIS do banco
    const mercados = db.mercados.filter(m=>m.ativo!==false);
    if(statusEl){
      statusEl.style.display='block';
      statusEl.innerHTML=`<div style="padding:9px 12px;background:#00C89612;border:1px solid #00C89630;border-radius:10px;font-size:12px;color:var(--verde);">âœ… ${mercados.length} mercados cadastrados no sistema</div>`;
    }
    if(!resultEl) return;
    if(mercados.length===0){
      resultEl.innerHTML='<div style="text-align:center;color:var(--muted);padding:30px;font-size:13px;">Nenhum mercado cadastrado</div>';
      return;
    }
    resultEl.innerHTML=mercados.map(m=>{
      const nPrecos = db.precos.filter(p=>String(p.mercadoId||p.mercado)===String(m._id||m.id)).length;
      const nPromos = db.promocoes.filter(p=>String(p.mercadoId||p.mercado)===String(m._id||m.id)&&p.ativa).length;
      const temCoord = m.lat&&m.lng;
      return `<div style="background:var(--card2);border-radius:13px;padding:13px;border:1.5px solid var(--borda);">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
          <div style="font-size:26px;">${m.icone||'ğŸª'}</div>
          <div style="flex:1;">
            <div style="font-weight:700;font-size:14px;">${m.nome}</div>
            <div style="font-size:11px;color:var(--muted);">ğŸ“ ${m.endereco||'â€”'} â€¢ ${m.bairro||''}</div>
            <div style="font-size:11px;color:var(--muted);">ğŸ“± ${m.whatsapp||'Sem WhatsApp'}</div>
          </div>
          <div style="text-align:right;">
            ${m.parceiro?'<span style="font-size:10px;background:#DCFCE7;color:var(--verde-dk);padding:2px 7px;border-radius:100px;font-weight:700;">âœ… Parceiro</span>':''}
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
          <span style="font-size:11px;background:#DBEAFE;color:var(--azul);padding:3px 8px;border-radius:100px;font-weight:700;">${nPrecos} preÃ§os</span>
          ${nPromos>0?`<span style="font-size:11px;background:#FEF9C3;color:#92400E;padding:3px 8px;border-radius:100px;font-weight:700;">ğŸ”¥ ${nPromos} promoÃ§Ãµes</span>`:''}
          ${temCoord?'<span style="font-size:11px;background:#DCFCE7;color:var(--verde-dk);padding:3px 8px;border-radius:100px;font-weight:700;">ğŸ“Œ GPS ok</span>':'<span style="font-size:11px;background:#FEE2E2;color:#DC2626;padding:3px 8px;border-radius:100px;font-weight:700;">âš ï¸ Sem GPS</span>'}
        </div>
        ${!temCoord?`<button data-mid="${m._id||m.id}" onclick="editarLocalizacaoMercado(this.dataset.mid)" class="btn-sm btn-azul" style="width:100%;">ğŸ“ Marcar localizaÃ§Ã£o no mapa</button>`:`<button data-mid="${m._id||m.id}" onclick="editarLocalizacaoMercado(this.dataset.mid)" class="btn-sm" style="width:100%;background:var(--card2);border:1px solid var(--borda);color:var(--muted);">âœï¸ Ajustar localizaÃ§Ã£o</button>`}
      </div>`;
    }).join('');

  } else if(tipo==='precos'){
    // EstatÃ­sticas reais de preÃ§os
    const totalPrecos = db.precos.length;
    const semPreco = db.mercados.filter(m=>{
      const n = db.precos.filter(p=>String(p.mercadoId)===String(m._id||m.id)).length;
      return n===0;
    });
    if(statusEl){
      statusEl.style.display='block';
      statusEl.innerHTML=`<div style="padding:9px 12px;background:#00C89612;border:1px solid #00C89630;border-radius:10px;font-size:12px;color:var(--verde);">âœ… ${totalPrecos} preÃ§os cadastrados â€¢ ${semPreco.length} mercado(s) sem preÃ§os</div>`;
    }
    if(!resultEl) return;
    // Produtos com mais variaÃ§Ã£o de preÃ§o
    const porProduto = {};
    db.precos.forEach(p=>{
      const prod = db.produtos.find(x=>String(x._id||x.id)===String(p.produtoId));
      if(!prod) return;
      if(!porProduto[prod.nome]) porProduto[prod.nome]={precos:[],emoji:prod.emoji||'ğŸ“¦'};
      porProduto[prod.nome].precos.push(p.preco);
    });
    const lista = Object.entries(porProduto).sort((a,b)=>b[1].precos.length-a[1].precos.length).slice(0,15);
    resultEl.innerHTML = lista.length===0
      ? '<div style="text-align:center;color:var(--muted);padding:30px;font-size:13px;">Nenhum preÃ§o cadastrado</div>'
      : lista.map(([nome,d])=>{
          const min=Math.min(...d.precos), max=Math.max(...d.precos);
          const variacao=max-min;
          return `<div style="background:var(--card2);border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;border:1px solid var(--borda);">
            <span style="font-size:22px;">${d.emoji}</span>
            <div style="flex:1;">
              <div style="font-size:13px;font-weight:700;">${nome}</div>
              <div style="font-size:12px;color:var(--verde);">R$ ${min.toFixed(2)} â€“ R$ ${max.toFixed(2)}</div>
              <div style="font-size:11px;color:var(--muted);">${d.precos.length} registro(s) â€¢ variaÃ§Ã£o R$ ${variacao.toFixed(2)}</div>
            </div>
            ${variacao>5?'<span style="font-size:18px;" title="Alta variaÃ§Ã£o">âš ï¸</span>':''}
          </div>`;
        }).join('');
  }
}

async function buscarCoordsMercado(mercadoId){
  const m = db.mercados.find(x=>String(x._id||x.id)===String(mercadoId));
  if(!m) return;
  const query = encodeURIComponent(`${m.nome} ${m.endereco||''} ${m.bairro||''} PiatÃ£ Bahia`);
  window.open(`https://www.google.com/maps/search/${query}`,'_blank');
  showToast('Busque no Maps e copie as coordenadas para o cadastro do mercado','â„¹ï¸');
}
async function importarMercadoBusca(nome,endereco,bairro,icone){
  if(confirm(`Adicionar "${nome}" ao app?`)){
    const dados={nome,icone,endereco,bairro,website:null,parceiro:false,plano:null,usuario:null,senha:null};
    try {
      const novo = await apiReq('POST','/api/admin/mercados', dados);
      db.mercados.push({...novo, id: novo._id});
      showToast(`"${nome}" salvo no banco! âœ…`,'ğŸª');
    } catch(e) {
      db.mercados.push({id:Date.now(),...dados});
      showToast(`"${nome}" adicionado localmente`,'ğŸª');
    }
    renderAdminForm();
  }
}
function abrirGoogleMapsBusca(){
  window.open(`https://www.google.com/maps/search/supermercado+mercado/${encodeURIComponent(config.cidade+', '+config.estado)}`,'_blank');
}

// ===== GERENCIAR ADMINS =====
async function criarAdmin(){
  const nome=document.getElementById('newAdminNome').value.trim();
  const user=document.getElementById('newAdminUser').value.trim();
  const senha=document.getElementById('newAdminSenha').value;
  const nivel=document.getElementById('newAdminNivel').value;
  if(!nome||!user||!senha){showToast('Preencha nome, usuÃ¡rio e senha!','âš ï¸');return;}
  if(senha.length<4){showToast('Senha deve ter mÃ­nimo 4 caracteres!','âš ï¸');return;}
  try {
    // Salva no backend via config especial
    await apiReq('POST','/api/admin/admins',{nome,usuario:user,senha,nivel});
    showToast(`Admin "${nome}" criado e salvo! âœ…`,'ğŸ‘‘');
  } catch(e){
    if(db.admins.find(a=>a.usuario===user)){showToast('UsuÃ¡rio jÃ¡ existe!','âš ï¸');return;}
    db.admins.push({id:Date.now(),usuario:user,senha,nome,nivel});
    showToast(`Admin "${nome}" criado!`,'ğŸ‘‘');
  }
  renderAdminForm();
}
async function excluirAdmin(id){
  const a=db.admins.find(a=>a.id===id||a._id===id);
  if(!a)return;
  if(confirm(`Excluir admin "${a.nome}"?`)){
    try { await apiReq('DELETE',`/api/admin/admins/${id}`); } catch(e){}
    db.admins=db.admins.filter(x=>x.id!==id&&x._id!==id);
    showToast('Admin removido','ğŸ—‘ï¸');renderAdminForm();
  }
}

function registrarOcorrencia(mensagem){
  const cliente = clienteLogado;
  const oc = {
    id: Date.now(),
    timestamp: Date.now(),
    cliente: cliente?.nome || 'Visitante',
    clienteLogin: cliente?.login || null,
    whatsapp: cliente?.telefone || null,
    mensagem,
    historico: null,
    status: 'aberto',
    data: hoje(),
    hora: new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})
  };
  // Tenta adicionar histÃ³rico do chat
  const sessaoId = cliente?.login || 'visitante';
  const sessao = db.suporteChats.find(s=>s.clienteId===sessaoId);
  if(sessao && sessao.mensagens.length > 0){
    oc.historico = sessao.mensagens.slice(-5).map(m=>`[${m.tipo==='user'?'Cliente':'Bot'}] ${m.texto}`).join(' | ');
  }
  db.ocorrencias.push(oc);
}
async function completarCatalogo(){
  // Feedback visual imediato no prÃ³prio botÃ£o
  const btn = event?.target?.closest('button') || document.querySelector('[onclick*="completarCatalogo"]');
  const textoOriginal = btn ? btn.textContent : '';
  if(btn){ btn.disabled = true; btn.textContent = 'â³ Aguarde...'; btn.style.opacity = '0.7'; }

  try {
    // Mostra alert de confirmaÃ§Ã£o + progresso
    const ok = confirm(
      'ğŸ“¦ Completar CatÃ¡logo\n\n' +
      `Atualmente hÃ¡ ${db.produtos.length} produtos no banco.\n` +
      'SerÃ£o adicionados todos os produtos faltantes.\n\n' +
      'Continuar?'
    );
    if(!ok){
      if(btn){ btn.disabled=false; btn.textContent=textoOriginal; btn.style.opacity=''; }
      return;
    }

    if(btn){ btn.textContent = 'ğŸ“¡ Enviando...'; }

    const r = await apiReq('POST', '/api/admin/seed-produtos', { force: true });

    alert(`âœ… ConcluÃ­do!\n\n${r.mensagem}\nTotal no banco: ${r.total} produtos`);

    await carregarDadosBackend();
    renderAdminForm();

  } catch(e) {
    console.error('completarCatalogo erro:', e);
    const msg = e.message?.includes('401') || e.message?.includes('SessÃ£o')
      ? 'SessÃ£o expirada â€” faÃ§a logout e login novamente no admin.'
      : (e.message || 'Erro desconhecido');
    alert('âŒ Erro ao completar catÃ¡logo:\n\n' + msg);
    if(btn){ btn.disabled=false; btn.textContent=textoOriginal; btn.style.opacity=''; }
  }
}
async function resolverOcorrencia(id){
  const o = db.ocorrencias.find(x=>String(x.id||x._id)===String(id));
  if(!o) return;
  try {
    await apiReq('PATCH',`/api/ocorrencias/${id}/resolver`,{});
    o.status='resolvido';
    showToast('OcorrÃªncia resolvida! âœ…','âœ…');
    renderAdminForm();
  } catch(e){ showToast('Erro: '+e.message,'âŒ'); }
}
async function excluirOcorrencia(id){
  if(!confirm('Excluir ocorrÃªncia?')) return;
  try {
    await apiReq('DELETE',`/api/ocorrencias/${id}`);
    db.ocorrencias = db.ocorrencias.filter(x=>String(x.id||x._id)!==String(id));
    showToast('OcorrÃªncia removida','ğŸ—‘ï¸'); renderAdminForm();
  } catch(e){ showToast('Erro: '+e.message,'âŒ'); }
}

// ===== PWA =====
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();pwaInstallPrompt=e;
  const banner=document.getElementById('pwaInstallBanner');
  if(banner){banner.style.display='flex';setTimeout(()=>{banner.style.display='flex';},1000);}
});
function instalarPWA(){
  if(pwaInstallPrompt){pwaInstallPrompt.prompt();pwaInstallPrompt.userChoice.then(()=>{pwaInstallPrompt=null;document.getElementById('pwaInstallBanner').style.display='none';});}
  else{showToast('Para instalar: use o menu do browser â†’ "Adicionar Ã  tela inicial"','ğŸ“±');}
}

// ===== SERVICE WORKER (PWA offline) =====
if('serviceWorker' in navigator){
  const sw=`
    const CACHE='precoCerto-v1';
    const FILES=['.'];
    self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(FILES))));
    self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match('.')))));
  `;
  const blob=new Blob([sw],{type:'application/javascript'});
  const url=URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}

// ===== UTILS =====
function fmt(n){return n.toFixed(2).replace('.',',');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” Carrega dados do backend ao abrir o app
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function inicializarApp(){
  // Mostra indicador de carregamento
  const homeContent = document.getElementById('homeContent');
  if(homeContent) homeContent.style.opacity='0.5';

  // Tenta carregar dados do backend em tempo real
  const online = await carregarDadosBackend();

  if(homeContent) homeContent.style.opacity='1';

  if(online){
    console.log('ğŸŒ App online â€” dados sincronizados com o banco');
  } else {
    console.log('ğŸ“± App offline â€” usando dados locais');
    // Mostra aviso de offline discreto apÃ³s 3s
    setTimeout(()=>{
      if(modoOffline) showToast('Modo offline â€” dados locais','ğŸ“±');
    }, 3000);
  }

  // Verifica se tem sessÃ£o salva e restaura
  if(apiToken){
    try {
      const payload = JSON.parse(atob(apiToken.split('.')[1]));
      if(payload.exp * 1000 > Date.now()){
        if(payload.tipo === 'admin'){
          // Restaurar sessÃ£o admin â€” token vÃ¡lido no localStorage
          adminLogado = true;
          adminUser = { usuario: payload.usuario, nivel: payload.nivel || 'admin', nome: payload.usuario };
          // Carregar dados privados do admin em background
          carregarDadosAdmin().catch(e=>console.warn('Dados admin:', e.message));
        } else if(payload.tipo === 'cliente'){
          // Restaurar sessÃ£o cliente
          try {
            const info = await apiReq('GET', '/api/auth/me', null, true);
            clienteLogado = { login: info.login, nome: info.nome, bloqueado: info.bloqueado, emailVerificado: info.emailVerificado, bairro: info.bairro, telefone: info.telefone };
            perfilNome = info.nome;
          } catch(e2){
            // Fallback bÃ¡sico se endpoint nÃ£o existir ainda
            clienteLogado = { login: payload.login, nome: payload.login, bloqueado: false, emailVerificado: false };
            perfilNome = payload.login;
          }
          sincronizarAvatar();
        }
      } else {
        limparToken(); // Token expirado
      }
    } catch(e){ limparToken(); }
  }

  renderHome();
}

// Inicia o app
inicializarApp();
</script>

<!-- MODAL PERFIL (admin + cliente) -->
<div class="modal-overlay" id="modalPerfil" onclick="if(event.target===this)this.style.display='none'">
  <div class="modal-box" style="max-height:85vh;overflow-y:auto;">
    <button class="modal-close" onclick="document.getElementById('modalPerfil').style.display='none'">âœ• fechar</button>
    <div id="modalPerfilContent"></div>
  </div>
</div>
</body>
</html>
